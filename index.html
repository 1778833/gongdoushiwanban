<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>å®«æ–—æ¨¡æ‹Ÿå™¨</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="å®«æ–—æ¨¡æ‹Ÿå™¨">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#8e2e2e">
    <link rel="manifest" href='data:application/manifest+json,{"name":"å®«æ–—æ¨¡æ‹Ÿå™¨","short_name":"å®«æ–—æ¨¡æ‹Ÿå™¨","start_url":".","display":"standalone","background_color":"#f4f0e6","theme_color":"#8e2e2e"}'>
    <style>
        :root {
            --bg-color: #f4f0e6; /* å®£çº¸è‰² */
            --primary-color: #8e2e2e; /* æœ±çº¢ */
            --secondary-color: #2c3e50; /* å¢¨è‰² */
            --accent-color: #d4af37; /* é‡‘è‰² */
            --text-color: #333;
            --border-style: 2px solid var(--secondary-color);
            --font-main: "Kaiti SC", "STKaiti", "KaiTi", serif;
        }

        * {
            box-sizing: border-box;
            user-select: none;
        }

        body {
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: var(--font-main);
            height: 100vh; /* Fallback */
            height: 100dvh; /* åŠ¨æ€è§†å£é«˜åº¦ï¼Œè§£å†³ç§»åŠ¨ç«¯åœ°å€æ é®æŒ¡é—®é¢˜ */
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background-image: url('data:image/svg+xml;utf8,<svg width="100" height="100" transform="scale(0.5)" opacity="0.1" xmlns="http://www.w3.org/2000/svg"><path d="M10 10 L90 10 L90 90 L10 90 Z" fill="none" stroke="%23000" stroke-width="2"/></svg>');
        }

        /* é€šç”¨ç»„ä»¶ */
        .btn {
            background-color: var(--primary-color);
            color: #fff;
            border: none;
            padding: 10px 20px;
            font-family: var(--font-main);
            font-size: 1.1rem;
            cursor: pointer;
            border-radius: 4px;
            border: 1px solid var(--secondary-color);
            transition: all 0.3s;
            box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
        }

        .btn:hover {
            background-color: #a63a3a;
            transform: translateY(-1px);
        }

        .btn:active {
            transform: translateY(1px);
        }

        .btn-secondary {
            background-color: var(--secondary-color);
        }

        .btn-small {
            padding: 5px 10px;
            font-size: 0.9rem;
        }

        .panel {
            background: rgba(255, 255, 255, 0.8);
            border: 2px solid var(--secondary-color);
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            position: relative;
        }

        .panel::before {
            content: '';
            position: absolute;
            top: 4px; left: 4px; right: 4px; bottom: 4px;
            border: 1px solid var(--primary-color);
            border-radius: 4px;
            pointer-events: none;
        }

        input, select {
            padding: 8px;
            border: 1px solid var(--secondary-color);
            background: transparent;
            font-family: var(--font-main);
            font-size: 1rem;
            width: 100%;
            margin-bottom: 10px;
            border-radius: 4px;
        }

        h1, h2, h3 {
            text-align: center;
            color: var(--primary-color);
            margin-top: 0;
            text-shadow: 1px 1px 0 rgba(0,0,0,0.1);
        }

        /* å¸ƒå±€ */
        #main-container {
            flex: 1;
            position: relative;
            overflow-y: auto;
            padding: 20px;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
        }

        .page {
            display: none;
            height: 100%;
            flex-direction: column;
            animation: fadeIn 0.5s;
        }

        .page.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* åº•éƒ¨å¯¼èˆª */
        #nav-bar {
            height: 60px;
            background-color: var(--secondary-color);
            display: flex;
            justify-content: space-around;
            align-items: center;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
            z-index: 100;
            padding-bottom: env(safe-area-inset-bottom); /* é€‚é…å…¨é¢å±åº•éƒ¨ */
            box-sizing: content-box; /* ç¡®ä¿paddingä¸å½±å“height */
        }

        .nav-item {
            color: #ccc;
            text-align: center;
            cursor: pointer;
            flex: 1;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            transition: all 0.3s;
            font-size: 0.9rem;
        }

        .nav-item:hover {
            background-color: rgba(255,255,255,0.1);
            color: #fff;
        }

        .nav-item.active {
            color: var(--accent-color);
            background-color: rgba(0,0,0,0.2);
            font-weight: bold;
            font-size: 1rem;
        }

        /* é¡µé¢ç‰¹å®šæ ·å¼ */
        /* 1. èº«ä»½è‡ªå®šä¹‰ */
        .avatar-container {
            width: 150px;
            height: 150px;
            margin: 0 auto 10px;
            border: 3px solid var(--primary-color);
            border-radius: 50%;
            overflow: hidden;
            background: #fff;
            position: relative;
            box-shadow: 0 0 15px rgba(142, 46, 46, 0.3);
        }
        
        #avatar-canvas {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .avatar-controls {
            text-align: center;
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            gap: 10px;
        }

        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--secondary-color);
        }

        .input-group {
            display: flex;
            gap: 10px;
        }

        .generated-info {
            padding: 10px;
            background: rgba(255,255,255,0.5);
            border: 1px dashed var(--secondary-color);
            border-radius: 4px;
            margin-bottom: 10px;
            font-size: 0.95rem;
            line-height: 1.5;
        }

        /* 2. å¤§åœ°å›¾ */
        .map-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            padding: 10px;
        }

        .location-card {
            background: rgba(255,255,255,0.6);
            border: 1px solid var(--secondary-color);
            padding: 20px;
            text-align: center;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .location-card:hover {
            background: #fff;
            transform: scale(1.02);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-color: var(--primary-color);
        }
        
        .location-name {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--primary-color);
            z-index: 2;
            position: relative;
        }

        /* 3. ä¸ªäººæ¡£æ¡ˆ */
        .profile-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--secondary-color);
            padding-bottom: 20px;
        }

        .profile-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            border: 2px solid var(--primary-color);
            margin-right: 20px;
            background: #fff;
            object-fit: cover;
        }

        .profile-info h2 {
            text-align: left;
            margin-bottom: 5px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .stat-item {
            background: rgba(255,255,255,0.5);
            padding: 10px;
            border-radius: 4px;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        
        .stat-item span:first-child {
            font-weight: bold;
            color: var(--secondary-color);
            margin-bottom: 5px;
        }
        
        .stat-desc {
            font-size: 0.8rem;
            color: #666;
            margin-top: 2px;
        }

        .rank-info {
            margin-top: 20px;
            padding: 10px;
            background: rgba(142, 46, 46, 0.1);
            border: 1px solid var(--primary-color);
            border-radius: 4px;
        }

        /* 5. è®¾ç½® */
        .save-slots {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .slot-btn {
            padding: 15px;
            border: 1px dashed var(--secondary-color);
            background: rgba(255,255,255,0.5);
            cursor: pointer;
            text-align: center;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .slot-btn:hover {
            background: rgba(255,255,255,0.8);
            border-style: solid;
            border-color: var(--primary-color);
        }

        .slot-btn.used {
            background: rgba(142, 46, 46, 0.1);
            border-style: solid;
        }
        
        .slot-info {
            font-size: 0.8rem;
            color: #666;
            margin-top: 5px;
        }

        .settings-section {
            margin-bottom: 30px;
            border-bottom: 1px dashed #ccc;
            padding-bottom: 20px;
        }

        /* æç¤ºæ¡† */
        #toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--secondary-color);
            color: #fff;
            padding: 10px 20px;
            border-radius: 20px;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            z-index: 3000;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        /* åœ£æ—¨æ¨¡æ€æ¡† */
        .edict-modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2500;
            animation: fadeIn 0.5s;
        }

        .edict-content {
            width: 600px; /* å¢åŠ å®½åº¦ä»¥é€‚åº”æ¨ªå‘å±•å¼€ */
            height: 400px;
            background: #fff8e1; /* åœ£æ—¨é»„ */
            background-image: url('https://www.transparenttextures.com/patterns/paper-fibers.png');
            border: 10px solid #d4af37; /* é‡‘è¾¹ */
            border-radius: 10px;
            position: relative;
            box-shadow: 0 0 50px rgba(212, 175, 55, 0.5);
            display: flex;
            flex-direction: row-reverse; /* ä»å³å‘å·¦æ’åˆ— */
            padding: 40px;
            overflow: hidden;
        }

        .edict-text-container {
            flex: 1;
            writing-mode: vertical-rl; /* ç«–æ’æ–‡å­— */
            text-orientation: upright;
            font-family: "Kaiti SC", "STKaiti", "KaiTi", serif;
            font-size: 1.4rem;
            line-height: 2;
            letter-spacing: 0.2em;
            color: #333;
            height: 100%;
            overflow-x: auto; /* æ¨ªå‘æ»šåŠ¨ */
        }

        .edict-seal {
            position: absolute;
            bottom: 30px;
            left: 30px;
            width: 100px;
            height: 100px;
            border: 3px solid #d81b60;
            color: #d81b60;
            font-size: 2rem;
            font-weight: bold;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 10px;
            transform: rotate(-15deg);
            opacity: 0.8;
            pointer-events: none;
            writing-mode: horizontal-tb; /* å°ç« æ¨ªæ’ */
        }

        .edict-dragon {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background-image: url('data:image/svg+xml;utf8,<svg width="100" height="100" transform="scale(2)" opacity="0.05" xmlns="http://www.w3.org/2000/svg"><path d="M10 10 Q 50 50 90 10 T 90 90 T 10 90" fill="none" stroke="%23000" stroke-width="2"/></svg>');
            pointer-events: none;
        }

        /* ç©æ³•å®«æ ¼ */
        .gameplay-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            padding: 10px;
        }

        .gameplay-card {
            background: rgba(255,255,255,0.7);
            border: 1px solid var(--secondary-color);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 120px;
        }

        .gameplay-card:hover {
            background: #fff;
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-color: var(--primary-color);
        }
        
        .gameplay-card.locked {
            filter: grayscale(100%);
            opacity: 0.7;
            cursor: not-allowed;
        }

        .gameplay-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .gameplay-title {
            font-weight: bold;
            color: var(--primary-color);
            font-size: 1.1rem;
        }

        /* éšè—æ–‡ä»¶ä¸Šä¼ input */
        #file-input {
            display: none;
        }

        /* æ¨¡æ€æ¡† */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            animation: fadeIn 0.3s;
        }

        .modal-content {
            background: #fff;
            background-image: url('data:image/svg+xml;utf8,<svg width="100" height="100" transform="scale(0.5)" opacity="0.1" xmlns="http://www.w3.org/2000/svg"><path d="M10 10 L90 10 L90 90 L10 90 Z" fill="none" stroke="%23000" stroke-width="2"/></svg>');
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            padding: 30px;
            border-radius: 8px;
            border: 2px solid var(--primary-color);
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        .modal-close {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--secondary-color);
        }

        .story-text {
            font-size: 1.1rem;
            line-height: 1.8;
            text-indent: 2em;
            margin-bottom: 20px;
            text-align: justify;
        }

        .rank-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }

        .rank-table th, .rank-table td {
            border: 1px solid var(--secondary-color);
            padding: 8px;
            text-align: center;
            font-size: 0.9rem;
        }

        .rank-table th {
            background-color: rgba(142, 46, 46, 0.1);
            color: var(--primary-color);
        }

        /* é¡¶éƒ¨æ—¶é—´æ  */
        .time-bar {
            background: rgba(255,255,255,0.9);
            border-bottom: 2px solid var(--primary-color);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: bold;
            color: var(--secondary-color);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin: -20px -20px 20px -20px; /* æŠµæ¶ˆpanelçš„padding */
            border-radius: 6px 6px 0 0;
        }

        .time-info {
            display: flex;
            gap: 15px;
        }

        .action-points {
            color: var(--primary-color);
        }

        /* ç•Œé¢æŒ‡å¼•å›¾æ ‡ */
        .guide-icon {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 24px;
            height: 24px;
            background: var(--accent-color);
            color: #fff;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
            z-index: 10;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }

        /* --- åœ°å›¾ç³»ç»Ÿæ ·å¼ --- */
        #map-viewport {
            width: 100%;
            height: 100%;
            overflow: hidden;
            position: relative;
            background-color: #e6dcc3; /* å¤çº¸è‰² */
            cursor: grab;
            border: 2px solid var(--secondary-color);
            box-shadow: inset 0 0 20px rgba(0,0,0,0.2);
            user-select: none;
        }

        #map-viewport:active {
            cursor: grabbing;
        }

        #map-content {
            width: 1200px; /* ç¼©å°åœ°å›¾å°ºå¯¸ä»¥é€‚åº”æ‰‹æœº */
            height: 900px;
            position: absolute;
            top: -200px;
            left: -200px;
            background-image: url('https://iili.io/fwxj9V4.md.jpg');
            background-size: cover;
            background-position: center;
            background-color: #f4f0e6;
        }

        /* ç®€å•çš„å®«å¢™è£…é¥° */
        .map-wall-outer {
            display: none; /* éšè—æ—§è£…é¥° */
        }
        
        .map-decoration {
            display: none; /* éšè—æ—§è£…é¥° */
        }

        .map-point {
            position: absolute;
            transform: translate(-50%, -50%);
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            z-index: 10;
            transition: transform 0.2s;
        }

        .map-point:hover {
            transform: translate(-50%, -50%) scale(1.1);
            z-index: 20;
        }

        .point-icon {
            width: 40px;
            height: 40px;
            background: var(--primary-color);
            border: 2px solid #fff;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            display: flex;
            justify-content: center;
            align-items: center;
            color: #fff;
            font-size: 1.2rem;
            font-weight: bold;
        }
        
        .point-icon.special {
            background: var(--accent-color);
            border-color: var(--primary-color);
        }

        .point-label {
            margin-top: 5px;
            background: rgba(255,255,255,0.9);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.9rem;
            font-weight: bold;
            color: var(--secondary-color);
            border: 1px solid var(--secondary-color);
            white-space: nowrap;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        /* åœ°ç‚¹è¯¦æƒ…å…¨å±é¡µ */
        #location-detail-page {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: #000;
            z-index: 2000;
            display: none;
            flex-direction: column;
            color: #fff;
            animation: fadeIn 0.3s;
        }

        .loc-bg {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            object-fit: cover;
            opacity: 0.5;
            filter: blur(2px);
            transition: all 0.5s;
        }
        
        #location-detail-page:hover .loc-bg {
            filter: blur(0);
            transform: scale(1.02);
        }

        .loc-content {
            position: relative;
            z-index: 1;
            padding: 40px;
            height: 100%;
            display: flex;
            flex-direction: column;
            background: linear-gradient(to bottom, rgba(0,0,0,0.3) 0%, rgba(0,0,0,0.6) 50%, rgba(0,0,0,0.9) 100%);
        }

        .loc-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 20px;
        }

        .loc-title-group {
            text-shadow: 0 2px 4px rgba(0,0,0,0.8);
        }

        .loc-title {
            font-size: 3rem;
            font-family: var(--font-main);
            color: var(--accent-color);
            margin: 0;
        }
        
        .loc-desc {
            font-size: 1.1rem;
            color: #eee;
            margin-top: 10px;
            max-width: 600px;
        }

        .loc-close {
            background: transparent;
            border: 2px solid rgba(255,255,255,0.5);
            color: #fff;
            width: 40px; height: 40px;
            border-radius: 50%;
            font-size: 1.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
        }
        
        .loc-close:hover {
            background: rgba(255,255,255,0.2);
            border-color: #fff;
            transform: rotate(90deg);
        }

        .loc-body {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: flex-end;
            padding-bottom: 40px;
        }

        /* å­åœ°ç‚¹åˆ—è¡¨ */
        .sub-locations-container {
            margin-bottom: 30px;
        }
        
        .sub-loc-title {
            font-size: 1.1rem;
            color: #ccc;
            margin-bottom: 10px;
            border-left: 3px solid var(--accent-color);
            padding-left: 10px;
        }

        .sub-locations {
            display: flex;
            gap: 15px;
            overflow-x: auto;
            padding: 5px 0 15px;
        }
        
        .sub-locations::-webkit-scrollbar {
            height: 6px;
        }
        
        .sub-locations::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.3);
            border-radius: 3px;
        }

        .sub-loc-item {
            min-width: 140px;
            height: 90px;
            background: rgba(255,255,255,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            border-radius: 6px;
            transition: all 0.3s;
            position: relative;
            overflow: hidden;
        }

        .sub-loc-item:hover {
            border-color: var(--accent-color);
            background: rgba(255,255,255,0.2);
            transform: translateY(-3px);
        }
        
        .sub-loc-item.active {
            border-color: var(--accent-color);
            background: rgba(212, 175, 55, 0.2);
            box-shadow: 0 0 10px rgba(212, 175, 55, 0.3);
        }

        .loc-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
            max-height: 300px; /* é™åˆ¶é«˜åº¦ */
            overflow-y: auto; /* å…è®¸å‚ç›´æ»‘åŠ¨ */
            padding-right: 5px;
        }
        
        .loc-actions::-webkit-scrollbar {
            width: 6px;
        }
        
        .loc-actions::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.3);
            border-radius: 3px;
        }

        .action-card {
            background: rgba(0,0,0,0.6);
            border: 1px solid rgba(255,255,255,0.2);
            padding: 20px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            backdrop-filter: blur(5px);
            display: flex;
            align-items: center;
        }

        .action-card:hover {
            background: rgba(142, 46, 46, 0.6);
            transform: translateY(-5px);
            border-color: var(--accent-color);
        }
        
        .action-icon {
            font-size: 2rem;
            margin-right: 15px;
            color: var(--accent-color);
        }

        .action-info h4 {
            margin: 0 0 5px 0;
            color: #fff;
            font-size: 1.1rem;
        }

        .action-desc {
            font-size: 0.85rem;
            color: #ccc;
            margin: 0;
        }
        
        /* æ¢ç´¢ç»“æœå¼¹çª— */
        .explore-result {
            position: fixed;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            color: #333;
            padding: 30px;
            border-radius: 8px;
            border: 2px solid var(--primary-color);
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
            z-index: 2100;
            text-align: center;
            max-width: 400px;
            width: 90%;
            display: none;
            animation: popIn 0.3s;
        }
        
        @keyframes popIn {
            from { transform: translate(-50%, -50%) scale(0.8); opacity: 0; }
            to { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        }

        /* å¦ƒå«”åˆ—è¡¨æ¨¡æ€æ¡† */
        .concubine-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 15px;
            max-height: 400px;
            overflow-y: auto;
        }

        .concubine-item {
            text-align: center;
            cursor: pointer;
            padding: 10px;
            border: 1px solid transparent;
            border-radius: 4px;
            transition: all 0.2s;
        }

        .concubine-item:hover {
            background: rgba(142, 46, 46, 0.1);
            border-color: var(--primary-color);
        }

        .concubine-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            border: 2px solid var(--secondary-color);
            object-fit: cover;
            margin-bottom: 5px;
        }

        .concubine-name {
            font-weight: bold;
            font-size: 0.9rem;
            color: var(--primary-color);
        }

        .concubine-rank {
            font-size: 0.8rem;
            color: #666;
        }

        .circle-avatar {
            width: 100px;
            height: 100px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--primary-color);
        }

        /* AIå¯¹è¯æ¡† */
        #ai-chat-modal {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2600;
        }

        .chat-container {
            width: 90%;
            max-width: 500px;
            height: 70vh;
            background: #fff;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 2px solid var(--primary-color);
        }

        .chat-header {
            padding: 15px;
            background: var(--primary-color);
            color: #fff;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-messages {
            flex: 1;
            padding: 15px;
            overflow-y: auto;
            background: #f4f0e6;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .chat-input-area {
            padding: 10px;
            background: #fff;
            border-top: 1px solid #ccc;
            display: flex;
            gap: 10px;
        }

        .message {
            max-width: 80%;
            padding: 10px;
            border-radius: 8px;
            font-size: 0.95rem;
            line-height: 1.4;
        }

        .message.user {
            align-self: flex-end;
            background: #d4af37;
            color: #fff;
        }

        .message.ai {
            align-self: flex-start;
            background: #fff;
            border: 1px solid #ccc;
        }

    </style>
</head>
<body>

    <div id="toast">æç¤ºä¿¡æ¯</div>

    <!-- å‰§æƒ…æ¨¡æ€æ¡† -->
    <div id="story-modal" class="modal-overlay">
        <div class="modal-content">
            <h2 style="margin-bottom: 20px;">å…¥å®«è®°</h2>
            <div id="story-content" class="story-text">
                <!-- å‰§æƒ…å†…å®¹ -->
            </div>
            <div style="text-align: center;">
                <button class="btn" onclick="closeStoryModal()">å¼€å¯å®«å»·ç”Ÿæ´»</button>
            </div>
        </div>
    </div>

    <!-- ä½ä»½è¡¨æ¨¡æ€æ¡† -->
    <div id="rank-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close" onclick="document.getElementById('rank-modal').style.display='none'">&times;</span>
            <h2>åå®«ä½ä»½è¡¨</h2>
            <table class="rank-table">
                <thead>
                    <tr>
                        <th>å“çº§</th>
                        <th>ä½ä»½</th>
                        <th>æ™‹å‡æ¡ä»¶</th>
                    </tr>
                </thead>
                <tbody id="rank-table-body">
                    <!-- åŠ¨æ€ç”Ÿæˆ -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- åœ°ç‚¹è¯¦æƒ…é¡µ -->
    <div id="location-detail-page">
        <img id="loc-bg-img" class="loc-bg" src="" alt="èƒŒæ™¯">
        <div class="loc-content">
            <div class="loc-header">
                <div class="loc-title-group">
                    <h2 id="loc-title" class="loc-title">åœ°ç‚¹åç§°</h2>
                    <div id="loc-desc" class="loc-desc">åœ°ç‚¹æè¿°...</div>
                </div>
                <button class="loc-close" onclick="closeLocationDetail()">&times;</button>
            </div>
            
            <div class="loc-body">
                <div id="sub-loc-container" class="sub-locations-container" style="display: none;">
                    <div class="sub-loc-title">åŒºåŸŸé€‰æ‹©</div>
                    <div id="sub-loc-list" class="sub-locations">
                        <!-- å­åœ°ç‚¹åˆ—è¡¨ -->
                    </div>
                </div>

                <div id="loc-actions-list" class="loc-actions">
                    <!-- åŠ¨ä½œåˆ—è¡¨ -->
                </div>
            </div>
        </div>
    </div>

    <!-- æ¢ç´¢ç»“æœå¼¹çª— -->
    <div id="explore-result-modal" class="explore-result">
        <h3 id="explore-title" style="color: var(--primary-color); margin-top: 0;">æ¢ç´¢ç»“æœ</h3>
        <div id="explore-text" style="margin: 20px 0; line-height: 1.6;">...</div>
        <button class="btn" onclick="document.getElementById('explore-result-modal').style.display='none'">ç¡®å®š</button>
    </div>

    <!-- å¤œé—´äº‹ä»¶å¼¹çª— (ä¼˜å…ˆçº§æ›´é«˜) -->
    <div id="night-modal" class="modal-overlay" style="z-index: 2200;">
        <div class="modal-content" style="max-width: 400px; text-align: center; background: #2c3e50; color: #fff; border: 2px solid #d4af37;">
            <h3 style="color: #d4af37; margin-top: 0;">ğŸŒ™ å¤œæ·±äº†</h3>
            <div id="night-content" style="margin: 20px 0; line-height: 1.6; font-size: 1.1rem;">
                <!-- åŠ¨æ€å†…å®¹ -->
            </div>
            <button class="btn" style="background-color: #d4af37; color: #333; border: none;" onclick="closeNightModal()">çŸ¥é“äº†</button>
        </div>
    </div>

    <!-- åœ£æ—¨æ¨¡æ€æ¡† -->
    <div id="edict-modal" class="edict-modal" onclick="closeEdict()">
        <div class="edict-content" onclick="event.stopPropagation()">
            <div class="edict-dragon"></div>
            <div class="edict-text-container" id="edict-text">
                <!-- åœ£æ—¨å†…å®¹ -->
            </div>
            <div class="edict-seal">å—å‘½äºå¤©</div>
        </div>
    </div>

    <!-- é€šç”¨æ“ä½œé€‰æ‹©æ¨¡æ€æ¡† (ç”¨äºå®«æ–—/ç»“ç›Ÿç­‰) -->
    <div id="action-select-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close" onclick="document.getElementById('action-select-modal').style.display='none'">&times;</span>
            <h3 id="action-select-title">é€‰æ‹©ç›®æ ‡</h3>
            <div id="action-select-list" class="concubine-list">
                <!-- åŠ¨æ€ç”Ÿæˆå¦ƒå«”åˆ—è¡¨ -->
            </div>
            <div id="action-options" style="margin-top: 20px; border-top: 1px dashed #ccc; padding-top: 15px; display: none;">
                <h4 id="action-options-title">é€‰æ‹©æ‰‹æ®µ</h4>
                <div id="action-buttons" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                    <!-- åŠ¨æ€ç”ŸæˆæŒ‰é’® -->
                </div>
            </div>
        </div>
    </div>

    <!-- å«ç¥¸é€‰æ‹©æ¨¡æ€æ¡† -->
    <div id="blame-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="color: var(--primary-color);">å«ç¥¸äºäºº</h3>
            <p style="font-size: 0.9rem; color: #666;">æ­¤äº‹è‹¥è¢«æŸ¥å‡ºææœ‰å¤§ç¥¸ï¼Œæ˜¯å¦è¦å«ç¥¸ç»™å…¶ä»–å¦ƒå«”ï¼Ÿ</p>
            <div id="blame-list" class="concubine-list" style="max-height: 300px;">
                <!-- åŠ¨æ€ç”Ÿæˆ -->
            </div>
            <div style="margin-top: 20px; text-align: center;">
                <button class="btn btn-secondary" onclick="cancelBlame()">ä¸å«ç¥¸</button>
            </div>
        </div>
    </div>

    <!-- è´­ä¹°å±æ€§æ¨¡æ€æ¡† -->
    <div id="buy-stats-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 400px;">
            <span class="modal-close" onclick="document.getElementById('buy-stats-modal').style.display='none'">&times;</span>
            <h3>é“¶ä¸¤æå‡å±æ€§</h3>
            <p style="font-size: 0.9rem; color: #666;">æ¶ˆè€—é“¶ä¸¤å¯å¿«é€Ÿæå‡å±æ€§ã€‚<br>100ä¸¤ = 5ç‚¹ï¼Œå•æ¬¡ä¸Šé™1000ä¸¤(50ç‚¹)ã€‚</p>
            <div class="map-grid" style="grid-template-columns: repeat(2, 1fr); gap: 10px;">
                <button class="btn btn-secondary" onclick="buyStat('charm')">æå‡å®¹è²Œ</button>
                <button class="btn btn-secondary" onclick="buyStat('intelligence')">æå‡æ‰æƒ…</button>
                <button class="btn btn-secondary" onclick="buyStat('health')">æå‡ä½“è´¨</button>
                <button class="btn btn-secondary" onclick="buyStat('social')">æå‡äº¤é™…</button>
                <button class="btn btn-secondary" onclick="buyStat('scheme')">æå‡å¿ƒæœº</button>
                <button class="btn btn-secondary" onclick="buyStat('luck')">æå‡ç¦è¿</button>
            </div>
        </div>
    </div>

    <!-- å¦ƒå«”åˆ—è¡¨æ¨¡æ€æ¡† -->
    <div id="concubine-list-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close" onclick="document.getElementById('concubine-list-modal').style.display='none'">&times;</span>
            <h2>åå®«åå½•</h2>
            <div id="concubine-list-container" class="concubine-list">
                <!-- åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <!-- å¦ƒå«”è¯¦æƒ…æ¨¡æ€æ¡† -->
    <div id="concubine-detail-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 400px;">
            <span class="modal-close" onclick="document.getElementById('concubine-detail-modal').style.display='none'">&times;</span>
            <div style="text-align: center;">
                <canvas id="concubine-detail-avatar" width="100" height="100" class="circle-avatar"></canvas>
                <h3 id="concubine-detail-name" style="margin: 10px 0;">å§“å</h3>
                <div id="concubine-detail-rank" style="color: var(--primary-color); font-weight: bold;">ä½ä»½</div>
            </div>
            <div style="margin-top: 20px; line-height: 1.8;">
                <p><strong>æ€§æ ¼ï¼š</strong><span id="concubine-detail-trait">--</span></p>
                <p><strong>å®¹è²Œï¼š</strong><span id="concubine-detail-charm">--</span></p>
                <p><strong>å¿ƒæƒ…ï¼š</strong><span id="concubine-detail-mood">--</span></p>
                <p><strong>çŠ¶æ€ï¼š</strong><span id="concubine-detail-state">--</span></p>
                <p><strong>å¥½æ„Ÿï¼š</strong><span id="concubine-detail-affection">--</span></p>
                <p><strong>å¿ƒæœºï¼š</strong><span id="concubine-detail-scheme">--</span></p>
            </div>
            <div style="margin-top: 20px; text-align: center;">
                <button class="btn" onclick="startAIChat('concubine')">ğŸ’¬ é—²èŠ (AI)</button>
            </div>
        </div>
    </div>

    <!-- çš‡å¸è¯¦æƒ…æ¨¡æ€æ¡† (å…»å¿ƒæ®¿ä¸“ç”¨) -->
    <div id="emperor-detail-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px; background-image: url('https://iili.io/fwxrGHv.md.jpg'); background-size: cover; color: #fff; text-shadow: 0 1px 3px rgba(0,0,0,0.8);">
            <span class="modal-close" onclick="document.getElementById('emperor-detail-modal').style.display='none'" style="color: #fff;">&times;</span>
            <div style="background: rgba(0,0,0,0.6); padding: 20px; border-radius: 8px; border: 1px solid var(--accent-color);">
                <div style="text-align: center;">
                    <img id="emp-detail-avatar" src="" class="circle-avatar" style="border-color: var(--accent-color); width: 120px; height: 120px;">
                    <h2 id="emp-detail-name" style="color: var(--accent-color); margin: 10px 0;">çš‡å¸</h2>
                    <div id="emp-detail-state" style="font-size: 1.1rem; font-weight: bold;">å½“å‰çŠ¶æ€ï¼š--</div>
                </div>
                <div style="margin-top: 20px; line-height: 1.8; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div><strong>å¹´é¾„ï¼š</strong><span id="emp-detail-age">--</span></div>
                    <div><strong>æ€§æ ¼ï¼š</strong><span id="emp-detail-trait">--</span></div>
                    <div><strong>ç›¸è²Œï¼š</strong><span id="emp-detail-look">--</span></div>
                    <div><strong>åå¥½ï¼š</strong><span id="emp-detail-like">--</span></div>
                </div>
                <div id="emp-interaction-area" style="margin-top: 20px; border-top: 1px dashed rgba(255,255,255,0.5); padding-top: 15px;">
                    <!-- äº’åŠ¨æŒ‰é’® -->
                </div>
                <div style="margin-top: 10px; text-align: center;">
                    <button class="btn btn-secondary" style="width: 100%;" onclick="startAIChat('emperor')">ğŸ’¬ è§è§é—²èŠ (AI)</button>
                </div>
            </div>
        </div>
    </div>

    <!-- AIèŠå¤©æ¨¡æ€æ¡† -->
    <div id="ai-chat-modal">
        <div class="chat-container">
            <div class="chat-header">
                <span id="chat-target-name">å¯¹è¯ç›®æ ‡</span>
                <span style="cursor: pointer;" onclick="document.getElementById('ai-chat-modal').style.display='none'">&times;</span>
            </div>
            <div id="chat-messages" class="chat-messages">
                <!-- æ¶ˆæ¯è®°å½• -->
            </div>
            <div class="chat-input-area">
                <input type="text" id="chat-input" placeholder="è¾“å…¥ä½ æƒ³è¯´çš„è¯..." style="margin-bottom: 0;">
                <button class="btn btn-small" onclick="sendChatMessage()">å‘é€</button>
            </div>
        </div>
    </div>

    <!-- ä¾å¯æ¨¡æ€æ¡† -->
    <div id="shiqin-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 600px; background: #fff0f5; border: 2px solid #ff69b4;">
            <div style="text-align: center; margin-bottom: 20px;">
                <h2 style="color: #d81b60;">ä¾å¯</h2>
                <div style="font-size: 0.9rem; color: #666; background: rgba(255,255,255,0.8); padding: 10px; border-radius: 4px; margin-bottom: 10px;">
                    <strong>è§„åˆ™ï¼š</strong><br>
                    1. åˆå§‹å…´è‡´0%ï¼Œæ¯æ¬¡äº’åŠ¨éšæœºå¢åŠ 15%-30%ã€‚<br>
                    2. å…±æœ‰4æ¬¡äº’åŠ¨æœºä¼šï¼Œæœºä¼šç”¨å®Œæˆ–å…´è‡´æ»¡100%åå¯å°±å¯ã€‚<br>
                    3. å…´è‡´è¶Šé«˜ï¼Œè·å¾—çš„åœ£å® è¶Šå¤šã€‚æœ€é«˜å¯è·8ç‚¹åœ£å® ã€‚<br>
                    4. ä¾å¯åæ¬¡æ—¥æœ‰æ¦‚ç‡æ€€å­•ï¼ˆéœ€å¼€å¯æ€€å­•ç³»ç»Ÿï¼‰ã€‚
                </div>
                <div style="display: flex; justify-content: center; align-items: center; gap: 20px;">
                    <div style="text-align: center;">
                        <div style="font-weight: bold; color: #d81b60;">çš‡ä¸Šå…´è‡´</div>
                        <div style="width: 150px; height: 20px; background: #ddd; border-radius: 10px; overflow: hidden; margin-top: 5px;">
                            <div id="shiqin-mood-bar" style="width: 0%; height: 100%; background: #ff69b4; transition: width 0.3s;"></div>
                        </div>
                        <div id="shiqin-mood-text">0%</div>
                    </div>
                    <div style="text-align: center;">
                        <div style="font-weight: bold; color: #2c3e50;">å‰©ä½™æœºä¼š</div>
                        <div id="shiqin-chances" style="font-size: 1.5rem; font-weight: bold;">4</div>
                    </div>
                </div>
            </div>
            
            <div id="shiqin-story" style="height: 150px; overflow-y: auto; background: #fff; padding: 15px; border: 1px dashed #ff69b4; border-radius: 4px; margin-bottom: 20px; font-size: 0.95rem; line-height: 1.6;">
                çº¢çƒ›é«˜ç…§ï¼Œæš–é¦™è¢­äºº...
            </div>

            <div id="shiqin-actions" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;">
                <button class="btn" style="background-color: #e91e63;" onclick="handleShiQinAction('flirt')">å«æƒ…è„‰è„‰</button>
                <button class="btn" style="background-color: #9c27b0;" onclick="handleShiQinAction('talk')">æ¸©è¨€è½¯è¯­</button>
                <button class="btn" style="background-color: #673ab7;" onclick="handleShiQinAction('serve')">ç ”å¢¨æ·»é¦™</button>
                <button class="btn" style="background-color: #3f51b5;" onclick="handleShiQinAction('dance')">çŒ®èˆä¸€æ›²</button>
                <button class="btn" style="background-color: #2196f3;" onclick="handleShiQinAction('massage')">æ¨æ‹¿æŒ‰æ‘©</button>
                <button class="btn" style="background-color: #d81b60; border: 2px solid #ffeb3b;" onclick="finishShiQin()">å®‰å¯</button>
            </div>
        </div>
    </div>

    <!-- å­å—£æ¨¡æ€æ¡† -->
    <div id="children-modal" class="modal-overlay">
        <div class="modal-content">
            <span class="modal-close" onclick="document.getElementById('children-modal').style.display='none'">&times;</span>
            <h2>çš‡å—£åŸ¹å…»</h2>
            <div id="children-list" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; max-height: 400px; overflow-y: auto;">
                <!-- åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <!-- æœˆåº¦æ€»ç»“é€‰æ‹©æ¨¡æ€æ¡† -->
    <div id="month-summary-modal" class="modal-overlay" style="z-index: 3100;">
        <div class="modal-content" style="max-width: 400px; text-align: center;">
            <h3>æœ¬æœˆç»“æŸ</h3>
            <p>è¯·é€‰æ‹©æœˆåº¦æ€»ç»“çš„ç”Ÿæˆæ–¹å¼ï¼š</p>
            <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                <button class="btn" onclick="processNextMonth('ai')">âœ¨ AI ç”Ÿæˆæ•…äº‹</button>
                <button class="btn btn-secondary" onclick="processNextMonth('system')">ğŸ“„ ç³»ç»Ÿç®€æŠ¥</button>
            </div>
        </div>
    </div>

    <div id="main-container">
        <!-- 1. èº«ä»½è‡ªå®šä¹‰ -->
        <div id="page-create" class="page active">
            <div class="guide-icon" onclick="alert('ã€å…¥å®«æŒ‡å¼•ã€‘\n1. è®¾å®šå§“åã€å®¶ä¸–å’Œåˆå§‹å±æ€§ã€‚\n2. å±æ€§å½±å“åç»­å‘å±•ï¼š\n   - å®¹è²Œï¼šå½±å“åˆå°ä½ä»½å’Œåœ£å® è·å–\n   - å¿ƒæœºï¼šå½±å“å®«æ–—æˆåŠŸç‡å’Œé˜²å¾¡åŠ›\n   - ä½“è´¨ï¼šå½±å“å¥åº·å’Œç”Ÿç—…æ¦‚ç‡\n   - äº¤é™…ï¼šå½±å“æ‹‰æ‹¢ç»“ç›Ÿæ•ˆæœ\n   - æ‰æƒ…ï¼šå½±å“éƒ¨åˆ†äº’åŠ¨å’Œå®´ä¼šè¡¨ç°\n   - ç¦è¿ï¼šå½±å“éšæœºäº‹ä»¶å¥½å\n3. è®°å¾—åœ¨è®¾ç½®ä¸­é…ç½®API Keyä»¥ä½“éªŒAIåŠŸèƒ½ï¼')">?</div>
            <div class="panel">
                <h1>å…¥å®«åå†Œ</h1>
                <div class="avatar-container">
                    <canvas id="avatar-canvas" width="150" height="150"></canvas>
                </div>
                <div class="avatar-controls">
                    <button class="btn btn-secondary btn-small" onclick="generateRandomAvatar()">éšæœºå®¹é¢œ</button>
                    <button class="btn btn-secondary btn-small" onclick="document.getElementById('file-input').click()">ä¸Šä¼ ç”»åƒ</button>
                    <input type="file" id="file-input" accept="image/*" onchange="handleImageUpload(this)">
                </div>

                <div class="form-group">
                    <label class="form-label">å§“å</label>
                    <div class="input-group">
                        <input type="text" id="input-name" placeholder="è¯·è¾“å…¥æˆ–éšæœºç”Ÿæˆ">
                        <button class="btn btn-secondary" onclick="generateRandomName()">éšæœº</button>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">å¹´é¾„ (16-22)</label>
                    <input type="number" id="input-age" value="16" min="16" max="22">
                </div>
                
                <div class="form-group">
                    <label class="form-label">å®¶ä¸–èƒŒæ™¯</label>
                    <div class="generated-info" id="background-display">
                        è¯·ç‚¹å‡»ç”Ÿæˆå®¶ä¸–...
                    </div>
                    <button class="btn btn-secondary" style="width: 100%;" onclick="generateRandomBackground()">éšæœºç”Ÿæˆå®¶ä¸–</button>
                </div>

                <div class="form-group">
                    <label class="form-label">åˆå§‹å±æ€§åˆ†é… (å‰©ä½™ç‚¹æ•°: <span id="points-left">100</span>)</label>
                    <div class="stats-grid" style="grid-template-columns: repeat(3, 1fr);">
                        <div class="stat-item">
                            <span>å®¹è²Œ</span>
                            <input type="number" class="stat-input" data-stat="charm" value="0" min="0" max="500" style="width: 60px; margin:0;">
                            <span class="stat-desc" id="desc-charm">è²Œè‹¥æ— ç›</span>
                        </div>
                        <div class="stat-item">
                            <span>æ‰æƒ…</span>
                            <input type="number" class="stat-input" data-stat="intelligence" value="0" min="0" max="500" style="width: 60px; margin:0;">
                            <span class="stat-desc" id="desc-intelligence">èƒ¸æ— ç‚¹å¢¨</span>
                        </div>
                        <div class="stat-item">
                            <span>ä½“è´¨</span>
                            <input type="number" class="stat-input" data-stat="health" value="0" min="0" max="500" style="width: 60px; margin:0;">
                            <span class="stat-desc" id="desc-health">å¼±ä¸ç¦é£</span>
                        </div>
                        <div class="stat-item">
                            <span>äº¤é™…</span>
                            <input type="number" class="stat-input" data-stat="social" value="0" min="0" max="500" style="width: 60px; margin:0;">
                            <span class="stat-desc" id="desc-social">å­¤èŠ³è‡ªèµ</span>
                        </div>
                        <div class="stat-item">
                            <span>å¿ƒæœº</span>
                            <input type="number" class="stat-input" data-stat="scheme" value="0" min="0" max="500" style="width: 60px; margin:0;">
                            <span class="stat-desc" id="desc-scheme">å•çº¯æ— çŸ¥</span>
                        </div>
                        <div class="stat-item">
                            <span>ç¦è¿</span>
                            <input type="number" class="stat-input" data-stat="luck" value="0" min="0" max="500" style="width: 60px; margin:0;">
                            <span class="stat-desc" id="desc-luck">éœ‰è¿å½“å¤´</span>
                        </div>
                    </div>
                </div>

                <!-- çš‡å¸ä¸åå®«è®¾ç½® -->
                <div class="settings-section" style="margin-top: 20px; border-top: 1px dashed #ccc; padding-top: 20px;">
                    <h3>å®«å»·è®¾ç½®</h3>
                    <div class="form-group">
                        <label class="form-label">çš‡å¸ä¿¡æ¯</label>
                        <div class="generated-info" id="emperor-info">
                            è¯·ç‚¹å‡»ç”Ÿæˆçš‡å¸ä¿¡æ¯...
                        </div>
                        <div style="display: flex; gap: 10px; margin-top: 5px;">
                            <button class="btn btn-secondary" style="flex: 1;" onclick="generateEmperor()">éšæœºç”Ÿæˆçš‡å¸</button>
                            <button class="btn btn-secondary" style="flex: 1;" onclick="document.getElementById('emp-file-input').click()">ä¸Šä¼ çš‡å¸å¤´åƒ</button>
                            <input type="file" id="emp-file-input" accept="image/*" style="display: none;" onchange="handleEmperorImage(this)">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label">åå®«è§„æ¨¡</label>
                        <select id="harem-size">
                            <option value="small">å¯¥å¯¥æ— å‡  (5-25äºº)</option>
                            <option value="medium" selected>åå®«å……ç›ˆ (26-70äºº)</option>
                            <option value="large">ä½³ä¸½ä¸‰åƒ (70-150äºº)</option>
                        </select>
                    </div>
                </div>

                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn" onclick="startGame()">å…¥å®«é€‰ç§€</button>
                </div>
            </div>
        </div>

        <!-- 2. çš‡å®«å¤§åœ°å›¾ -->
        <div id="page-map" class="page" style="padding: 0; max-width: none; height: 100%;">
            <div class="guide-icon" onclick="alert('ã€åœ°å›¾æŒ‡å¼•ã€‘\n1. æ‹–åŠ¨åœ°å›¾æŸ¥çœ‹ä¸åŒå®«æ®¿ã€‚\n2. ç‚¹å‡»åœ°ç‚¹å¯è¿›å…¥äº’åŠ¨ã€‚\n3. å…»å¿ƒæ®¿å¯è§è§çš‡ä¸Šï¼Œå‚¨ç§€å®«å¯æå‡å±æ€§ã€‚\n4. æ³¨æ„è¡ŒåŠ¨ç‚¹æ¶ˆè€—ï¼Œæ¯æ—¬æœ‰6ç‚¹ã€‚\n5. è‹¥åœ£å® ä½äº-50ï¼Œå°†è¢«æ‰“å…¥å†·å®«ï¼Œæ— æ³•è‡ªç”±è¡ŒåŠ¨ï¼')">?</div>
            <div id="map-viewport">
                <div id="map-content">
                    <div class="map-wall-outer"></div>
                    <div class="map-decoration" style="top: 100px; left: 100px;">å®«</div>
                    <div class="map-decoration" style="bottom: 100px; right: 100px;">å»·</div>
                    <!-- åœ°ç‚¹å°†é€šè¿‡JSåŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
            <!-- åœ°å›¾æ§åˆ¶æç¤º -->
            <div style="position: absolute; bottom: 80px; left: 50%; transform: translateX(-50%); background: rgba(255,255,255,0.8); padding: 5px 15px; border-radius: 20px; font-size: 0.8rem; pointer-events: none; border: 1px solid var(--secondary-color);">
                æ‹–åŠ¨åœ°å›¾æŸ¥çœ‹æ›´å¤šåœ°ç‚¹
            </div>
        </div>

        <!-- 3. ä¸ªäººæ¡£æ¡ˆ -->
        <div id="page-profile" class="page">
            <div class="guide-icon" onclick="alert('ã€æ¡£æ¡ˆæŒ‡å¼•ã€‘\n1. æŸ¥çœ‹ä¸ªäººå±æ€§ã€ä½ä»½å’Œåœ£å® ã€‚\n2. æ»¡è¶³æ¡ä»¶åå¯ç‚¹å‡»â€œæ™‹å‡â€æŒ‰é’®ã€‚\n3. ç‚¹å‡»å¤´åƒå¯æŸ¥çœ‹åå®«åå½•ã€‚\n4. è®°å¾—æ¯æœˆç‚¹å‡»â€œè¿›å…¥ä¸‹ä¸€æœˆâ€é¢†å–æœˆé“¶ï¼\n5. åœ£å® è¿‡ä½(-50)ä¼šè¢«æ‰“å…¥å†·å®«ï¼Œè¯·åŠ¡å¿…å°å¿ƒã€‚')">?</div>
            <div class="panel">
                <h1>ç‰ç‰’æ¡£æ¡ˆ</h1>
                <div class="profile-header">
                    <div style="position: relative; cursor: pointer;" onclick="showConcubineList()">
                        <canvas id="profile-avatar-canvas" class="profile-avatar" width="100" height="100"></canvas>
                        <div style="position: absolute; top: -10px; left: 50%; transform: translateX(-50%); background: var(--accent-color); color: #fff; font-size: 0.7rem; padding: 2px 8px; border-radius: 10px; white-space: nowrap;">æŸ¥çœ‹åå®«åå½•</div>
                    </div>
                    <div class="profile-info">
                        <h2 id="profile-name">å§“å</h2>
                        <div id="profile-rank" style="color: var(--primary-color); font-weight: bold; font-size: 1.1rem;">ä½åˆ†ï¼š--</div>
                        <div id="profile-bg" style="font-size: 0.9rem; color: #666; margin-top: 5px;">å®¶ä¸–ï¼š--</div>
                    </div>
                </div>
                
                <div class="rank-info">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <strong>æ™‹å‡æ¡ä»¶ï¼š</strong>
                        <button class="btn btn-secondary btn-small" onclick="showRankTable()">æŸ¥çœ‹ä½ä»½è¡¨</button>
                    </div>
                    <div id="rank-condition" style="font-size: 0.9rem; margin-top: 5px;">--</div>
                    <div style="margin-top: 10px; text-align: center;">
                        <button id="btn-promote" class="btn btn-secondary" style="width: 100%;" disabled onclick="promotePlayer()">æ™‹å‡</button>
                    </div>
                </div>
                <br>

                <h3>å±æ€§è¯¦æƒ…</h3>
                <div class="stats-grid" style="grid-template-columns: repeat(3, 1fr);">
                    <div class="stat-item"><span>å®¹è²Œ</span><span id="val-charm">0</span><div class="stat-desc" id="view-desc-charm"></div></div>
                    <div class="stat-item"><span>æ‰æƒ…</span><span id="val-intelligence">0</span><div class="stat-desc" id="view-desc-intelligence"></div></div>
                    <div class="stat-item"><span>ä½“è´¨</span><span id="val-health">0</span><div class="stat-desc" id="view-desc-health"></div></div>
                    <div class="stat-item"><span>äº¤é™…</span><span id="val-social">0</span><div class="stat-desc" id="view-desc-social"></div></div>
                    <div class="stat-item"><span>å¿ƒæœº</span><span id="val-scheme">0</span><div class="stat-desc" id="view-desc-scheme"></div></div>
                    <div class="stat-item"><span>ç¦è¿</span><span id="val-luck">0</span><div class="stat-desc" id="view-desc-luck"></div></div>
                </div>
                <div class="stats-grid" style="margin-top: 10px;">
                    <div class="stat-item"><span>åœ£å® </span><span id="val-favor">0</span></div>
                    <div class="stat-item"><span>é“¶ä¸¤</span><span id="val-money">0</span></div>
                </div>
                
                <div style="margin-top: 10px; background: rgba(255,255,255,0.5); padding: 10px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong>å­•ç‡ï¼š</strong><span id="val-preg-rate">5%</span>
                        <span style="font-size: 0.8rem; color: #666;">(å†…åŠ¡åºœå¯æå‡)</span>
                    </div>
                    <div>
                        <label style="font-size: 0.9rem; cursor: pointer;">
                            <input type="checkbox" id="preg-toggle" onchange="togglePregnancy(this)" checked> å¼€å¯æ€€å­•
                        </label>
                    </div>
                </div>

                <div style="margin-top: 10px; text-align: center;">
                    <button class="btn btn-secondary btn-small" onclick="document.getElementById('buy-stats-modal').style.display='flex'">ğŸ’° é“¶ä¸¤è´­ä¹°å±æ€§</button>
                </div>

                <div style="margin-top: 20px;">
                    <h3>ç”Ÿå¹³è®°äº‹</h3>
                    <div id="profile-log" style="height: 150px; overflow-y: auto; font-size: 0.9rem; border: 1px solid #ccc; padding: 10px; background: rgba(255,255,255,0.5);">
                        <p>æš‚æ— è®°å½•...</p>
                    </div>
                </div>
                
                <!-- éšæ—¶è¿›å…¥ä¸‹ä¸€æœˆæŒ‰é’® -->
                <button class="btn" style="width: 100%; margin-top: 20px; background-color: #d4af37;" onclick="nextMonth()">è¿›å…¥ä¸‹ä¸€æœˆ</button>
            </div>
        </div>

        <!-- 4. å„ç§ç©æ³• -->
        <div id="page-gameplay" class="page">
            <div class="guide-icon" onclick="alert('ã€ç©æ³•æŒ‡å¼•ã€‘\n1. æš—å®³é™·å®³ï¼šé™ä½å¯¹æ‰‹åœ£å® æˆ–ä½¿å…¶ç”Ÿç—…ï¼Œéœ€é«˜å¿ƒæœºã€‚è‹¥è¢«å‘ç°å¯èƒ½ç»“ä¸ºæ­»æ•Œã€‚\n2. æ‹‰æ‹¢ç»“ç›Ÿï¼šèµ é€é“¶ä¸¤/é¦–é¥°å¢åŠ å¥½æ„Ÿã€‚å¥½æ„Ÿè¾¾æ ‡å¯ç»“ç›Ÿï¼Œç›Ÿå‹æä¾›å¤šé‡åŠ©ç›Šã€‚\n3. çš‡å—£æŠšè‚²ï¼šåŸ¹å…»å­å—£å±æ€§ï¼Œæˆå¹´åå¯è”å§»ã€‚\n4. å®«å»·å®´ä¼šï¼šæ¯å¹´3æœˆ/9æœˆå¼€å¯ï¼Œæ‰è‰ºæ¯”æ‹¼èµ¢å–èµèµã€‚\n5. å®¶æ—è”ç»œï¼šè·å–é“¶ä¸¤æ”¯æŒã€‚')">?</div>
            <div class="panel">
                <h1>å®«æ–—ç©æ³•</h1>
                
                <div class="gameplay-grid">
                    <div class="gameplay-card" onclick="openGameModule('scheme')">
                        <div class="gameplay-icon">â˜ ï¸</div>
                        <div class="gameplay-title">æš—å®³é™·å®³</div>
                        <div style="font-size: 0.8rem; color: #666;">é€ è°£ã€ä¸‹æ¯’ã€å·«è›Š</div>
                    </div>
                    <div class="gameplay-card" onclick="openGameModule('alliance')">
                        <div class="gameplay-icon">ğŸ¤</div>
                        <div class="gameplay-title">æ‹‰æ‹¢ç»“ç›Ÿ</div>
                        <div style="font-size: 0.8rem; color: #666;">èµ ç¤¼ã€ç»“äº¤ã€å…±è¿›é€€</div>
                    </div>
                    <div class="gameplay-card locked" onclick="showToast('åŠŸèƒ½å¾…åˆ¶ä½œ')">
                        <div class="gameplay-icon">ğŸ‘¥</div>
                        <div class="gameplay-title">å¿ƒè…¹åŸ¹å…»</div>
                        <div style="font-size: 0.8rem; color: #666;">(å¾…åˆ¶ä½œ)</div>
                    </div>
                    <div class="gameplay-card" onclick="openGameModule('family')">
                        <div class="gameplay-icon">ğŸ </div>
                        <div class="gameplay-title">å®¶æ—è”ç»œ</div>
                        <div style="font-size: 0.8rem; color: #666;">å®¶ä¹¦ã€ç´¢è¦é“¶ä¸¤</div>
                    </div>
                    <div class="gameplay-card locked" id="btn-banquet" onclick="openBanquet()">
                        <div class="gameplay-icon">ğŸ®</div>
                        <div class="gameplay-title">å®«å»·å®´ä¼š</div>
                        <div style="font-size: 0.8rem; color: #666;" id="banquet-status">æœªå¼€å¯ (3æœˆ/9æœˆ)</div>
                    </div>
                    <div class="gameplay-card" onclick="openChildrenSystem()">
                        <div class="gameplay-icon">ğŸ‘¶</div>
                        <div class="gameplay-title">çš‡å—£æŠšè‚²</div>
                        <div style="font-size: 0.8rem; color: #666;">æ•™å¯¼ã€æ¸¸ç©ã€è”å§»</div>
                    </div>
                    <div class="gameplay-card locked" onclick="showToast('åŠŸèƒ½å¾…åˆ¶ä½œ')">
                        <div class="gameplay-icon">ğŸšª</div>
                        <div class="gameplay-title">å‡ºå®«</div>
                        <div style="font-size: 0.8rem; color: #666;">(å¾…åˆ¶ä½œ)</div>
                    </div>
                </div>

                <div style="margin-top: 15px; padding: 10px; background: rgba(255,255,255,0.5); border-radius: 4px; font-size: 0.85rem; color: #555; line-height: 1.6;">
                    <strong>ç©æ³•è¯´æ˜ï¼š</strong><br>
                    1. <strong>æš—å®³é™·å®³</strong>ï¼šéœ€é«˜å¿ƒæœºã€‚é€ è°£å¯é™åœ£å® ï¼›ä¸‹æ¯’å¯è‡´ç—…/æ¯å®¹/æ­»äº¡ï¼›å·«è›Šè‡´æ­»ç‡é«˜ä½†é£é™©æå¤§ã€‚è‹¥è¢«æŸ¥å‡ºæˆ–è¢«é«˜ä½å«”å¦ƒåå‡»ï¼Œåæœä¸¥é‡ã€‚ç‚¹å‡»å«”å¦ƒå¯æŸ¥çœ‹å¥½æ„Ÿåº¦ã€‚<br>
                    2. <strong>æ‹‰æ‹¢ç»“ç›Ÿ</strong>ï¼šæ¶ˆè€—é“¶ä¸¤æå‡å¥½æ„Ÿã€‚å¥½æ„Ÿé«˜å¯ç»“ç›Ÿï¼Œç›Ÿå‹åœ¨å®«æ–—ä¸­å¯èƒ½æä¾›å¸®åŠ©ã€‚<br>
                    3. <strong>çš‡å—£æŠšè‚²</strong>ï¼šåŸ¹å…»å­å—£å±æ€§ï¼Œæˆå¹´åå¯è”å§»ã€‚<br>
                    4. <strong>å®¶æ—è”ç»œ</strong>ï¼šè·å–é“¶ä¸¤æ”¯æŒã€‚<br>
                    5. <strong>å‡ºå®«/å¿ƒè…¹</strong>ï¼šåŠŸèƒ½å¼€å‘ä¸­ï¼Œæ•¬è¯·æœŸå¾…ã€‚
                </div>

                <div style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.6); border-radius: 8px; border: 1px solid var(--secondary-color);">
                    <h3 style="margin-top: 0;">å½“å‰å±€åŠ¿</h3>
                    <div id="faction-info" style="font-size: 0.9rem; line-height: 1.6;">
                        <p>æš‚æ— ç»“ç›Ÿï¼Œå­¤ç«‹æ— æ´ã€‚</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 5. è®¾ç½®ç•Œé¢ -->
        <div id="page-settings" class="page">
            <div class="panel">
                <h1>è®¾ç½®</h1>
                
                <div class="settings-section">
                    <h3>API é…ç½®</h3>
                    <div class="form-group">
                        <label class="form-label">API åœ°å€ (URL)</label>
                        <input type="text" id="api-url" placeholder="ä¾‹å¦‚: https://api.openai.com/v1" value="https://api.openai.com/v1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">API å¯†é’¥ (Key)</label>
                        <input type="password" id="api-key" placeholder="sk-...">
                    </div>
                    <div style="display: flex; gap: 10px; align-items: flex-end;">
                        <div style="flex: 1;">
                            <label class="form-label">é€‰æ‹©æ¨¡å‹</label>
                            <select id="model-select" style="margin-bottom: 0;">
                                <option value="gpt-3.5-turbo">gpt-3.5-turbo (é»˜è®¤)</option>
                            </select>
                        </div>
                        <button class="btn" onclick="fetchModels()">è¿æ¥å¹¶è·å–æ¨¡å‹</button>
                    </div>
                    <div style="margin-top: 15px; text-align: right;">
                        <button class="btn" onclick="saveSettings()">ä¿å­˜é…ç½®</button>
                    </div>
                </div>

                <div class="settings-section">
                    <h3>å­˜æ¡£ç®¡ç†</h3>
                    <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                        <button class="btn btn-secondary" id="mode-save" onclick="toggleSaveMode('save')">ä¿å­˜è¿›åº¦</button>
                        <button class="btn btn-secondary" id="mode-load" onclick="toggleSaveMode('load')">è¯»å–è¿›åº¦</button>
                    </div>
                    <div id="save-slots-container" class="save-slots">
                        <!-- åŠ¨æ€ç”Ÿæˆ6ä¸ªå­˜æ¡£ä½ -->
                    </div>
                </div>
                
                <div style="text-align: center;">
                    <button class="btn" style="background-color: #666;" onclick="resetGame()">é‡ç½®æ¸¸æˆ</button>
                </div>
            </div>
        </div>
    </div>

    <div id="nav-bar">
        <div class="nav-item active" onclick="switchPage('create')">å…¥å®«</div>
        <div class="nav-item" onclick="switchPage('map')">åœ°å›¾</div>
        <div class="nav-item" onclick="switchPage('profile')">æ¡£æ¡ˆ</div>
        <div class="nav-item" onclick="switchPage('gameplay')">ç©æ³•</div>
        <div class="nav-item" onclick="switchPage('settings')">è®¾ç½®</div>
    </div>

    <script>
        // ... (ä¿ç•™ä¹‹å‰çš„å¸¸é‡å®šä¹‰) ...
        // å§“æ°åº“ï¼ˆå«å¤å§“ï¼‰
        const SURNAMES = [
            "èµµ", "é’±", "å­™", "æ", "å‘¨", "å´", "éƒ‘", "ç‹", "å†¯", "é™ˆ", "è¤š", "å«", "è’‹", "æ²ˆ", "éŸ©", "æ¨", "æœ±", "ç§¦", "å°¤", "è®¸",
            "ä½•", "å•", "æ–½", "å¼ ", "å­”", "æ›¹", "ä¸¥", "å", "é‡‘", "é­", "é™¶", "å§œ", "æˆš", "è°¢", "é‚¹", "å–»", "æŸ", "æ°´", "çª¦", "ç« ",
            "äº‘", "è‹", "æ½˜", "è‘›", "å¥š", "èŒƒ", "å½­", "éƒ", "é²", "éŸ¦", "æ˜Œ", "é©¬", "è‹—", "å‡¤", "èŠ±", "æ–¹", "ä¿", "ä»»", "è¢", "æŸ³",
            "æ¬§é˜³", "å¤ªå²", "ç«¯æœ¨", "ä¸Šå®˜", "å¸é©¬", "ä¸œæ–¹", "ç‹¬å­¤", "å—å®«", "ä¸‡ä¿Ÿ", "é—»äºº", "å¤ä¾¯", "è¯¸è‘›", "å°‰è¿Ÿ", "å…¬ç¾Š", "èµ«è¿", "æ¾¹å°", "çš‡ç”«", "å®—æ”¿", "æ¿®é˜³", "å…¬å†¶",
            "å¤ªå”", "ç”³å± ", "å…¬å­™", "æ…•å®¹", "ä»²å­™", "é’Ÿç¦»", "é•¿å­™", "å®‡æ–‡", "å¸å¾’", "é²œäº", "å¸ç©º", "é—¾ä¸˜", "å­è½¦", "äº“å®˜", "å¸å¯‡", "å·«é©¬", "å…¬è¥¿", "é¢›å­™", "å£¤é©·", "å…¬è‰¯",
            "æ¼†é›•", "ä¹æ­£", "å®°çˆ¶", "è°·æ¢", "æ‹“è·‹", "å¤¹è°·", "è½©è¾•", "ä»¤ç‹", "æ®µå¹²", "ç™¾é‡Œ", "å‘¼å»¶", "ä¸œéƒ­", "å—é—¨", "ç¾ŠèˆŒ", "å¾®ç”Ÿ", "å…¬æˆ·", "å…¬ç‰", "å…¬ä»ª", "æ¢ä¸˜", "å…¬ä»²"
        ];
        
        // å¥³æ€§å•å­—å
        const FEMALE_NAMES_SINGLE = [
            "å¨Ÿ", "è‹±", "å", "æ…§", "å·§", "ç¾", "å¨œ", "é™", "æ·‘", "æƒ ", "ç ", "ç¿ ", "é›…", "èŠ", "ç‰", "è", "çº¢", "å¨¥", "ç²", "èŠ¬",
            "èŠ³", "ç‡•", "å½©", "æ˜¥", "èŠ", "å…°", "å‡¤", "æ´", "æ¢…", "ç³", "ç´ ", "äº‘", "è²", "çœŸ", "ç¯", "é›ª", "è£", "çˆ±", "å¦¹", "éœ",
            "é¦™", "æœˆ", "èº", "åª›", "è‰³", "ç‘", "å‡¡", "ä½³", "å˜‰", "ç¼", "å‹¤", "ç", "è´", "è‰", "æ¡‚", "å¨£", "å¶", "ç’§", "ç’", "å¨…",
            "ç¦", "æ™¶", "å¦", "èŒœ", "ç§‹", "çŠ", "è", "é”¦", "é»›", "é’", "å€©", "å©·", "å§£", "å©‰", "å¨´", "ç‘¾", "é¢–", "éœ²", "ç‘¶", "æ€¡",
            "å©µ", "é›", "è““", "çº¨", "ä»ª", "è·", "ä¸¹", "è“‰", "çœ‰", "å›", "ç´", "è•Š", "è–‡", "è", "æ¢¦", "å²š", "è‹‘", "å©•", "é¦¨", "ç‘—",
            "ç°", "éŸµ", "è", "å›­", "è‰º", "å’", "å¿", "èª", "æ¾œ", "çº¯", "æ¯“", "æ‚¦", "æ˜­", "å†°", "çˆ½", "ç¬", "èŒ—", "ç¾½", "å¸Œ", "å®",
            "æ¬£", "é£˜", "è‚²", "æ»¢", "é¦¥", "ç­ ", "æŸ”", "ç«¹", "éœ­", "å‡", "æ™“", "æ¬¢", "éœ„", "æ«", "èŠ¸", "è²", "å¯’", "ä¼Š", "äºš", "å®œ",
            "å¯", "å§¬", "èˆ’", "å½±", "è”", "æ", "æ€", "ä¸½", "ç§€", "å¨Ÿ", "è‹±", "å", "æ…§", "å·§", "ç¾", "å¨œ", "é™", "æ·‘", "æƒ ", "ç "
        ];

        // å¥³æ€§åŒå­—å
        const FEMALE_NAMES_DOUBLE = [
            "å©‰å„¿", "ç‰ç¯", "é£ç‡•", "è‹¥å…°", "ç†™å‡¤", "å¸ˆå¸ˆ", "åœ†åœ†", "å°å®›", "çº¢ç‰", "è«æ„", "æ–‡å›", "å¦‚æ˜¯", "é¦™å›", "æ¸…ç…§", "æ˜“å®‰", "å¾½å› ", "æ·‘çœŸ", "è–›æ¶›", "èºèº", "é‡‡è",
            "ç‰è‰¯", "é›ªèŠ¹", "é›¨æ¾„", "è‹¥è™š", "æ¸…æ‰¬", "è¯­å«£", "æœ¨å©‰", "çµçŠ", "ç›ˆç›ˆ", "åŒåŒ", "ç´«å«£", "ç¢§ç‘¶", "è¯­è¶", "å½©è¶", "æ™“æ¢¦", "æ¢¦è¶", "å¿†æ¢…", "è®¿ç´", "é–æŸ", "å¤œè•¾",
            "å†°å¤", "æ¢¦æ¾", "ä¹¦é›ª", "ä¹æ«", "å¿µè–‡", "é–é›", "å¯»æ˜¥", "æ¨å±±", "ä»å¯’", "å¿†é¦™", "è§…æ³¢", "é™æ›¼", "å‡¡æ—‹", "ä»¥äº¦", "å¿µéœ²", "èŠ·è•¾", "åƒå…°", "æ–°æ³¢", "ä»£çœŸ", "æ–°è•¾",
            "é›ç‰", "å†·å‰", "ç´«å±±", "åƒç´", "æ¨å¤©", "å‚²èŠ™", "ç›¼å±±", "æ€€è¶", "å†°å…°", "å±±æŸ", "ç¿ è±", "é—®æ—‹", "ç™½æ˜“", "é—®ç­ ", "å¦‚éœœ", "åŠèŠ¹", "ä¸¹ç", "å†°å½¤", "äº¦å¯’", "ä¹‹æŸ”",
            "å¯„ç‘¶", "å†°éœ²", "å®›å„¿", "ç»¿çœŸ", "ç›¼å„¿", "æ™“éœœ", "ç¢§å‡¡", "å¤è¡", "æ›¼é¦™", "è‹¥çƒŸ", "åŠæ¢¦", "é›…ç»¿", "å†°è“", "çµæ§", "å¹³å®‰", "ä¹¦ç¿ ", "ç¿ é£", "ä»£äº‘", "æ¢¦æ›¼", "å¹¼ç¿ "
        ];
        
        // ç”·æ€§å•å­—å
        const MALE_NAMES_SINGLE = [
            "ä¼Ÿ", "åˆš", "å‹‡", "æ¯…", "ä¿Š", "å³°", "å¼º", "å†›", "å¹³", "ä¿", "ä¸œ", "æ–‡", "è¾‰", "åŠ›", "æ˜", "æ°¸", "å¥", "ä¸–", "å¹¿", "å¿—",
            "ä¹‰", "å…´", "è‰¯", "æµ·", "å±±", "ä»", "æ³¢", "å®", "è´µ", "ç¦", "ç”Ÿ", "é¾™", "å…ƒ", "å…¨", "å›½", "èƒœ", "å­¦", "ç¥¥", "æ‰", "å‘",
            "æ­¦", "æ–°", "åˆ©", "æ¸…", "é£", "å½¬", "å¯Œ", "é¡º", "ä¿¡", "å­", "æ°", "æ¶›", "æ˜Œ", "æˆ", "åº·", "æ˜Ÿ", "å…‰", "å¤©", "è¾¾", "å®‰",
            "å²©", "ä¸­", "èŒ‚", "è¿›", "æ—", "æœ‰", "åš", "å’Œ", "å½ª", "åš", "è¯š", "å…ˆ", "æ•¬", "éœ‡", "æŒ¯", "å£®", "ä¼š", "æ€", "ç¾¤", "è±ª",
            "å¿ƒ", "é‚¦", "æ‰¿", "ä¹", "ç»", "åŠŸ", "æ¾", "å–„", "åš", "åº†", "ç£Š", "æ°‘", "å‹", "è£•", "æ²³", "å“²", "æ±Ÿ", "è¶…", "æµ©", "äº®",
            "æ”¿", "è°¦", "äº¨", "å¥‡", "å›º", "ä¹‹", "è½®", "ç¿°", "æœ—", "ä¼¯", "å®", "è¨€", "è‹¥", "é¸£", "æœ‹", "æ–Œ", "æ¢", "æ ‹", "ç»´", "å¯",
            "å…‹", "ä¼¦", "ç¿”", "æ—­", "é¹", "æ³½", "æ™¨", "è¾°", "å£«", "ä»¥", "å»º", "å®¶", "è‡´", "æ ‘", "ç‚", "å¾·", "è¡Œ", "æ—¶", "æ³°", "ç››"
        ];

        // ç”·æ€§åŒå­—å
        const MALE_NAMES_DOUBLE = [
            "å»ºå›½", "å¿—å¼º", "æ–‡åš", "å¤©å®‡", "æµ©ç„¶", "å­è½©", "æµ©å®‡", "é›¨æ³½", "è‡´è¿œ", "å¼˜æ–‡", "å“²ç€š", "å®‡å½¤", "å®‡èˆª", "å®‡è½©", "å®‡è±ª", "å®‡æ–‡", "å®‡æ¶µ", "å®‡æ°", "å®‡è¾°", "å®‡ç†™",
            "å˜‰æ‡¿", "ç…œåŸ", "æ‡¿è½©", "çƒ¨ä¼Ÿ", "è‹‘åš", "ä¼Ÿæ³½", "ç† å½¤", "é¸¿ç…Š", "åšæ¶›", "çƒ¨éœ–", "çƒ¨å", "ç…œç¥º", "æ™ºå®¸", "æ­£è±ª", "æ˜Šç„¶", "æ˜æ°", "ç«‹è¯š", "ç«‹è½©", "ç«‹è¾‰", "å³»ç†™",
            "å¼˜æ–‡", "å“²ç€š", "å®‡å½¤", "å®‡èˆª", "å®‡è½©", "å®‡è±ª", "å®‡æ–‡", "å®‡æ¶µ", "å®‡æ°", "å®‡è¾°", "å®‡ç†™", "å˜‰æ‡¿", "ç…œåŸ", "æ‡¿è½©", "çƒ¨ä¼Ÿ", "è‹‘åš", "ä¼Ÿæ³½", "ç† å½¤", "é¸¿ç…Š", "åšæ¶›",
            "çƒ¨éœ–", "çƒ¨å", "ç…œç¥º", "æ™ºå®¸", "æ­£è±ª", "æ˜Šç„¶", "æ˜æ°", "ç«‹è¯š", "ç«‹è½©", "ç«‹è¾‰", "å³»ç†™", "å¼˜æ–‡", "å“²ç€š", "å®‡å½¤", "å®‡èˆª", "å®‡è½©", "å®‡è±ª", "å®‡æ–‡", "å®‡æ¶µ", "å®‡æ°",
            "å®‡è¾°", "å®‡ç†™", "å˜‰æ‡¿", "ç…œåŸ", "æ‡¿è½©", "çƒ¨ä¼Ÿ", "è‹‘åš", "ä¼Ÿæ³½", "ç† å½¤", "é¸¿ç…Š", "åšæ¶›", "çƒ¨éœ–", "çƒ¨å", "ç…œç¥º", "æ™ºå®¸", "æ­£è±ª", "æ˜Šç„¶", "æ˜æ°", "ç«‹è¯š", "ç«‹è½©"
        ];
        
        const OFFICIAL_TITLES = {
            1: ["å¤ªå¸ˆ", "å¤ªå‚…", "å¤ªä¿", "å¤§å­¦å£«", "é¢†ä¾å«å†…å¤§è‡£", "æŒéŠ®ä»ªå«äº‹å¤§è‡£", "å¤§å°†å†›", "éƒ½ç»Ÿ", "æç£", "å°šä¹¦ä»¤", "ä¸­ä¹¦ä»¤", "åŒä¸­ä¹¦é—¨ä¸‹å¹³ç« äº‹", "æ¢å¯†ä½¿", "å·¦å³ä¸ç›¸", "å°‘å¸ˆ", "å°‘å‚…", "å°‘ä¿", "å¤ªå­å¤ªå¸ˆ", "å¤ªå­å¤ªå‚…", "å¤ªå­å¤ªä¿"],
            2: ["ååŠå¤§å­¦å£«", "å„éƒ¨é™¢å°šä¹¦", "éƒ½å¯Ÿé™¢å·¦éƒ½å¾¡å²", "æ€»ç£", "å‰¯éƒ½ç»Ÿ", "æ€»å…µ", "å¤ªå­å°‘å¸ˆ", "å¤ªå­å°‘å‚…", "å¤ªå­å°‘ä¿", "å¤§ç†å¯ºå¿", "å¤ªå¸¸å¯ºå¿", "å…‰ç¦„å¯ºå¿", "å¤ªä»†å¯ºå¿", "é¸¿èƒªå¯ºå¿", "å„çœå·¡æŠš", "å¸ƒæ”¿ä½¿", "éŠ®ä»ªä½¿", "ä¾éƒ", "å†…é˜å­¦å£«", "ç¿°æ—é™¢æŒé™¢å­¦å£«"],
            3: ["å„éƒ¨é™¢å·¦å³ä¾éƒ", "éƒ½å¯Ÿé™¢å·¦å³å‰¯éƒ½å¾¡å²", "é€šæ”¿ä½¿", "å¤§ç†å¯ºå°‘å¿", "å¤ªå¸¸å¯ºå°‘å¿", "å¤ªä»†å¯ºå°‘å¿", "å…‰ç¦„å¯ºå°‘å¿", "é¸¿èƒªå¯ºå°‘å¿", "å®—äººåºœåºœä¸", "æŒ‰å¯Ÿä½¿", "å„çœæå­¦ä½¿", "åŸå®ˆå°‰", "å‚å°†", "æŒ‡æŒ¥ä½¿", "é•¿å²", "é¡ºå¤©åºœå°¹", "å¥‰å¤©åºœå°¹", "å¤ªåŒ»é™¢é™¢ä½¿", "è©¹äº‹åºœè©¹äº‹", "å·¦å³æ˜¥åŠåº¶å­"],
            4: ["é€šæ”¿ä½¿å¸å‰¯ä½¿", "å¤§ç†å¯ºå¯ºä¸", "å¤ªå¸¸å¯ºå¯ºä¸", "å¤ªä»†å¯ºå¯ºä¸", "å„çœé“å‘˜", "çŸ¥åºœ", "éƒ½å¸", "æŒ‡æŒ¥åŒçŸ¥", "å®£æ…°ä½¿", "ç¿°æ—é™¢ä¾è¯»å­¦å£«", "ç¿°æ—é™¢ä¾è®²å­¦å£«", "å›½å­ç›‘ç¥­é…’", "å†…é˜ä¾è¯»å­¦å£«", "ä½é¢†", "æ¸¸å‡»", "ç®¡å¸¦", "å¤ªåŒ»é™¢é™¢åˆ¤", "é’¦å¤©ç›‘ç›‘æ­£", "ä¸Šé©·é™¢å¿", "æ­¦å¤‡é™¢å¿"],
            5: ["å„éƒ¨é™¢éƒä¸­", "å„çœçŸ¥å·", "åŒçŸ¥", "å®ˆå¤‡", "åƒæˆ·", "å®£æŠšä½¿", "ç¿°æ—é™¢ä¾è¯»", "ç¿°æ—é™¢ä¾è®²", "å›½å­ç›‘å¸ä¸š", "å†…é˜ä¾è¯»", "ç»™äº‹ä¸­", "ç›‘å¯Ÿå¾¡å²", "å®—äººåºœç†äº‹å®˜", "æ­¥å†›æ ¡", "é˜²å¾¡", "é’¦å¤©ç›‘ç›‘å‰¯", "å¤ªåŒ»é™¢å¾¡åŒ»", "ç»‡é€ ", "ç›è¿ä½¿", "å…³å·®"],
            6: ["å„éƒ¨é™¢å‘˜å¤–éƒ", "å„çœé€šåˆ¤", "çŸ¥å¿", "åƒæ€»", "ç™¾æˆ·", "å®‰æŠšä½¿", "ç¿°æ—é™¢ä¿®æ’°", "å›½å­ç›‘ç›‘ä¸", "å†…é˜ä¸­ä¹¦", "ä¸»äº‹", "ç»å†", "ç†é—®", "å·¥éƒ¨æ‰€æ­£", "å…µéƒ¨æ‰€æ­£", "å¤ªåŒ»é™¢åç›®", "é’¦å¤©ç›‘äº”å®˜æ­£", "åƒ§å½•å¸å·¦å³å–„ä¸–", "é“å½•å¸å·¦å³æ­£ä¸€", "é¸¿èƒªå¯ºä¸»ç°¿", "å…‰ç¦„å¯ºç½²æ­£"],
            7: ["å„éƒ¨é™¢ä¸»äº‹", "å„çœå¿ä¸", "æŠŠæ€»", "é•¿å®˜å¸", "ç¿°æ—é™¢ç¼–ä¿®", "å›½å­ç›‘åšå£«", "å›½å­ç›‘åŠ©æ•™", "å¤ªå¸¸å¯ºåšå£«", "ä¸­ä¹¦ç§‘ä¸­ä¹¦", "è¡Œäººå¸è¡Œäºº", "é’¦å¤©ç›‘çµå°éƒ", "å¤ªåŒ»é™¢åŒ»å£«", "ç››äº¬æ¸¸ç‰§å‰¯å°‰", "ä¸ƒå“ç¬”å¸–å¼", "ä¸ƒå“å…¸ä»ª", "ä¿¡ç‚®å®˜", "é—¨åƒæ€»", "è¥åƒæ€»", "å«åƒæ€»", "å®‰æŠšå¸å‰¯ä½¿"],
            8: ["å„éƒ¨é™¢å¸åŠ¡", "å„çœæ•™è°•", "è®­å¯¼", "å¤–å§”åƒæ€»", "ä¿®èŒéƒ", "ç¿°æ—é™¢æ£€è®¨", "å›½å­ç›‘å­¦æ­£", "å›½å­ç›‘å­¦å½•", "å¤ªå¸¸å¯ºåå¾‹éƒ", "é’¦å¤©ç›‘æŒšå£¶æ­£", "å¤ªåŒ»é™¢åŒ»å‘˜", "å…«å“ç¬”å¸–å¼", "å…«å“å…¸ä»ª", "ç›è¿å¸çŸ¥äº‹", "ç›è¯¾å¸å¤§ä½¿", "ç›å¼•æ‰¹éªŒæ‰€å¤§ä½¿", "æŒ‰å¯Ÿå¸çŸ¥äº‹", "åºœçŸ¥äº‹", "å¿ä¸»ç°¿", "é¸¿èƒªå¯ºé¸£èµ"],
            9: ["å„éƒ¨é™¢æ£€æ ¡", "å„çœå·¡æ£€", "å…¸å²", "é©¿ä¸", "å¤–å§”æŠŠæ€»", "ç™»ä»•éƒ", "ç¿°æ—é™¢ä¾è¯", "å›½å­ç›‘å…¸ç°¿", "å¤ªå¸¸å¯ºèµç¤¼éƒ", "é’¦å¤©ç›‘ç›‘å€™", "å¤ªåŒ»é™¢åŒ»ç”Ÿ", "ä¹å“ç¬”å¸–å¼", "ä¹å“å…¸ä»ª", "åˆ‘éƒ¨å¸ç‹±", "åºœç…§ç£¨", "åŒçŸ¥ç…§ç£¨", "é€šåˆ¤ç…§ç£¨", "å¿ç‹±å…¸", "ç¨è¯¾å¸å¤§ä½¿", "ä»“å¤§ä½¿"]
        };

        const OTHER_BACKGROUNDS = ["å¹³æ°‘ç™¾å§“", "å•†è´¾å·¨å¯Œ", "æ²¡è½è´µæ—", "æ±Ÿæ¹–ä¾ å®¢", "ä¹¦é¦™é—¨ç¬¬", "åŒ»æœ¯ä¸–å®¶", "æˆæ›²åä¼¶", "è¾¹ç–†ç‰§æ°‘", "éšå£«é«˜äºº", "ç½ªè‡£ä¹‹å"];

        const EMPEROR_TRAITS = ["å‹¤æ”¿", "é£æµ", "æš´è™", "ä»åš", "å¤šç–‘", "æ·±æƒ…", "å†·é…·", "å¹³åº¸", "ç¿æ™º", "æ˜åº¸"];
        const EMPEROR_LOOKS = ["è‹±ä¿Šæ½‡æ´’", "å¨æ­¦éœ¸æ°”", "æ¸©æ–‡å°”é›…", "é¢å¦‚å† ç‰", "æ°”å®‡è½©æ˜‚", "ç›¸è²Œå¹³å¹³", "ç•¥æ˜¾å‘ç¦", "çœ¼ç¥çŠ€åˆ©", "å’Œè”¼å¯äº²", "ä¸æ€’è‡ªå¨"];
        const EMPEROR_LIKES = ["å®¹è²Œ", "æ‰æƒ…", "ä½“è´¨", "äº¤é™…", "å¿ƒæœº", "ç¦è¿"];
        const EMPEROR_AVATARS = {
            "è‹±ä¿Šæ½‡æ´’": "https://iili.io/fwAnYEx.md.jpg",
            "å¨æ­¦éœ¸æ°”": "https://iili.io/fwATce2.md.jpg",
            "æ¸©æ–‡å°”é›…": "https://iili.io/fwACRlp.md.jpg",
            "é¢å¦‚å† ç‰": "https://iili.io/fwAu7CF.md.jpg",
            "æ°”å®‡è½©æ˜‚": "https://iili.io/fwAauTv.md.jpg",
            "ç›¸è²Œå¹³å¹³": "https://iili.io/fwAcOVp.md.jpg",
            "ç•¥æ˜¾å‘ç¦": "https://iili.io/fwAWJvS.md.jpg",
            "çœ¼ç¥çŠ€åˆ©": "https://iili.io/fwABXAF.md.jpg",
            "å’Œè”¼å¯äº²": "https://iili.io/fwAWwPf.md.jpg",
            "ä¸æ€’è‡ªå¨": "https://iili.io/fwAqY1p.md.jpg"
        };

        const CONCUBINE_TRAITS = ["æ¸©æŸ”", "æ³¼è¾£", "å¿ƒæœº", "å•çº¯", "å‚²å¨‡", "å†·æ¼ ", "æ´»æ³¼", "å¿§éƒ", "è´¤æƒ ", "è…¹é»‘", "ç»¿èŒ¶", "ç›´çˆ½", "èƒ†å°", "å‹‡æ•¢", "è´ªè´¢", "æ¸…é«˜", "åŠ¿åˆ©", "å¿ è¯š", "å–„å¦’", "å®½å®¹"];

        // --- åœ°å›¾æ•°æ® ---
        const LOCATIONS = {
            "å…»å¿ƒæ®¿": {
                x: 600, y: 300,
                icon: "é¾™",
                special: true,
                desc: "çš‡ä¸Šæ—¥å¸¸èµ·å±…ä¸æ‰¹é˜…å¥æŠ˜ä¹‹æ‰€ï¼Œé‡‘ç¢§è¾‰ç…Œï¼Œå®ˆå«æ£®ä¸¥ã€‚",
                bg: "https://iili.io/fwxrGHv.md.jpg", 
                subLocations: ["ä¸œæš–é˜", "è¥¿æš–é˜", "å¾¡ä¹¦æˆ¿", "å¯æ®¿"],
                actions: [
                    { name: "è§è§çš‡ä¸Š", icon: "ğŸ‘‘", desc: "å°è¯•æ±‚è§åœ£é¢œï¼Œéœ€çœ‹è¿æ°”ä¸åœ£å® ã€‚" },
                    { name: "é€æ±¤ç¾¹", icon: "ğŸ²", desc: "äº²æ‰‹ç†¬åˆ¶çš„æ±¤ç¾¹ï¼Œå¸Œæœ›èƒ½åšå›ä¸€ç¬‘ã€‚" },
                    { name: "æ‰“æ¢æ¶ˆæ¯", icon: "ğŸ‘‚", desc: "å‘å¾¡å‰ä¾å«æˆ–å…¬å…¬æ‰“å¬çš‡ä¸Šå¿ƒæƒ…ã€‚" }
                ]
            },
            "å‚¨ç§€å®«": {
                x: 360, y: 240,
                icon: "å¦ƒ",
                special: false,
                desc: "åå®«å¦ƒå«”å±…ä½ä¹‹åœ°ï¼Œåº­é™¢æ·±æ·±ï¼ŒèŠ±æœ¨æ‰¶ç–ã€‚",
                bg: "https://iili.io/fwxw9mg.md.jpg",
                subLocations: ["å¯å®«", "æ­£æ®¿", "ä¸œé…æ®¿", "è¥¿é…æ®¿", "åé™¢"],
                actions: [
                    { name: "æ‹œè®¿å¦ƒå«”", icon: "ğŸ¤", desc: "ä¸å…¶ä»–å§å¦¹è”ç»œæ„Ÿæƒ…ï¼Œæˆ–æš—ä¸­è¾ƒåŠ²ã€‚" },
                    { name: "æ²æµ´æ¢³å¦†", icon: "ğŸ’„", desc: "ã€å¯å®«ã€‘æ•´ç†ä»ªå®¹ï¼Œæå‡å®¹è²Œã€‚", type: "train", stat: "charm" },
                    { name: "ç ”è¯»è¯—ä¹¦", icon: "ğŸ“š", desc: "ã€å¯å®«ã€‘è…¹æœ‰è¯—ä¹¦æ°”è‡ªåï¼Œæå‡æ‰æƒ…ã€‚", type: "train", stat: "intelligence" },
                    { name: "å¼ºèº«å¥ä½“", icon: "ğŸ§˜â€â™€ï¸", desc: "ã€å¯å®«ã€‘é”»ç‚¼èº«ä½“ï¼Œæå‡ä½“è´¨ã€‚", type: "train", stat: "health" },
                    { name: "ç»ƒä¹ ç¤¼ä»ª", icon: "ğŸ’ƒ", desc: "ã€å¯å®«ã€‘ä¸¾æ­¢ç«¯åº„ï¼Œæå‡äº¤é™…ã€‚", type: "train", stat: "social" },
                    { name: "é™åå†¥æƒ³", icon: "ğŸ§ ", desc: "ã€å¯å®«ã€‘æ²‰æ€å¾€äº‹ï¼Œæå‡å¿ƒæœºã€‚", type: "train", stat: "scheme" },
                    { name: "ç¥ˆç¦è¯µç»", icon: "ğŸ™", desc: "ã€å¯å®«ã€‘è¯šå¿ƒç¥ˆç¥·ï¼Œæå‡ç¦è¿ã€‚", type: "train", stat: "luck" }
                ]
            },
            "å¾¡èŠ±å›­": {
                x: 840, y: 240,
                icon: "èŠ±",
                special: false,
                desc: "å®«ä¸­èµèŠ±æ¸¸ç©ä¹‹æ‰€ï¼Œå¥‡çŸ³ç½—å¸ƒï¼Œä½³æœ¨è‘±èŒã€‚",
                bg: "https://iili.io/fwxwAB4.md.jpg",
                subLocations: ["åƒç§‹äº­", "å †ç§€å±±", "æµ®ç¢§äº­", "ç»›é›ªè½©"],
                actions: [
                    { name: "èµèŠ±æ•£å¿ƒ", icon: "ğŸŒ¸", desc: "æ¼«æ­¥èŠ±ä¸›ï¼Œæ”¾æ¾å¿ƒæƒ…ï¼Œå¶é‡è´µäººã€‚" },
                    { name: "ç»ƒä¹ æ‰è‰º", icon: "ğŸµ", desc: "åœ¨æ­¤æŠšç´å¹ç®«ï¼Œæå‡æ‰æƒ…ã€‚" },
                    { name: "æ•æ‰è´è¶", icon: "ğŸ¦‹", desc: "ç«¥å¿ƒæœªæ³¯ï¼Œæˆ–è®¸èƒ½å¾—åˆ°æ„å¤–æ”¶è·ã€‚" }
                ]
            },
            "å¤ªåŒ»é™¢": {
                x: 960, y: 480,
                icon: "åŒ»",
                special: false,
                desc: "å®«ä¸­è¯Šæ²»ç–¾ç—…ã€è°ƒé…è¯ç†ä¹‹æ‰€ï¼Œè¯é¦™å¼¥æ¼«ã€‚",
                bg: "https://iili.io/fwxveLu.md.jpg",
                subLocations: ["è¯Šå®¤", "è¯æˆ¿", "å¤ªåŒ»å€¼æˆ¿", "æ™’è¯åœº"],
                actions: [
                    { name: "è¯·å¹³å®‰è„‰", icon: "ğŸ©º", desc: "æ£€æŸ¥èº«ä½“ï¼Œç¡®ä¿å®‰åº·ã€‚" },
                    { name: "å­¦ä¹ åŒ»ç†", icon: "ğŸ“š", desc: "ç ”è¯»åŒ»ä¹¦ï¼Œæå‡åŒ»æœ¯ï¼ˆå¿ƒæœºï¼‰ã€‚" },
                    { name: "è´­ä¹°è¯æ", icon: "ğŸ’Š", desc: "èŠ±è´¹é“¶ä¸¤è´­ä¹°æ»‹è¡¥æˆ–...å…¶ä»–è¯æã€‚" }
                ]
            },
            "å†…åŠ¡åºœ": {
                x: 240, y: 600,
                icon: "åŠ¡",
                special: false,
                desc: "æŒç®¡å®«å»·ç”¨åº¦ã€åº“æˆ¿é’±ç²®ä¹‹æ‰€ï¼Œæ²¹æ°´é¢‡ä¸°ã€‚",
                bg: "https://iili.io/fwxU81s.md.jpg",
                subLocations: ["å¹¿å‚¨å¸", "ä¼šè®¡å¸", "æŒä»ªå¸", "éƒ½è™å¸"],
                actions: [
                    { name: "æ‰“ç‚¹å…¬å…¬", icon: "ğŸ", desc: "èŠ±è´¹é“¶ä¸¤ï¼Œæ¢å–æ–¹ä¾¿æˆ–æ¶ˆæ¯ã€‚" },
                    { name: "ç½®åŠè¡Œå¤´", icon: "ğŸ‘—", desc: "è´­ä¹°æ–°çš„è¡£è£³é¦–é¥°ã€‚" },
                    { name: "è´­ä¹°å¢å­•ä¸¸", icon: "ğŸ’Š", desc: "å”®ä»·500ä¸¤ï¼Œæå‡5%å­•ç‡ã€‚" }
                ]
            },
            "å†·å®«": {
                x: 240, y: 750, /* æ”¾åœ¨å†…åŠ¡åºœä¸‹é¢ */
                icon: "å†·",
                special: false,
                desc: "å¤±å® å¦ƒå«”å¹½ç¦ä¹‹æ‰€ï¼Œæ®‹å£æ–­å£ï¼Œå‡„å‡‰è§ç‘Ÿã€‚",
                bg: "https://iili.io/fwxmGJS.md.jpg",
                subLocations: ["ç ´è´¥åº­é™¢", "å¹½æš—åæ®¿", "æ¯äº•"],
                actions: [
                    { name: "æ¢æœ›æ•…äºº", icon: "ğŸ‘»", desc: "çœ‹æœ›è¢«æ‰“å…¥å†·å®«çš„æ—§è¯†ã€‚" },
                    { name: "æ„Ÿæ‚Ÿäººç”Ÿ", icon: "ğŸ§˜", desc: "åœ¨æ­¤é™æ€ï¼Œæˆ–è®¸èƒ½çœ‹é€ä¸–æ€ç‚å‡‰ã€‚" },
                    { name: "æœå¯»é—ç‰©", icon: "ğŸ”", desc: "å¯»æ‰¾å‰äººç•™ä¸‹çš„ç§˜å¯†æˆ–å®ç‰©ã€‚" }
                ]
            },
            "æ…ˆå®å®«": {
                x: 240, y: 360,
                icon: "å",
                special: true,
                desc: "å¤ªåé¢å…»å¤©å¹´ä¹‹æ‰€ï¼Œåº„ä¸¥è‚ƒç©†ï¼Œä½›é¦™ç¼­ç»•ã€‚",
                bg: "https://images.unsplash.com/photo-1599571234909-29ed5d1321d6?q=80&w=2070&auto=format&fit=crop",
                subLocations: ["æ­£æ®¿", "ä½›å ‚", "èŠ±å›­"],
                actions: [
                    { name: "ç»™å¤ªåè¯·å®‰", icon: "ğŸ™‡â€â™€ï¸", desc: "æ¯æ—¥æ™¨æ˜å®šçœï¼Œä»¥è¡¨å­å¿ƒã€‚" },
                    { name: "æŠ„å†™ä½›ç»", icon: "âœï¸", desc: "ä¸ºå¤ªåç¥ˆç¦ï¼Œæå‡åå£°ã€‚" },
                    { name: "é™ªå¤ªåèŠå¤©", icon: "ğŸ—£ï¸", desc: "è®¨å¤ªåæ¬¢å¿ƒï¼Œæˆ–è®¸èƒ½å¾—èµèµã€‚" }
                ]
            },
            "å¾¡è†³æˆ¿": {
                x: 960, y: 660,
                icon: "è†³",
                special: false,
                desc: "è´Ÿè´£å®«ä¸­é¥®é£Ÿä¹‹æ‰€ï¼ŒçƒŸç«æ°”åè¶³ï¼Œé¦™é£˜åé‡Œã€‚",
                bg: "https://iili.io/fwxQsjf.md.jpg",
                subLocations: ["ä¸»å¨æˆ¿", "ç‚¹å¿ƒå±€", "é£Ÿæåº“"],
                actions: [
                    { name: "å­¦ä¹ å¨è‰º", icon: "ğŸ³", desc: "å‘å¾¡å¨è¯·æ•™ï¼Œæå‡å¨è‰ºã€‚" },
                    { name: "å·åƒ", icon: "ğŸ˜‹", desc: "å°å°åˆšå‡ºé”…çš„å¾¡è†³ï¼Œå°å¿ƒè¢«å‘ç°ã€‚" },
                    { name: "å®šåˆ¶èœè‚´", icon: "ğŸ§¾", desc: "èŠ±è´¹é“¶ä¸¤ï¼ŒæŒ‡å®šä»Šæ™šçš„èœè‰²ã€‚" }
                ]
            },
            "ç•…éŸ³é˜": {
                x: 960, y: 300,
                icon: "æˆ",
                special: false,
                desc: "å®«ä¸­çœ‹æˆå¬æ›²ä¹‹æ‰€ï¼Œä¸‰å±‚å¤§æˆå°ï¼Œæ°”åŠ¿æ¢å®ã€‚",
                bg: "https://iili.io/fwxsGZQ.md.jpg",
                subLocations: ["å¤§æˆå°", "åå°", "çœ‹å°"],
                actions: [
                    { name: "å¬æˆ", icon: "ğŸ­", desc: "æ¬£èµæˆæ›²ï¼Œé™¶å†¶æƒ…æ“ã€‚" },
                    { name: "ç»“äº¤åä¼¶", icon: "ğŸ¤", desc: "ä¸æˆå­ç»“äº¤ï¼Œæˆ–è®¸èƒ½æ‰“å¬åˆ°å®«å¤–æ¶ˆæ¯ã€‚" }
                ]
            },
            "æ•¬äº‹æˆ¿": {
                x: 480, y: 660,
                icon: "æ•¬",
                special: false,
                desc: "ç®¡ç†å¤ªç›‘ä¸å®«å¥³åå†Œï¼Œä»¥åŠ...ä¾å¯äº‹å®œã€‚",
                bg: "https://iili.io/fwxPkUg.md.jpg",
                subLocations: ["æ¡£æ¡ˆå®¤", "å€¼æˆ¿"],
                actions: [
                    { name: "æŸ¥è¯¢ç»¿å¤´ç‰Œ", icon: "ğŸ“‹", desc: "çœ‹çœ‹ä»Šæ™šçš‡ä¸Šç¿»äº†è°çš„ç‰Œå­ã€‚" },
                    { name: "è´¿èµ‚æ€»ç®¡", icon: "ğŸ’°", desc: "å¢åŠ è‡ªå·±çš„ç‰Œå­è¢«ç¿»åˆ°çš„å‡ ç‡ã€‚" }
                ]
            }
        };

        // éšæœºäº‹ä»¶åº“
        const RANDOM_EVENTS = [
            { text: "ä½ åœ¨å¾¡èŠ±å›­æ•£æ­¥ï¼Œå¿½è§ä¸€åªäº”å½©æ–‘æ–“çš„é¹¦é¹‰é£è¿‡ï¼Œå¿ƒæƒ…å¤§å¥½ã€‚", effect: { mood: 5 } },
            { text: "è·¯è¿‡é•¿è¡—ï¼Œå¬è§ä¸¤ä¸ªå°å®«å¥³åœ¨çªƒçªƒç§è¯­ï¼Œä¼¼ä¹åœ¨è®®è®ºæŸä½å¨˜å¨˜çš„ç§˜é—»ã€‚", effect: { scheme: 2 } },
            { text: "ä»Šæ—¥é˜³å…‰æ˜åªšï¼Œä½ è§‰å¾—ç¥æ¸…æ°”çˆ½ï¼Œä»¿ä½›èº«ä½“ä¹Ÿè½»ç›ˆäº†è®¸å¤šã€‚", effect: { health: 2 } },
            { text: "å†…åŠ¡åºœé€æ¥äº†ä¸€ç›†åè´µçš„å…°èŠ±ï¼Œè¯´æ˜¯çš‡ä¸Šç‰¹æ„èµèµçš„ã€‚", effect: { favor: 3 } },
            { text: "ä½ åœ¨å®«é“ä¸Šæ¡åˆ°äº†ä¸€å—ç²¾è‡´çš„æ‰‹å¸•ï¼Œä¸çŸ¥æ˜¯è°é—è½çš„ã€‚", effect: { luck: 2 } },
            { text: "å¶é‡å¤ªåŒ»é™¢çš„å­¦å¾’ï¼Œé¡ºæ‰‹æŒ‡ç‚¹äº†ä»–å‡ å¥ã€‚", effect: { intelligence: 2 } },
            { text: "ä»Šæ—¥å¾¡è†³æˆ¿é€æ¥çš„ç‚¹å¿ƒæ ¼å¤–ç²¾è‡´ï¼Œä½ èµäº†é€é¤çš„å°å¤ªç›‘ã€‚", effect: { money: -5, social: 2 } },
            { text: "åœ¨æ¹–è¾¹å–‚é±¼ï¼Œä¸å°å¿ƒæ¹¿äº†é‹è¢œã€‚", effect: { health: -1 } },
            { text: "å¬é—»å‰æœæœ‰å¤§è‡£è¿›è°ï¼Œçš‡ä¸Šå¿ƒæƒ…ä¼¼ä¹ä¸ä½³ã€‚", effect: {} },
            { text: "å®«ä¸­æ–°æ’äº†ä¸€å‡ºæˆï¼Œå„å®«å¨˜å¨˜éƒ½åœ¨è®®è®ºã€‚", effect: { social: 1 } },
            { text: "ä½ çš„ç›Ÿå‹æ´¾äººé€æ¥äº†ä¸€äº›å®¶ä¹¡ç‰¹äº§ï¼ŒèŠè¡¨å¿ƒæ„ã€‚", effect: { mood: 3 } },
            { text: "å¬é—»æŸä½ç›Ÿå‹åœ¨çš‡ä¸Šé¢å‰å¤¸èµäº†ä½ ã€‚", effect: { favor: 2 } }
        ];

        function initMap() {
            const mapContent = document.getElementById('map-content');
            // æ¸…é™¤æ—§ç‚¹ï¼ˆé™¤äº†èƒŒæ™¯å›¾å’Œè£…é¥°ï¼‰
            const existingPoints = mapContent.querySelectorAll('.map-point');
            existingPoints.forEach(p => p.remove());

            for (const [name, data] of Object.entries(LOCATIONS)) {
                const el = document.createElement('div');
                el.className = 'map-point';
                el.style.left = data.x + 'px';
                el.style.top = data.y + 'px';
                el.innerHTML = `
                    <div class="point-icon ${data.special ? 'special' : ''}">${data.icon}</div>
                    <div class="point-label">${name}</div>
                `;
                el.onclick = () => openLocationDetail(name);
                mapContent.appendChild(el);
            }
            
            // ç®€å•çš„æ‹–æ‹½é€»è¾‘
            const viewport = document.getElementById('map-viewport');
            let isDown = false;
            let startX, startY, scrollLeft, scrollTop;

            viewport.addEventListener('mousedown', (e) => {
                isDown = true;
                startX = e.pageX - viewport.offsetLeft;
                startY = e.pageY - viewport.offsetTop;
                scrollLeft = viewport.scrollLeft;
                scrollTop = viewport.scrollTop;
            });

            viewport.addEventListener('mouseleave', () => { isDown = false; });
            viewport.addEventListener('mouseup', () => { isDown = false; });

            viewport.addEventListener('mousemove', (e) => {
                if (!isDown) return;
                e.preventDefault();
                const x = e.pageX - viewport.offsetLeft;
                const y = e.pageY - viewport.offsetTop;
                const walkX = (x - startX) * 1.5; 
                const walkY = (y - startY) * 1.5;
                viewport.scrollLeft = scrollLeft - walkX;
                viewport.scrollTop = scrollTop - walkY;
            });

            // è§¦æ‘¸äº‹ä»¶æ”¯æŒ (æ‰‹æœºç«¯)
            viewport.addEventListener('touchstart', (e) => {
                isDown = true;
                startX = e.touches[0].pageX - viewport.offsetLeft;
                startY = e.touches[0].pageY - viewport.offsetTop;
                scrollLeft = viewport.scrollLeft;
                scrollTop = viewport.scrollTop;
            }, { passive: false });

            viewport.addEventListener('touchend', () => { isDown = false; });

            viewport.addEventListener('touchmove', (e) => {
                if (!isDown) return;
                if (e.cancelable) e.preventDefault(); // é˜²æ­¢è§¦å‘é»˜è®¤æ»šåŠ¨
                const x = e.touches[0].pageX - viewport.offsetLeft;
                const y = e.touches[0].pageY - viewport.offsetTop;
                const walkX = (x - startX) * 1.5; 
                const walkY = (y - startY) * 1.5;
                viewport.scrollLeft = scrollLeft - walkX;
                viewport.scrollTop = scrollTop - walkY;
            }, { passive: false });
            
            // åˆå§‹å±…ä¸­
            viewport.scrollLeft = (1200 - viewport.clientWidth) / 2;
            viewport.scrollTop = (900 - viewport.clientHeight) / 2;
        }

        // åœ£å® é˜¶æ®µ (0-300, æ¯30ä¸€çº§)
        const FAVOR_STAGES = [
            "é»˜é»˜æ— é—»", "ç•¥æœ‰è–„å", "ç®€åœ¨å¸å¿ƒ", "çœ·é¡¾æœ‰åŠ ", "æ©å® ä¼˜æ¸¥", 
            "ç››å® ä¸è¡°", "ä¸“æˆ¿ä¹‹å® ", "å† ç»åå®«", "æ¤’æˆ¿ç‹¬å® ", "ç”Ÿæ­»ç›¸è®¸"
        ];

        function getFavorStage(favor) {
            const idx = Math.min(Math.floor(favor / 30), FAVOR_STAGES.length - 1);
            return FAVOR_STAGES[idx];
        }

        // ä¹å“äºŒåä¸ƒçº§ä½ä»½è¡¨ (æ›´æ–°æ™‹å‡æ•°å€¼ï¼šæ¯é¡¹å±æ€§éƒ½éœ€è¾¾æ ‡)
        const RANKS = [
            { name: "çš‡å", level: "è¶…å“", condition: "æ¯ä»ªå¤©ä¸‹ï¼Œç»Ÿæ‘„å…­å®«", limit: 1, minFavor: 280, minStat: 900 },
            { name: "çš‡è´µå¦ƒ", level: "æ­£ä¸€å“", condition: "ä½åŒå‰¯åï¼Œåç†å…­å®«", limit: 1, minFavor: 250, minStat: 850 },
            { name: "è´µå¦ƒ", level: "ä»ä¸€å“", condition: "èµ„å†æ·±åšï¼Œåœ£å® ä¼˜æ¸¥", limit: 2, minFavor: 220, minStat: 800 },
            { name: "è´¤å¦ƒ", level: "åº¶ä¸€å“", condition: "å››å¦ƒä¹‹é¦–ï¼Œå¾·æ‰å…¼å¤‡", limit: 1, minFavor: 190, minStat: 750 },
            { name: "è‰¯å¦ƒ", level: "åº¶ä¸€å“", condition: "å››å¦ƒä¹‹æ¬¡ï¼Œæ¸©è‰¯æ­ä¿­", limit: 1, minFavor: 190, minStat: 750 },
            { name: "æ·‘å¦ƒ", level: "åº¶ä¸€å“", condition: "å››å¦ƒä¹‹ä¸‰ï¼Œæ·‘æ…å…¶èº«", limit: 1, minFavor: 190, minStat: 750 },
            { name: "å¾·å¦ƒ", level: "åº¶ä¸€å“", condition: "å››å¦ƒä¹‹æœ«ï¼Œå¾·è¡Œå‡ºä¼—", limit: 1, minFavor: 190, minStat: 750 },
            
            { name: "å¦ƒ", level: "æ­£äºŒå“", condition: "è¯è‚²çš‡å—£ï¼Œæˆ–å®¶ä¸–æ˜¾èµ«", limit: 6, minFavor: 160, minStat: 700 },
            { name: "æ˜­ä»ª", level: "ä»äºŒå“", condition: "ä¹å«”ä¹‹é¦–ï¼Œç¤¼ä»ªå¨´ç†Ÿ", limit: 9, minFavor: 140, minStat: 650 },
            { name: "ä¿®ä»ª", level: "åº¶äºŒå“", condition: "è¾…ä½å®«åŠ¡ï¼Œæªå°½èŒå®ˆ", limit: 9, minFavor: 140, minStat: 650 },
            
            { name: "å……ä»ª", level: "æ­£ä¸‰å“", condition: "å……å®åå®«ï¼Œä»ªæ€ä¸‡æ–¹", limit: 9, minFavor: 120, minStat: 600 },
            { name: "å©•å¦¤", level: "ä»ä¸‰å“", condition: "æ‰æƒ…å‡ºä¼—ï¼Œé¢‡å¾—åœ£å¿ƒ", limit: 9, minFavor: 120, minStat: 600 },
            { name: "å®¹å", level: "åº¶ä¸‰å“", condition: "å®¹è²Œç«¯åº„ï¼Œä¸¾æ­¢å¾—ä½“", limit: 9, minFavor: 120, minStat: 600 },
            
            { name: "å©‰ä»ª", level: "æ­£å››å“", condition: "æ¸©å©‰å¯äººï¼Œæ€§æƒ…æŸ”é¡º", limit: 9, minFavor: 100, minStat: 550 },
            { name: "èŠ³ä»ª", level: "ä»å››å“", condition: "èŠ³åæ­£èŒ‚ï¼Œé’æ˜¥é“ä¸½", limit: 9, minFavor: 100, minStat: 550 },
            { name: "èŠ¬ä»ª", level: "åº¶å››å“", condition: "èŠ¬èŠ³åè‰³ï¼Œåˆéœ²å¤´è§’", limit: 9, minFavor: 100, minStat: 550 },
            
            { name: "å«”", level: "æ­£äº”å“", condition: "ä¸€å®«ä¸»ä½ï¼Œåœ£å® ç¨³å®š", limit: 12, minFavor: 80, minStat: 500 },
            { name: "å°ä»ª", level: "ä»äº”å“", condition: "å°å¿ƒè°¨æ…ï¼Œä¾å¥‰å‹¤å‹‰", limit: 12, minFavor: 80, minStat: 500 },
            { name: "å°åª›", level: "åº¶äº”å“", condition: "å°å®¶ç¢§ç‰ï¼Œæƒ¹äººæ€œçˆ±", limit: 12, minFavor: 80, minStat: 500 },
            
            { name: "è´µäºº", level: "æ­£å…­å“", condition: "åˆå¾—æ©å¹¸ï¼Œç•¥æœ‰è–„å", limit: 9999, minFavor: 60, minStat: 400 },
            { name: "æ‰äºº", level: "ä»å…­å“", condition: "æ‰è‰ºåŒç»ï¼Œä»¥æ‰ä¾å›", limit: 9999, minFavor: 50, minStat: 350 },
            { name: "ç¾äºº", level: "åº¶å…­å“", condition: "è²Œç¾å¦‚èŠ±ï¼Œä»¥è‰²ä¾å›", limit: 9999, minFavor: 40, minStat: 300 },
            
            { name: "å¸¸åœ¨", level: "æ­£ä¸ƒå“", condition: "å…¥å®«å·²ä¹…ï¼Œå®‰åˆ†å®ˆå·±", limit: 9999, minFavor: 30, minStat: 250 },
            { name: "å¨˜å­", level: "ä»ä¸ƒå“", condition: "åˆé€‰å…¥å®«ï¼Œä½ä»½ä½å¾®", limit: 9999, minFavor: 20, minStat: 200 },
            { name: "èˆæ¶“", level: "åº¶ä¸ƒå“", condition: "èˆå§¿æ›¼å¦™ï¼Œèº«è½»å¦‚ç‡•", limit: 9999, minFavor: 10, minStat: 150 },
            
            { name: "é€‰ä¾", level: "æ­£å…«å“", condition: "éšä¾å·¦å³ï¼Œå°å¿ƒä¼ºå€™", limit: 9999, minFavor: 5, minStat: 100 },
            { name: "é‡‡å¥³", level: "ä»å…«å“", condition: "é‡‡é€‰å…¥å®«ï¼Œåœ°ä½å‘ä¸‹", limit: 9999, minFavor: 0, minStat: 80 },
            { name: "å¾¡å¥³", level: "åº¶å…«å“", condition: "å¾¡å‰ä¾å¥‰ï¼Œå¶å¾—ä¸´å¹¸", limit: 9999, minFavor: 0, minStat: 60 },
            
            { name: "ç­”åº”", level: "æ­£ä¹å“", condition: "åˆå…¥å®«é—±ï¼Œéœ€å¾—åœ£å¿ƒ", limit: 9999, minFavor: 0, minStat: 40 },
            { name: "æ›´è¡£", level: "ä»ä¹å“", condition: "æ›´è¡£ä¾å¥‰ï¼Œåœ°ä½å‘å¾®", limit: 9999, minFavor: 0, minStat: 20 },
            { name: "å®˜å¥³å­", level: "åº¶ä¹å“", condition: "å®«å¥³å‡ºèº«ï¼Œèº«ä»½æœ€ä½", limit: 9999, minFavor: 0, minStat: 0 }
        ];

        // å±æ€§æè¿°è¯åº“ (æ‰©å……è‡³1000ç‚¹ï¼Œæ¯50ç‚¹ä¸€çº§ï¼Œå…±20çº§)
        const ATTR_DESCS = {
            charm: ["è²Œè‹¥æ— ç›", "å§¿è‰²å¹³å¹³", "æ¸…ç§€å¯äºº", "äº­äº­ç‰ç«‹", "çœ‰ç›®å¦‚ç”»", "ç»ä»£ä½³äºº", "å€¾å›½å€¾åŸ", "æƒŠä¸ºå¤©äºº", "è‰³ç»åƒå¤", "ä¹å¤©ç„å¥³", "ä¸‡ä¸–æµèŠ³", "æ²‰é±¼è½é›", "é—­æœˆç¾èŠ±", "å›½è‰²å¤©é¦™", "å¤©ç”Ÿä¸½è´¨", "ä»™å§¿ç‰è‰²", "é£åç»ä»£", "ä¸¾ä¸–æ— åŒ", "è‰³å† ç¾¤èŠ³", "å…­å®«ç²‰é»›æ— é¢œè‰²"],
            intelligence: ["èƒ¸æ— ç‚¹å¢¨", "è¯†æ–‡æ–­å­—", "ç•¥é€šæ–‡å¢¨", "çŸ¥ä¹¦è¾¾ç†", "æ‰æ€æ•æ·", "åšå¤é€šä»Š", "æ‰é«˜å…«æ–—", "å­¦å¯Œäº”è½¦", "æ»¡è…¹ç»çº¶", "ç»ä¸–æ‰å¥³", "æ–‡æ›²æ˜Ÿä¸‹å‡¡", "ä¸ƒæ­¥æˆè¯—", "å‡ºå£æˆç« ", "å¦™ç¬”ç”ŸèŠ±", "å’çµ®ä¹‹æ‰", "å…°å¿ƒè•™è´¨", "å†°é›ªèªæ˜", "é€šæ™“å¤ä»Š", "å­¦è´¯ä¸­è¥¿", "æ— æ‰€ä¸çŸ¥"],
            health: ["å¼±ä¸ç¦é£", "ä½“å¼±å¤šç—…", "å¹³æ— å¥‡", "èº«å¼ºä½“å£®", "ç²¾åŠ›å……æ²›", "æ°”è¡€æ—ºç››", "é’¢ç­‹é“éª¨", "ç™¾ç—…ä¸ä¾µ", "å¯¿æ¯”å—å±±", "é•¿ç”Ÿä¸è€", "é‡‘åˆšä¸å", "é¾™ç²¾è™çŒ›", "åŠ›å¤§æ— ç©·", "èº«è½»å¦‚ç‡•", "å¥æ­¥å¦‚é£", "ç¥é‡‡å¥•å¥•", "å®¹å…‰ç„•å‘", "ç”Ÿé¾™æ´»è™", "é“œçš®é“éª¨", "ä¸‡å¯¿æ— ç–†"],
            social: ["å­¤èŠ³è‡ªèµ", "ä¸å–„è¨€è¾", "å¹³æ˜“è¿‘äºº", "å·¦å³é€¢æº", "å…«é¢ç²ç‘", "é•¿è¢–å–„èˆ", "ä¼—æ˜Ÿæ§æœˆ", "ä¸€å‘¼ç™¾åº”", "æƒå€¾æœé‡", "ä¸‡æ°‘å½’å¿ƒ", "å¤©ä¸‹å½’å¿ƒ", "é—¨åº­è‹¥å¸‚", "é«˜æœ‹æ»¡åº§", "äº¤æ¸¸å¹¿é˜”", "äººè§äººçˆ±", "èŠ±è§èŠ±å¼€", "é­…åŠ›å››å°„", "é¢†è¢–ç¾¤ä¼¦", "å¾·é«˜æœ›é‡", "æ¯ä»ªå¤©ä¸‹"],
            scheme: ["å•çº¯æ— çŸ¥", "ä¸è°™ä¸–äº‹", "ç•¥æœ‰å¿ƒæœº", "è°¨å°æ…å¾®", "æ­¥æ­¥ä¸ºè¥", "å¿ƒç»†å¦‚å‘", "åŸåºœææ·±", "è€è°‹æ·±ç®—", "ç®—æ— é—ç­–", "è¿ç­¹å¸·å¹„", "å¥³ä¸­è¯¸è‘›", "æœºå…³ç®—å°½", "ç¬‘é‡Œè—åˆ€", "å£èœœè…¹å‰‘", "å€Ÿåˆ€æ€äºº", "æŒ‡é¹¿ä¸ºé©¬", "ç¿»äº‘è¦†é›¨", "åªæ‰‹é®å¤©", "æƒå€¾å¤©ä¸‹", "ç¥æœºå¦™ç®—"],
            luck: ["éœ‰è¿å½“å¤´", "æ—¶è¿ä¸æµ", "å¹³å¹³æ·¡æ·¡", "å°æœ‰è¿æ°”", "å‰æ˜Ÿé«˜ç…§", "é¸¿è¿å½“å¤´", "å¤©é€‰ä¹‹å¥³", "é”¦é²¤é™„ä½“", "æ°”è¿ä¹‹å­", "ä¸‡äº‹å¦‚æ„", "å¿ƒæƒ³äº‹æˆ", "ç¦æ˜Ÿé«˜ç…§", "æ´ªç¦é½å¤©", "ç´«æ°”ä¸œæ¥", "ç‘æ°”åƒæ¡", "é€¢å‡¶åŒ–å‰", "é‡éš¾æˆç¥¥", "å¤©å®˜èµç¦", "ç¦å¦‚ä¸œæµ·", "å¤©å‘½æ‰€å½’"]
        };

        // å…¨å±€çŠ¶æ€
        const STATE = {
            currentPage: 'create',
            time: {
                year: 1,
                month: 1,
                period: 0, // 0:ä¸Šæ—¬, 1:ä¸­æ—¬, 2:ä¸‹æ—¬
                timeSlot: 0 // 0:æ™¨é—´, 1:ä¸Šåˆ, 2:åˆæ—¶, 3:ä¸‹åˆ, 4:æ™šä¸Š, 5:æ·±å¤œ
            },
            player: {
                name: '',
                age: 16,
                background: '', 
                bgType: '', 
                bgLevel: 0, 
                isDi: false, 
                stats: { charm: 0, intelligence: 0, health: 0, social: 0, scheme: 0, luck: 0 },
                favor: 0,
                money: 100,
                rank: 29, // å¯¹åº” RANKS ç´¢å¼•ï¼Œåˆå§‹ä¸ºå®˜å¥³å­(29)
                avatarSeed: Date.now(),
                customAvatar: null, 
                logs: [],
                pregnancyRate: 5, // åˆå§‹5%
                isPregnant: false,
                pregnancyMonth: 0,
                pregnancyEnabled: true,
                children: [],
                servants: [], // å¿ƒè…¹
                alliances: [], // ç›Ÿå‹ID
                enemies: [], // æ•ŒäººID
                inColdPalace: false, // æ˜¯å¦è¢«æ‰“å…¥å†·å®«
                coldPalaceProgress: 0 // å†·å®«å¤å‡ºè¿›åº¦
            },
            emperor: {
                name: '',
                age: 25,
                trait: '',
                look: '',
                like: '',
                avatar: null,
                location: 'å¾¡ä¹¦æˆ¿', // é»˜è®¤ä½ç½®
                state: 'æ‰¹é˜…å¥æŠ˜',
                mood: 0 // ä¾å¯å…´è‡´
            },
            shiqin: {
                chances: 4,
                history: []
            },
            concubines: [],
            investigation: [], // å¾…æŸ¥æ¡ˆä»¶ {type, victim, culprit, blameTarget, month}
            settings: {
                apiUrl: 'https://api.openai.com/v1',
                apiKey: '',
                model: 'gpt-3.5-turbo'
            },
            saveMode: 'save',
            lastMonthExpense: 0
        };

        // --- AI æ¥å£å°è£… ---
        async function callAI(systemPrompt, userPrompt, jsonMode = false) {
            if (!STATE.settings.apiKey) {
                throw new Error("è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½® API Key");
            }

            const messages = [
                { role: "system", content: systemPrompt },
                { role: "user", content: userPrompt }
            ];

            const body = {
                model: STATE.settings.model,
                messages: messages,
                temperature: 0.7
            };

            if (jsonMode) {
                body.response_format = { type: "json_object" };
            }

            try {
                const response = await fetch(STATE.settings.apiUrl + '/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${STATE.settings.apiKey}`
                    },
                    body: JSON.stringify(body)
                });

                if (!response.ok) {
                    throw new Error(`APIè¯·æ±‚å¤±è´¥: ${response.status}`);
                }

                const data = await response.json();
                return data.choices[0].message.content;
            } catch (e) {
                console.error("AI Call Error:", e);
                throw e;
            }
        }

        const PERIODS = ["ä¸Šæ—¬", "ä¸­æ—¬", "ä¸‹æ—¬"];
        const TIME_SLOTS = ["æ™¨é—´", "ä¸Šåˆ", "åˆæ—¶", "ä¸‹åˆ", "æ™šä¸Š", "æ·±å¤œ"];

        // åˆå§‹åŒ–
        window.onload = function() {
            // å°è¯•ä¼˜åŒ–åœ°å€æ æ˜¾ç¤º
            try {
                history.replaceState(null, "å®«æ–—æ¨¡æ‹Ÿå™¨", "#å®«æ–—æ¨¡æ‹Ÿå™¨");
            } catch(e) {
                console.log("åœ°å€æ ä¿®æ”¹å¤±è´¥", e);
            }

            loadSettings();
            generateRandomAvatar();
            // generateRandomName(); // ä¸å†è‡ªåŠ¨ç”Ÿæˆï¼Œè®©ç”¨æˆ·é€‰æ‹©
            renderSaveSlots();
            
            const inputs = document.querySelectorAll('.stat-input');
            inputs.forEach(input => {
                input.addEventListener('input', updatePoints); // æ”¹ä¸ºinputäº‹ä»¶å®æ—¶å“åº”
            });
            updatePoints(); // åˆå§‹åŒ–æè¿°

            initMap(); // åˆå§‹åŒ–åœ°å›¾
        };

        // é¡µé¢åˆ‡æ¢
        function switchPage(pageId) {
            if (!STATE.player.name && pageId !== 'create' && pageId !== 'settings') {
                showToast('è¯·å…ˆå®Œæˆå…¥å®«èº«ä»½åˆ›å»º');
                return;
            }

            // å†·å®«ç¦è¶³é™åˆ¶
            if (STATE.player.inColdPalace && pageId !== 'map' && pageId !== 'settings') {
                showToast('ä½ å·²è¢«æ‰“å…¥å†·å®«ï¼Œç¦è¶³åœ¨æ­¤ï¼Œæ— æ³•å‰å¾€å…¶ä»–åœ°æ–¹ã€‚');
                return;
            }

            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            document.getElementById('page-' + pageId).classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            const navIndex = ['create', 'map', 'profile', 'gameplay', 'settings'].indexOf(pageId);
            if (navIndex !== -1) {
                document.querySelectorAll('.nav-item')[navIndex].classList.add('active');
            }

            STATE.currentPage = pageId;

            if (pageId === 'profile') {
                updateProfileView();
            }
            
            updateTimeUI();
        }

        function updateTimeUI() {
            const timeStr = `ç¬¬${STATE.time.year}å¹´ ${STATE.time.month}æœˆ ${PERIODS[STATE.time.period]} ${TIME_SLOTS[STATE.time.timeSlot]}`;
            
            const currentPointIndex = STATE.time.period * 6 + STATE.time.timeSlot;
            const pointsLeft = 18 - currentPointIndex;
            
            const html = `
                <div class="time-bar">
                    <div class="time-info">ğŸ“… ${timeStr}</div>
                    <div class="action-points">âš¡ å‰©ä½™è¡ŒåŠ¨ç‚¹: ${pointsLeft}/18</div>
                </div>
            `;

            // æ’å…¥åˆ°åœ°å›¾ã€æ¡£æ¡ˆã€ç©æ³•çš„panelé¡¶éƒ¨
            ['page-map', 'page-profile', 'page-gameplay'].forEach(id => {
                const page = document.getElementById(id);
                const panel = page.querySelector('.panel');
                if (panel) {
                    const existingBar = panel.querySelector('.time-bar');
                    if (existingBar) existingBar.remove();
                    panel.insertAdjacentHTML('afterbegin', html);
                }
            });
        }

        function advanceTime() {
            STATE.time.timeSlot++;
            
            // å¦‚æœå½“å‰æ—¶æ®µè¶…è¿‡æ·±å¤œ(5)
            if (STATE.time.timeSlot > 5) {
                // å¦‚æœä¸æ˜¯ä¸‹æ—¬ï¼Œè¿›å…¥ä¸‹ä¸€æ—¬
                if (STATE.time.period < 2) {
                    STATE.time.timeSlot = 0;
                    STATE.time.period++;
                } else {
                    // å¦‚æœæ˜¯ä¸‹æ—¬ï¼Œä¿æŒåœ¨ 6 (è¡¨ç¤ºç»“æŸçŠ¶æ€)
                    // æ­¤æ—¶ period=2, timeSlot=6
                }
            }
            
            updateEmperorLocation(); // æ›´æ–°çš‡ä¸Šä½ç½®
            updateTimeUI();
            
            // ç«‹å³è§¦å‘å¤œé—´äº‹ä»¶ï¼Œç¡®ä¿ä¸è¢«å¿½ç•¥
            if (STATE.time.timeSlot === 5) {
                checkNightEvent(); 
            }

            // éšæœºè§¦å‘å…¨å±äº‹ä»¶ (5%æ¦‚ç‡)
            if (Math.random() < 0.05) {
                triggerRandomEncounter();
            }
        }

        function triggerRandomEncounter() {
            // å†·å®«ä¸­ä¸è§¦å‘æ™®é€šéšæœºäº‹ä»¶
            if (STATE.player.inColdPalace) return;

            const events = [
                "ä½ åœ¨å¾¡èŠ±å›­æ•£æ­¥ï¼Œå¿½è§ä¸€åªäº”å½©æ–‘æ–“çš„é¹¦é¹‰é£è¿‡ï¼Œå¿ƒæƒ…å¤§å¥½ã€‚",
                "è·¯è¿‡é•¿è¡—ï¼Œå¬è§ä¸¤ä¸ªå°å®«å¥³åœ¨çªƒçªƒç§è¯­ï¼Œä¼¼ä¹åœ¨è®®è®ºæŸä½å¨˜å¨˜çš„ç§˜é—»ã€‚",
                "ä»Šæ—¥é˜³å…‰æ˜åªšï¼Œä½ è§‰å¾—ç¥æ¸…æ°”çˆ½ï¼Œä»¿ä½›èº«ä½“ä¹Ÿè½»ç›ˆäº†è®¸å¤šã€‚",
                "å†…åŠ¡åºœé€æ¥äº†ä¸€ç›†åè´µçš„å…°èŠ±ï¼Œè¯´æ˜¯çš‡ä¸Šç‰¹æ„èµèµçš„ã€‚",
                "ä½ åœ¨å®«é“ä¸Šæ¡åˆ°äº†ä¸€å—ç²¾è‡´çš„æ‰‹å¸•ï¼Œä¸çŸ¥æ˜¯è°é—è½çš„ã€‚"
            ];
            const evt = events[Math.floor(Math.random() * events.length)];
            document.getElementById('explore-title').innerText = "å¶é‡";
            document.getElementById('explore-text').innerText = evt;
            document.getElementById('explore-result-modal').style.display = 'block';
        }

        function updateEmperorLocation() {
            const slot = STATE.time.timeSlot;
            const r = Math.random();
            
            // 0:æ™¨é—´, 1:ä¸Šåˆ, 2:åˆæ—¶, 3:ä¸‹åˆ, 4:æ™šä¸Š, 5:æ·±å¤œ
            if (slot === 0) {
                STATE.emperor.location = "å¤ªå’Œæ®¿"; // ä¸Šæœ
                STATE.emperor.state = "æ—©æœ";
            } else if (slot === 1 || slot === 3) {
                // ä¸Šåˆ/ä¸‹åˆï¼šæå¤§åœ¨å¾¡ä¹¦æˆ¿
                if (r < 0.85) {
                    STATE.emperor.location = "å¾¡ä¹¦æˆ¿";
                    STATE.emperor.state = "æ‰¹é˜…å¥æŠ˜";
                } else if (r < 0.90) {
                    STATE.emperor.location = "å¾¡èŠ±å›­";
                    STATE.emperor.state = "èµèŠ±æ•£å¿ƒ";
                } else if (r < 0.95) {
                    STATE.emperor.location = "æ…ˆå®å®«";
                    STATE.emperor.state = "ç»™å¤ªåè¯·å®‰";
                } else {
                    STATE.emperor.location = "å‚¨ç§€å®«"; // éšæœºå»æŸå¦ƒå­å¤„
                    STATE.emperor.state = "æ¢æœ›å¦ƒå«”";
                }
            } else if (slot === 2) {
                // åˆæ—¶
                if (r < 0.9) {
                    STATE.emperor.location = "å…»å¿ƒæ®¿"; // åˆä¼‘
                    STATE.emperor.state = "åˆè†³/å°æ†©";
                } else {
                    STATE.emperor.location = "å¾¡èŠ±å›­";
                    STATE.emperor.state = "æ¸¸å›­";
                }
            } else if (slot === 4) {
                // æ™šä¸Šï¼šç¿»ç‰Œå­å‰
                STATE.emperor.location = "å…»å¿ƒæ®¿";
                STATE.emperor.state = "å‡†å¤‡å°±å¯";
            } else if (slot === 5) {
                // æ·±å¤œï¼šå·²ç¿»ç‰Œå­ï¼Œå¯èƒ½åœ¨å…»å¿ƒæ®¿æˆ–æŸå¦ƒå­å¤„
                // é€»è¾‘åœ¨ checkNightEvent ä¸­å¤„ç†å…·ä½“å»å‘
            }
        }

        function checkNightEvent() {
            try {
                // æ™šä¸Š(4)è½¬æ·±å¤œ(5)æ—¶è§¦å‘ç¿»ç‰Œå­
                if (STATE.time.timeSlot === 5) {
                    // ç©å®¶è¢«ç¿»ç‰Œæ¦‚ç‡ï¼šåŸºç¡€æ¦‚ç‡ + åœ£å® åŠ æˆ
                    let playerWeight = 5 + STATE.player.favor;
                    if (STATE.player.favor >= 30) playerWeight *= 1.5; 
                    
                    // å¦‚æœåœ¨å†·å®«ï¼Œæ¦‚ç‡ä¸º0
                    if (STATE.player.inColdPalace) playerWeight = 0;

                    const roll = Math.random() * 100;
                    const chance = Math.min(80, Math.max(5, playerWeight)); 
                    
                    let content = "";
                    let logContent = "";
                    let isPlayer = false;

                    if (roll < chance && !STATE.player.inColdPalace) {
                        // ç¿»åˆ°ç©å®¶
                        isPlayer = true;
                        STATE.emperor.location = "å…»å¿ƒæ®¿";
                        STATE.emperor.state = "ç­‰å¾…ä¾å¯";
                        STATE.shiqin.pending = true; // æ ‡è®°ç­‰å¾…ä¾å¯
                        
                        const type = Math.random() < 0.3 ? "æŒ‡å®šäº†" : "ç¿»åˆ°äº†";
                        content = `ğŸŒ™ æ•¬äº‹æˆ¿ä¼ æ¥æ¶ˆæ¯ï¼š<br>çš‡ä¸Šä»Šæ™š${type}æ‚¨çš„ç‰Œå­ï¼<br>è¯·å°ä¸»é€Ÿå»å…»å¿ƒæ®¿ä¾å¯ï¼Œåˆ‡å‹¿æ€ æ…¢ã€‚`;
                        logContent = `çš‡ä¸Šä»Šæ™š${type}æ‚¨çš„ç‰Œå­ã€‚`;
                    } else {
                        // ç¿»äº†åˆ«äººæˆ–ç‹¬å¯
                        if (Math.random() < 0.2) {
                            content = "ğŸŒ™ æ•¬äº‹æˆ¿ä¼ æ¥æ¶ˆæ¯ï¼š<br>çš‡ä¸Šä»Šæ™šç‹¬å¯å…»å¿ƒæ®¿ã€‚";
                            logContent = "çš‡ä¸Šä»Šæ™šç‹¬å¯å…»å¿ƒæ®¿ã€‚";
                            STATE.emperor.location = "å…»å¿ƒæ®¿";
                            STATE.emperor.state = "ç‹¬å¯";
                        } else {
                            // è¿‡æ»¤æ‰å†·å®«å’Œæ­»äº¡çš„å¦ƒå­
                            const validConcubines = STATE.concubines.filter(c => !c.dead && c.state !== 'æš´æ¯™' && c.state !== 'å†·å®«');
                            
                            let luckyOneName = "æŸä½å¦ƒå«”";
                            if (validConcubines.length > 0) {
                                const luckyOne = validConcubines[Math.floor(Math.random() * validConcubines.length)];
                                luckyOneName = luckyOne.name;
                                STATE.emperor.location = "å‚¨ç§€å®«";
                                STATE.emperor.state = `ä¸${luckyOneName}å°±å¯`;
                            } else {
                                // å®¹é”™å¤„ç†
                                STATE.emperor.location = "å…»å¿ƒæ®¿";
                                STATE.emperor.state = "ç‹¬å¯";
                            }
                            
                            content = `ğŸŒ™ æ•¬äº‹æˆ¿ä¼ æ¥æ¶ˆæ¯ï¼š<br>çš‡ä¸Šä»Šæ™šç¿»äº†<strong>${luckyOneName}</strong>çš„ç‰Œå­ã€‚`;
                            logContent = `çš‡ä¸Šä»Šæ™šç¿»äº†${luckyOneName}çš„ç‰Œå­ã€‚`;
                        }
                    }

                    // è®°å½•ç”Ÿå¹³
                    addLog(logContent);

                    // ä½¿ç”¨ä¸“ç”¨å¤œé—´å¼¹çª—
                    const modal = document.getElementById('night-modal');
                    const contentDiv = document.getElementById('night-content');
                    
                    if (modal && contentDiv) {
                        contentDiv.innerHTML = content;
                        modal.style.display = 'flex';
                        
                        // ç»‘å®šå…³é—­äº‹ä»¶
                        window.closeNightModal = function() {
                            modal.style.display = 'none';
                            if (isPlayer) {
                                showToast("è¯·å‰å¾€å…»å¿ƒæ®¿");
                            }
                        };
                    }
                }
            } catch (e) {
                console.error("å¤œé—´äº‹ä»¶è§¦å‘é”™è¯¯:", e);
                // ç¡®ä¿ä¸é˜»å¡æ¸¸æˆ
                showToast("å¤œé—´äº‹ä»¶å¼‚å¸¸ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°");
            }
        }

        function openYangXinDian() {
            const emp = STATE.emperor;
            const loc = emp.location;
            
            // åˆ¤æ–­çš‡ä¸Šæ˜¯å¦åœ¨å…»å¿ƒæ®¿èŒƒå›´å†…
            const inYangXinDian = ["å…»å¿ƒæ®¿", "å¾¡ä¹¦æˆ¿", "ä¸œæš–é˜", "è¥¿æš–é˜", "å¯æ®¿"].includes(loc);
            
            if (!inYangXinDian) {
                alert(`å…¬å…¬æ‹¦ä½äº†ä½ ï¼šâ€œçš‡ä¸Šæ­¤æ—¶ä¸åœ¨å…»å¿ƒæ®¿ï¼Œæ­£åœ¨ã€${loc}ã€‘${emp.state}ï¼Œå°ä¸»è¯·ä¸‹ä¸ªæ—¶æ®µå†æ¥å§ã€‚â€`);
                return;
            }

            // å¦‚æœæ˜¯ç­‰å¾…ä¾å¯çŠ¶æ€ï¼Œä¸”ç©å®¶æ¥äº†ï¼Œç›´æ¥è¿›å…¥ä¾å¯ç•Œé¢
            if (emp.state === "ç­‰å¾…ä¾å¯" && STATE.shiqin.pending) {
                openShiQin();
                return;
            }

            // æ˜¾ç¤ºçš‡å¸è¯¦æƒ…
            document.getElementById('emp-detail-avatar').src = emp.avatar;
            document.getElementById('emp-detail-name').innerText = emp.name;
            document.getElementById('emp-detail-age').innerText = emp.age;
            document.getElementById('emp-detail-trait').innerText = emp.trait;
            document.getElementById('emp-detail-look').innerText = emp.look;
            document.getElementById('emp-detail-like').innerText = emp.like;
            document.getElementById('emp-detail-state').innerText = emp.state;

            const interactArea = document.getElementById('emp-interaction-area');
            interactArea.innerHTML = '';

            // æ™®é€šäº’åŠ¨é€‰é¡¹
            const btn1 = document.createElement('button');
            btn1.className = 'btn btn-secondary';
            btn1.style.width = '100%';
            btn1.style.marginBottom = '10px';
            btn1.innerText = 'çº¢è¢–æ·»é¦™';
            btn1.onclick = () => interactWithEmperor('ä¼´è¯»');
            interactArea.appendChild(btn1);
            
            const btn2 = document.createElement('button');
            btn2.className = 'btn btn-secondary';
            btn2.style.width = '100%';
            btn2.innerText = 'é€ä¸Šå‚æ±¤';
            btn2.onclick = () => interactWithEmperor('é€æ±¤');
            interactArea.appendChild(btn2);

            document.getElementById('emperor-detail-modal').style.display = 'flex';
        }

        function openShiQin() {
            STATE.shiqin.pending = false; // å·²åˆ°è¾¾
            STATE.shiqin.chances = 4;
            STATE.emperor.mood = 0;
            
            document.getElementById('shiqin-mood-bar').style.width = '0%';
            document.getElementById('shiqin-mood-text').innerText = '0%';
            document.getElementById('shiqin-chances').innerText = '4';
            document.getElementById('shiqin-story').innerText = "ä»Šå¤œæœˆè‰²æœ¦èƒ§ï¼Œä½ è¢«å‡¤é¸¾æ˜¥æ©è½¦æ¥å…¥å…»å¿ƒæ®¿ã€‚çš‡ä¸Šæ­£å€šåœ¨æ¦»ä¸Šï¼Œä¼¼ä¹åœ¨ç­‰ä½ ...";
            
            document.getElementById('emperor-detail-modal').style.display = 'none';
            document.getElementById('shiqin-modal').style.display = 'flex';
        }

        // æœ¬åœ°ä¾å¯å‰§æƒ…åº“
        const LOCAL_SHIQIN_STORIES = {
            'flirt': [
                "ä½ çœ¼æ³¢æµè½¬ï¼Œå«æƒ…è„‰è„‰åœ°æ³¨è§†ç€çš‡ä¸Šã€‚çš‡ä¸Šè¢«ä½ çœ‹å¾—å¿ƒç¥è¡æ¼¾ï¼Œä¼¸æ‰‹è½»è½»åˆ®äº†åˆ®ä½ çš„é¼»å°–ï¼Œç¬‘é“ï¼šâ€œçˆ±å¦ƒä»Šæ—¥è¿™èˆ¬çœ‹ç€æœ•ï¼Œå¯æ˜¯æœ‰ä»€ä¹ˆå¿ƒäº‹ï¼Ÿâ€ä½ æŠ¿å˜´ä¸€ç¬‘ï¼Œå¹¶æœªè¨€è¯­ï¼Œåªå°†å¤´è½»è½»é åœ¨çš‡ä¸Šè‚©å¤´ï¼Œæƒ¹å¾—çš‡ä¸Šå¼€æ€€å¤§ç¬‘ã€‚",
                "ç¯ä¸‹çœ‹ç¾äººï¼Œè¶Šçœ‹è¶ŠåŠ¨äººã€‚ä½ é‚£ä¸€åŒå‰ªæ°´ç§‹ç³ä¸­æ»¡æ˜¯æ·±æƒ…ï¼Œçš‡ä¸Šä¸ä½ å¯¹è§†ç‰‡åˆ»ï¼Œä¸ç¦æ„Ÿå¹é“ï¼šâ€œçˆ±å¦ƒè¿™åŒçœ¼ç›ï¼Œå½“çœŸæ˜¯å‹¾é­‚æ‘„é­„ã€‚â€è¯´ç½¢ï¼Œä¾¿å°†ä½ æ½å…¥æ€€ä¸­ï¼Œç»†ç»†æŠŠç©ä½ çš„é’ä¸ã€‚",
                "ä½ å¾®å¾®ä¾§é¦–ï¼Œç›®å…‰å¦‚ä¸èˆ¬ç¼ ç»•åœ¨çš‡ä¸Šèº«ä¸Šã€‚çš‡ä¸Šå¯Ÿè§‰åˆ°ä½ çš„è§†çº¿ï¼Œæ”¾ä¸‹æ‰‹ä¸­çš„ä¹¦å·ï¼Œå›ä»¥æ¸©æŸ”ä¸€ç¬‘ã€‚æ­¤æ—¶æ— å£°èƒœæœ‰å£°ï¼Œæš–é˜å†…çš„æ°”æ°›é¡¿æ—¶å˜å¾—æ—–æ—èµ·æ¥ã€‚"
            ],
            'talk': [
                "ä½ ä¾ååœ¨çš‡ä¸Šèº«ä¾§ï¼Œè½»å£°ç»†è¯­åœ°è¯´èµ·å®«ä¸­è¶£äº‹ã€‚çš‡ä¸Šå¬å¾—æ´¥æ´¥æœ‰å‘³ï¼Œæ—¶è€Œç‚¹å¤´ï¼Œæ—¶è€Œå‘ç¬‘ã€‚ä½ è§çš‡ä¸Šå¿ƒæƒ…å¤§å¥½ï¼Œä¾¿åˆè¯´äº†äº›å®¶ä¹¡çš„è§é—»ï¼Œçš‡ä¸Šå¬åæ„Ÿå¹é“ï¼šâ€œæœ•ä¹…å±…æ·±å®«ï¼Œå€’æ˜¯ä¸å¦‚çˆ±å¦ƒè§å¤šè¯†å¹¿ã€‚â€",
                "ä½ æ¸©è¨€è½¯è¯­ï¼Œè¯¢é—®çš‡ä¸Šä»Šæ—¥æ”¿åŠ¡æ˜¯å¦åŠ³ç´¯ã€‚çš‡ä¸Šå¹äº†å£æ°”ï¼Œæ¡ç€ä½ çš„æ‰‹é“ï¼šâ€œå‰æœçäº‹ç¹å¤šï¼Œå”¯æœ‰åˆ°äº†çˆ±å¦ƒè¿™é‡Œï¼Œæœ•æ‰èƒ½å¾—ç‰‡åˆ»æ¸…é—²ã€‚â€ä½ æŸ”å£°å®½æ…°ï¼Œä»¤çš‡ä¸Šçœ‰å¤´æ¸æ¸èˆ’å±•ã€‚",
                "å¤œè‰²é™è°§ï¼Œä½ ä¸çš‡ä¸Šé—²è¯å®¶å¸¸ã€‚ä»è¯—è¯æ­Œèµ‹è°ˆåˆ°äººç”Ÿç†æƒ³ï¼Œçš‡ä¸ŠæƒŠè®¶äºä½ çš„è§è§£ï¼Œèµé“ï¼šâ€œçˆ±å¦ƒä¸ä»…å®¹è²Œå‡ºä¼—ï¼Œè¿™æ‰æƒ…ä¹Ÿæ˜¯åå®«å°‘æœ‰ã€‚â€"
            ],
            'serve': [
                "ä½ èµ·èº«èµ°åˆ°æ¡ˆå‰ï¼Œç´ æ‰‹ç ”å¢¨ï¼Œçº¢è¢–æ·»é¦™ã€‚çš‡ä¸Šçœ‹ç€ä½ ä¸“æ³¨çš„ä¾§è„¸ï¼Œå¿ƒä¸­ä¸€åŠ¨ï¼Œæ”¾ä¸‹æœ±ç¬”ï¼Œæ¡ä½ä½ çš„æ‰‹é“ï¼šâ€œè¿™äº›ç²—æ´»è®©ä¸‹äººåšä¾¿æ˜¯ï¼Œæœ•æ€èˆå¾—ç´¯ç€çˆ±å¦ƒã€‚â€",
                "ä½ ä¸ºçš‡ä¸Šæ–Ÿäº†ä¸€æ¯çƒ­èŒ¶ï¼ŒåŒæ‰‹å¥‰ä¸Šã€‚çš‡ä¸Šæ¥è¿‡èŒ¶ç›ï¼ŒæŒ‡å°–è½»è½»åˆ’è¿‡ä½ çš„æ‰‹èƒŒï¼Œç¬‘é“ï¼šâ€œçˆ±å¦ƒäº²æ‰‹æ³¡çš„èŒ¶ï¼Œæœç„¶æ¯”å¾¡è†³æˆ¿çš„è¦é¦™é†‡è®¸å¤šã€‚â€",
                "è§çš‡ä¸Šæ‰¹é˜…å¥æŠ˜ç•¥æ˜¾ç–²æ€ï¼Œä½ ä¸Šå‰è½»è½»ä¸ºä»–æ•´ç†æ¡ˆä¸Šçš„æ–‡ä¹¦ã€‚çš‡ä¸Šé¡ºåŠ¿æ‹‰ä½ä½ çš„æ‰‹ï¼Œå°†ä½ å¸¦å…¥æ€€ä¸­ï¼Œä½å£°é“ï¼šâ€œæœ‰çˆ±å¦ƒçº¢è¢–æ·»é¦™ï¼Œæœ•ä¾¿æ˜¯å†å¿™äº›ä¹Ÿæ— å¦¨ã€‚â€"
            ],
            'dance': [
                "ä½ èµ·èº«æ¥åˆ°æ®¿ä¸­ï¼Œéšç€å®«ä¹ç¿©ç¿©èµ·èˆã€‚é•¿è¢–å–„èˆï¼Œèº«å§¿æ›¼å¦™ï¼Œå®›å¦‚æœˆä¸‹ä»™å­ã€‚çš‡ä¸Šçœ‹å¾—å¦‚ç—´å¦‚é†‰ï¼Œå¾…ä¸€æ›²èˆæ¯•ï¼Œç«Ÿè¿˜å›ä¸è¿‡ç¥æ¥ï¼Œè¿å£°èµé“ï¼šâ€œæ­¤èˆåªåº”å¤©ä¸Šæœ‰ï¼Œäººé—´éš¾å¾—å‡ å›é—»ã€‚â€",
                "ä½ ä¸ºçš‡ä¸ŠçŒ®ä¸Šä¸€æ›²ã€ŠæƒŠé¸¿èˆã€‹ï¼Œè…°è‚¢æŸ”è½¯ï¼Œæ­¥æ­¥ç”Ÿè²ã€‚çš‡ä¸Šçœ¼ä¸­æ»¡æ˜¯æƒŠè‰³ä¹‹è‰²ï¼Œå¾…ä½ åœä¸‹æ—¶ï¼Œäº²è‡ªä¸Šå‰æ‰¶èµ·ä½ ï¼Œç¬‘é“ï¼šâ€œçˆ±å¦ƒè¿™ä¸€èˆï¼Œæœ•å¿ƒç”šæ‚¦ã€‚â€",
                "çƒ›å…‰æ‘‡æ›³ï¼Œä½ éšå…´è€Œèˆï¼Œè™½æ— ä¸ç«¹ä¼´å¥ï¼Œå´åˆ«æœ‰ä¸€ç•ªé£éŸµã€‚çš‡ä¸Šçœ‹å¾—å…´èµ·ï¼Œç«Ÿäº²è‡ªä¸ºä½ å‡»èŠ‚åŠ©å…´ã€‚ä¸€èˆç»ˆäº†ï¼Œä½ å¾®å–˜ç€æ°”é åœ¨çš‡ä¸Šæ€€ä¸­ï¼Œé¢è‹¥æ¡ƒèŠ±ã€‚"
            ],
            'massage': [
                "ä½ è§çš‡ä¸Šè‚©é¢ˆåƒµç¡¬ï¼Œä¾¿ä¸»åŠ¨ä¸Šå‰ä¸ºä»–æ¨æ‹¿æŒ‰æ‘©ã€‚ä½ åŠ›é“é€‚ä¸­ï¼Œæ‰‹æ³•å¨´ç†Ÿï¼Œçš‡ä¸Šèˆ’æœåœ°é—­ä¸Šäº†çœ¼ç›ï¼Œèµé“ï¼šâ€œçˆ±å¦ƒè¿™æ‰‹è‰ºï¼Œæ¯”å¤ªåŒ»é™¢çš„é‚£äº›è€å®¶ä¼™å¼ºå¤šäº†ã€‚â€",
                "ä½ è½»è½»æ‰æç€çš‡ä¸Šçš„å¤ªé˜³ç©´ï¼Œä¸ºä»–ç¼“è§£å¤´ç—›ã€‚çš‡ä¸Šçœ‰å¤´èˆ’å±•ï¼Œæ¡ä½ä½ çš„æ‰‹æ”¾åœ¨å”‡è¾¹äº²å»ï¼Œé“ï¼šâ€œçˆ±å¦ƒçœŸæ˜¯æœ•çš„è§£è¯­èŠ±ã€‚â€",
                "ä½ ä¸ºçš‡ä¸Šæ¶è…¿æè‚©ï¼ŒåŠ¨ä½œè½»æŸ”ã€‚çš‡ä¸Šäº«å—ç€ä½ çš„æœä¾ï¼Œæ¸æ¸æ”¾æ¾ä¸‹æ¥ï¼Œç¬‘é“ï¼šâ€œæœ‰çˆ±å¦ƒåœ¨ä¾§ï¼Œæœ•è¿™ä¸€èº«çš„ç–²ä¹éƒ½æ¶ˆæ•£äº†ã€‚â€"
            ]
        };

        async function handleShiQinAction(action) {
            if (STATE.shiqin.chances <= 0) {
                showToast("äº’åŠ¨æœºä¼šå·²ç”¨å®Œï¼Œè¯·å®‰å¯ã€‚");
                return;
            }

            const moodGain = Math.floor(Math.random() * 16) + 15; // 15-30
            STATE.emperor.mood = Math.min(100, STATE.emperor.mood + moodGain);
            STATE.shiqin.chances--;

            // æ›´æ–°UI
            document.getElementById('shiqin-mood-bar').style.width = STATE.emperor.mood + '%';
            document.getElementById('shiqin-mood-text').innerText = STATE.emperor.mood + '%';
            document.getElementById('shiqin-chances').innerText = STATE.shiqin.chances;

            // å‰§æƒ…ç”Ÿæˆé€»è¾‘
            const actionNames = {
                'flirt': 'å«æƒ…è„‰è„‰åœ°çœ‹ç€çš‡ä¸Š',
                'talk': 'ä¸çš‡ä¸Šæ¸©è¨€è½¯è¯­',
                'serve': 'ä¸ºçš‡ä¸Šç ”å¢¨æ·»é¦™',
                'dance': 'ä¸ºçš‡ä¸ŠçŒ®èˆä¸€æ›²',
                'massage': 'ä¸ºçš‡ä¸Šæ¨æ‹¿æŒ‰æ‘©'
            };
            
            document.getElementById('shiqin-story').innerText = "ï¼ˆå‰§æƒ…ç”Ÿæˆä¸­...ï¼‰";

            // ä¼˜å…ˆå°è¯•AIç”Ÿæˆï¼Œå¦‚æœå¤±è´¥æˆ–æœªé…ç½®ï¼Œåˆ™ä½¿ç”¨æœ¬åœ°åº“
            let story = "";
            
            // æ£€æŸ¥æ˜¯å¦æœ‰API Key
            if (STATE.settings.apiKey) {
                const context = {
                    player: STATE.player.name,
                    action: actionNames[action],
                    emperor: STATE.emperor,
                    currentMood: STATE.emperor.mood
                };
                const systemPrompt = "ä½ æ˜¯ä¸€ä¸ªå®«æ–—æ¸¸æˆå‰§æƒ…ç”Ÿæˆå™¨ã€‚è¯·æ ¹æ®ç©å®¶çš„äº’åŠ¨åŠ¨ä½œå’Œçš‡å¸å½“å‰çš„å…´è‡´ï¼Œç”Ÿæˆä¸€æ®µä¸å°‘äº100å­—çš„ä¾å¯äº’åŠ¨å‰§æƒ…ã€‚æå†™è¦ç»†è…»ã€å¤é£ï¼Œä½“ç°å‡ºä¸¤äººçš„äº’åŠ¨å’Œçš‡å¸çš„ååº”ã€‚";
                const userPrompt = JSON.stringify(context);

                try {
                    // è®¾ç½®è¶…æ—¶ï¼Œé˜²æ­¢ä¸€ç›´å¡ä½
                    const timeoutPromise = new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Timeout')), 5000)
                    );
                    story = await Promise.race([
                        callAI(systemPrompt, userPrompt),
                        timeoutPromise
                    ]);
                } catch (e) {
                    console.log("AIç”Ÿæˆå¤±è´¥ï¼Œè½¬ä¸ºæœ¬åœ°ç”Ÿæˆ", e);
                }
            }

            // å¦‚æœAIç”Ÿæˆå¤±è´¥ï¼ˆstoryä¸ºç©ºï¼‰ï¼Œä½¿ç”¨æœ¬åœ°åº“
            if (!story) {
                const stories = LOCAL_SHIQIN_STORIES[action];
                if (stories && stories.length > 0) {
                    story = stories[Math.floor(Math.random() * stories.length)];
                } else {
                    story = `ä½ ${actionNames[action]}ï¼Œçš‡ä¸Šçœ‹èµ·æ¥é¢‡ä¸ºå—ç”¨ã€‚`;
                }
            }

            document.getElementById('shiqin-story').innerText = story;
        }

        function generateBedStory(favor, rankIdx) {
            const rankName = RANKS[rankIdx] ? RANKS[rankIdx].name : "å¦ƒå«”";
            let story = "";
            
            if (favor < 50) {
                story = `å¤œè‰²å·²æ·±ï¼Œçº¢çƒ›ç‡ƒå°½ã€‚ä½ å°å¿ƒç¿¼ç¿¼åœ°ä¾å¥‰çš‡ä¸Šå®‰å¯ï¼Œä¸æ•¢æœ‰ä¸æ¯«æ‡ˆæ€ ã€‚çš‡ä¸Šç¥è‰²æ·¡æ·¡ï¼Œå¹¶æœªå¤šè¨€ï¼Œåªè®©ä½ æ—©äº›æ­‡æ¯ã€‚ä½ èººåœ¨é¾™æ¦»å¤–ä¾§ï¼Œå¬ç€èº«è¾¹äººå‡åŒ€çš„å‘¼å¸å£°ï¼Œå¿ƒä¸­äº”å‘³æ‚é™ˆã€‚è¿™æ·±å®«ä¹‹ä¸­ï¼Œæ©å® éš¾æ±‚ï¼Œä»Šå¤œèƒ½æœ‰ä¸€å¸­ä¹‹åœ°ï¼Œå·²æ˜¯ä¸‡å¹¸ã€‚`;
            } else if (favor < 150) {
                story = `å¸æš–å®µæ˜¥ï¼Œä½ ä¸çš‡ä¸Šä½å£°ç»†è¯­ï¼Œè¯´èµ·å®«ä¸­è¶£äº‹ï¼Œçš‡ä¸Šå¶å°”å±•é¢œä¸€ç¬‘ï¼Œæ°”æ°›é¢‡ä¸ºæ¸©é¦¨ã€‚å®‰å¯æ—¶ï¼Œçš‡ä¸Šè½»è½»æ‹äº†æ‹ä½ çš„æ‰‹èƒŒï¼Œé“ï¼šâ€œ${rankName}ä»Šæ—¥è¾›è‹¦äº†ã€‚â€è¿™ä¸€å£°å…³æ€€ï¼Œè¶³ä»¥æŠµæ¶ˆç™½æ—¥é‡Œçš„ç§ç§ç–²æƒ«ã€‚ä½ ä¾ååœ¨çš‡ä¸Šèº«ä¾§ï¼Œæ²‰æ²‰ç¡å»ã€‚`;
            } else if (favor < 300) {
                story = `çº¢ç»¡å¸åº•ï¼Œæ©çˆ±ä¸¤ä¸ç–‘ã€‚çš‡ä¸Šæ½ä½ å…¥æ€€ï¼Œçœ¼ä¸­æ»¡æ˜¯æŸ”æƒ…èœœæ„ã€‚ä»–ç»†ç»†è¯¢é—®ä½ è¿‘æ—¥é¥®é£Ÿèµ·å±…ï¼Œåˆå˜±å’å†…åŠ¡åºœä¸å¯æ€ æ…¢ã€‚ä½ å¿ƒä¸­æš–æµæ¶ŒåŠ¨ï¼Œåªè§‰è¿™å†°å†·çš„çš‡å®«ä¹Ÿå¤šäº†å‡ åˆ†æ¸©åº¦ã€‚è¿™ä¸€å¤œï¼Œé£æœˆæ— è¾¹ï¼Œæƒ…æ·±æ„æµ“ã€‚`;
            } else {
                story = `æ˜¥å®µè‹¦çŸ­æ—¥é«˜èµ·ï¼Œä»æ­¤å›ç‹ä¸æ—©æœã€‚çš‡ä¸Šå¯¹ä½ å® çˆ±æœ‰åŠ ï¼Œæ¨ä¸å¾—å°†ä¸–é—´æœ€å¥½çš„çå®éƒ½æ§åˆ°ä½ é¢å‰ã€‚å®‰å¯ä¹‹æ—¶ï¼Œä»–ç´§ç´§æ¡ç€ä½ çš„æ‰‹ï¼Œè®¸ä¸‹â€œæ„¿å¾—ä¸€å¿ƒäººï¼Œç™½é¦–ä¸ç›¸ç¦»â€çš„è¯ºè¨€ã€‚ä½ æœ›ç€è¿™å·å³¨çš„å®«æ®¿ï¼Œæ­¤åˆ»ä»–çœ¼ä¸­åªæœ‰ä½ ä¸€äººã€‚è¿™ä»½æ·±æƒ…ï¼Œè¶³ä»¥è®©ä½ åœ¨è¿™åå®«ä¹‹ä¸­æ— æ‰€ç•æƒ§ã€‚`;
            }
            
            story += " æœˆå…‰é€è¿‡çª—æ£‚æ´’åœ¨åœ°ä¸Šï¼Œå®›å¦‚ä¸€å±‚è–„éœœã€‚è¿œå¤„çš„æ›´æ¼å£°éšçº¦ä¼ æ¥ï¼Œæé†’ç€å¤œå·²æ·±æ²‰ã€‚åœ¨è¿™å¯‚é™çš„æ·±å¤œé‡Œï¼Œä½ å¿ƒä¸­æš—æš—å‘èª“ï¼Œå®šè¦å®ˆä½è¿™ä»½æ©å® ï¼Œåœ¨è¿™åå®«ä¸­é•¿ä¹…åœ°èµ°ä¸‹å»ã€‚";
            
            return story;
        }

        function finishShiQin() {
            document.getElementById('shiqin-modal').style.display = 'none';
            
            // 1. ç»“ç®—å±æ€§ (æ ¹æ®å…´è‡´å¢åŠ ï¼Œæœ€é«˜ä¸è¶…è¿‡8)
            let favorGain = 0;
            if (STATE.emperor.mood >= 90) favorGain = 8;
            else if (STATE.emperor.mood >= 70) favorGain = 6;
            else if (STATE.emperor.mood >= 50) favorGain = 4;
            else if (STATE.emperor.mood >= 30) favorGain = 2;
            else favorGain = 1;

            // ç¡®ä¿ä¸è¶…è¿‡8 (è™½ç„¶ä¸Šé¢é€»è¾‘å·²ç»æ§åˆ¶äº†ï¼Œä½†ä¸ºäº†ä¿é™©)
            favorGain = Math.min(8, favorGain);

            STATE.player.favor += favorGain;
            
            // 2. ç”Ÿæˆå‰§æƒ…
            const story = generateBedStory(STATE.player.favor, STATE.player.rank);
            
            // 3. åˆ¤å®šæ€€å­•
            let pregMsg = "";
            let isPregnant = false;
            if (STATE.player.pregnancyEnabled && !STATE.player.isPregnant) {
                const roll = Math.random() * 100;
                if (roll < STATE.player.pregnancyRate) {
                    STATE.player.isPregnant = true;
                    STATE.player.pregnancyMonth = 0;
                    STATE.player.favor += 10; // æ€€å­•é¢å¤–åŠ å® 
                    isPregnant = true;
                    pregMsg = "\n\nã€ç³»ç»Ÿæç¤ºã€‘æ­å–œå°ä¸»ï¼æ‚¨å·²æ€€æœ‰èº«å­•ï¼";
                } else {
                    pregMsg = "\n\nã€ç³»ç»Ÿæç¤ºã€‘å¯æƒœï¼Œæœªèƒ½é‡å–œã€‚";
                }
            }
            
            // 4. æ˜¾ç¤ºç»“æœå¼¹çª—
            document.getElementById('explore-title').innerText = "ä¾å¯ç»“æŸ";
            document.getElementById('explore-text').innerText = story + pregMsg + `\n(åœ£å® +${favorGain})`;
            document.getElementById('explore-result-modal').style.display = 'block';
            
            addLog(`ä¾å¯ç»“æŸï¼Œçš‡ä¸Šå…´è‡´${STATE.emperor.mood}%ï¼Œåœ£å® +${favorGain}ã€‚${isPregnant ? "è¢«è¯Šå‡ºå–œè„‰ã€‚" : ""}`);
            
            // 5. æ—¶é—´è·³è½¬é€»è¾‘
            // è¦†ç›–é»˜è®¤çš„å…³é—­æŒ‰é’®è¡Œä¸º
            const btn = document.querySelector('#explore-result-modal .btn');
            // ä¿å­˜åŸå§‹onclickä»¥ä¾¿æ¢å¤
            const originalOnClick = btn.onclick;
            
            btn.onclick = function() {
                document.getElementById('explore-result-modal').style.display = 'none';
                // æ¢å¤é»˜è®¤ç‚¹å‡»äº‹ä»¶
                btn.onclick = function() { document.getElementById('explore-result-modal').style.display = 'none'; };
                
                handlePostShiQinTimeJump();
            };
        }

        function handlePostShiQinTimeJump() {
            updatePromotionButton();
            
            // å¦‚æœæ˜¯ä¸‹æ—¬æ·±å¤œ(2, 5)ï¼Œä¾å¯å®Œåº”è¯¥æ˜¯(2, 6)ï¼Œæç¤ºä¸‹ä¸€æœˆ
            // å¦‚æœæ˜¯å…¶ä»–æ—¶é—´ï¼Œç›´æ¥è·³åˆ°ä¸‹ä¸€æ—¬æ™¨é—´
            
            if (STATE.time.period === 2) {
                // ä¸‹æ—¬ï¼Œä¾å¯å®Œç®—è¿‡äº†ä¸€å¤œï¼Œè¿›å…¥â€œæœ¬æœˆç»“æŸâ€çŠ¶æ€
                STATE.time.timeSlot = 6;
                updateTimeUI();
                showToast("æœ¬æœˆå·²ç»“æŸï¼Œè¯·åœ¨æ¡£æ¡ˆé¡µè¿›å…¥ä¸‹ä¸€æœˆ");
            } else {
                // ä¸Šæ—¬/ä¸­æ—¬ -> ç›´æ¥è·³åˆ°ä¸‹ä¸€æ—¬æ™¨é—´
                STATE.time.period++;
                STATE.time.timeSlot = 0;
                updateTimeUI();
                updateEmperorLocation();
                showToast(`æ—¶é—´å·²æ¥åˆ°${PERIODS[STATE.time.period]}æ™¨é—´`);
            }
        }

        function checkPregnancy() {
            if (!STATE.shiqin.justFinished) return;
            STATE.shiqin.justFinished = false;

            if (!STATE.player.pregnancyEnabled) return;
            if (STATE.player.isPregnant) return;

            const roll = Math.random() * 100;
            if (roll < STATE.player.pregnancyRate) {
                STATE.player.isPregnant = true;
                STATE.player.pregnancyMonth = 0;
                STATE.player.favor += 5;
                
                showToast("æ­å–œå°ä¸»ï¼å¤ªåŒ»è¯Šè„‰è¯´æ˜¯å–œè„‰ï¼");
                addLog("è¢«è¯Šå‡ºå–œè„‰ï¼Œåœ£å® +5ã€‚");
                
                document.getElementById('explore-title').innerText = "é‡å–œ";
                document.getElementById('explore-text').innerText = "ç»è¿‡æ˜¨å¤œçš„æ©å® ï¼Œä»Šæ—©å¤ªåŒ»æ¥è¯·å¹³å®‰è„‰ï¼Œç«Ÿæ˜¯å–œè„‰ï¼\nå®«ä¸­ä¸Šä¸‹çš†æ¥é“è´ºï¼Œçš‡ä¸Šæ›´æ˜¯é¾™é¢œå¤§æ‚¦ï¼Œèµèµé¢‡ä¸°ã€‚";
                document.getElementById('explore-result-modal').style.display = 'block';
            }
        }

        function togglePregnancy(checkbox) {
            STATE.player.pregnancyEnabled = checkbox.checked;
            showToast(STATE.player.pregnancyEnabled ? "å·²å¼€å¯æ€€å­•" : "å·²å…³é—­æ€€å­•");
        }

        function birthChild() {
            STATE.player.isPregnant = false;
            STATE.player.pregnancyMonth = 0;
            
            const roll = Math.random();
            let children = [];
            let favorGain = 0;
            let msg = "";

            if (roll < 0.05) { // é¾™å‡¤èƒ
                children.push(createChild('ç”·'), createChild('å¥³'));
                favorGain = 20;
                msg = "æ­å–œå°ä¸»ï¼è¯ä¸‹é¾™å‡¤èƒï¼çš‡ä¸Šå¤§å–œï¼";
            } else if (roll < 0.20) { // åŒèƒèƒ (15%)
                const gender = Math.random() < 0.5 ? 'ç”·' : 'å¥³';
                children.push(createChild(gender), createChild(gender));
                favorGain = 15;
                msg = `æ­å–œå°ä¸»ï¼è¯ä¸‹åŒèƒèƒ${gender === 'ç”·' ? 'çš‡å­' : 'å…¬ä¸»'}ï¼`;
            } else if (roll < 0.60) { // ç”·å­© (40%)
                children.push(createChild('ç”·'));
                favorGain = 10;
                msg = "æ­å–œå°ä¸»ï¼è¯ä¸‹å°çš‡å­ï¼";
            } else { // å¥³å­© (40%)
                children.push(createChild('å¥³'));
                favorGain = 10;
                msg = "æ­å–œå°ä¸»ï¼è¯ä¸‹å°å…¬ä¸»ï¼";
            }

            STATE.player.children.push(...children);
            STATE.player.favor += favorGain;
            
            addLog(`è¯ä¸‹${children.length}åå­å—£ï¼Œåœ£å® +${favorGain}ã€‚`);
            
            document.getElementById('explore-title').innerText = "å–œå¾—è´µå­";
            document.getElementById('explore-text').innerText = msg + `\n\n(åœ£å® +${favorGain})`;
            document.getElementById('explore-result-modal').style.display = 'block';
            
            updatePromotionButton();
        }

        function createChild(gender) {
            const name = generateRandomName(gender === 'ç”·' ? 'male' : 'female');
            const traits = ['èªæ…§', 'æ´»æ³¼', 'å†…å‘', 'é¡½çš®', 'æ¸©é¡º', 'å€”å¼º'];
            const trait = traits[Math.floor(Math.random() * traits.length)];
            const aptitude = Math.floor(Math.random() * 50) + 50; // 50-100
            
            return {
                name: name,
                gender: gender,
                age: 0,
                trait: trait,
                aptitude: aptitude, // èµ„è´¨
                affection: 0 // äº²å¯†åº¦
            };
        }

        function openChildrenSystem() {
            const list = document.getElementById('children-list');
            list.innerHTML = '';
            
            if (STATE.player.children.length === 0) {
                list.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: #666; padding: 20px;">è†ä¸‹æš‚æ— å­å—£</div>';
            } else {
                STATE.player.children.forEach((child, index) => {
                    const div = document.createElement('div');
                    div.className = 'panel';
                    div.style.padding = '10px';
                    div.style.textAlign = 'center';
                    div.style.fontSize = '0.9rem';
                    
                    div.innerHTML = `
                        <div style="font-weight: bold; color: var(--primary-color); margin-bottom: 5px;">${child.name}</div>
                        <div style="color: #666;">${child.gender} | ${child.age}å²</div>
                        <div>æ€§æ ¼ï¼š${child.trait}</div>
                        <div>èµ„è´¨ï¼š${child.aptitude}</div>
                        <div>äº²å¯†ï¼š${child.affection}</div>
                        <div style="margin-top: 10px; display: flex; gap: 5px; justify-content: center;">
                            <button class="btn btn-small" onclick="interactWithChild(${index}, 'teach')">æ•™å¯¼</button>
                            <button class="btn btn-small" onclick="interactWithChild(${index}, 'play')">æ¸¸ç©</button>
                        </div>
                    `;
                    list.appendChild(div);
                });
            }
            
            document.getElementById('children-modal').style.display = 'flex';
        }

        function interactWithChild(index, type) {
            // æ¶ˆè€—è¡ŒåŠ¨ç‚¹
            if (STATE.time.period === 2 && STATE.time.timeSlot >= 6) {
                showToast("æœ¬æœˆè¡ŒåŠ¨ç‚¹å·²ç”¨å°½ã€‚");
                return;
            }

            const child = STATE.player.children[index];
            let msg = "";
            
            if (type === 'teach') {
                child.aptitude += 1;
                child.affection += 1;
                msg = `ä½ æ•™å¯¼äº†${child.name}ï¼Œèµ„è´¨+1ï¼Œäº²å¯†+1ã€‚`;
            } else {
                child.affection += 3;
                msg = `ä½ é™ª${child.name}ç©è€ï¼Œäº²å¯†+3ã€‚`;
            }
            
            advanceTime();
            openChildrenSystem(); // åˆ·æ–°ç•Œé¢
            showToast(msg);
            addLog(msg);
        }

        async function interactWithEmperor(type) {
            // æ¶ˆè€—è¡ŒåŠ¨ç‚¹
            if (STATE.time.period === 2 && STATE.time.timeSlot >= 6) {
                showToast("æœ¬æœˆè¡ŒåŠ¨ç‚¹å·²ç”¨å°½ã€‚");
                return;
            }

            document.getElementById('emperor-detail-modal').style.display = 'none';
            
            // äº’åŠ¨é€»è¾‘
            let favorGain = 1; // å›ºå®šåŠ 1
            let msg = "";
            
            if (type === 'ä¾å¯') {
                // å¦‚æœä¸æ˜¯ç¿»ç‰Œå­è¿›æ¥çš„ï¼Œè¿›å…¥æ™®é€šä¾å¯æµç¨‹ï¼ˆå¤ç”¨openShiQinï¼‰
                openShiQin();
                return;
            } else if (type === 'ä¼´è¯»') {
                if (STATE.player.stats.intelligence > 100) {
                    msg = "ä½ è§è§£ç‹¬åˆ°ï¼Œçš‡ä¸Šé¢‡ä¸ºèµèµã€‚";
                } else {
                    msg = "ä½ åœ¨æ—é™é™ç ”å¢¨ï¼Œçš‡ä¸Šä¸“å¿ƒæ”¿åŠ¡ã€‚";
                }
            } else if (type === 'é€æ±¤') {
                if (Math.random() > 0.5) {
                    msg = "çš‡ä¸Šå–äº†æ±¤ï¼Œå¤¸èµä½ æ‰‹è‰ºä¸é”™ã€‚";
                } else {
                    // é€æ±¤å¤±è´¥ä¸åŠ åœ£å® 
                    favorGain = 0;
                    msg = "çš‡ä¸Šæ­£å¿™ï¼Œè®©å…¬å…¬æ”¶ä¸‹äº†æ±¤ã€‚";
                }
            } else if (type === 'å¶é‡') {
                msg = "çš‡ä¸Šå¯¹ä½ å¾®å¾®ä¸€ç¬‘ï¼Œä¼¼ä¹å¿ƒæƒ…ä¸é”™ã€‚";
            }

            STATE.player.favor += favorGain;
            addLog(`ä¸çš‡ä¸Š${type}ï¼Œåœ£å® +${favorGain}ã€‚`);
            
            // æ£€æŸ¥æ™‹å‡
            updatePromotionButton();
            
            advanceTime();
            
            document.getElementById('explore-text').innerText = msg + ` (åœ£å® +${favorGain})`;
            document.getElementById('explore-result-modal').style.display = 'block';
        }

        function updatePromotionButton() {
            const btn = document.getElementById('btn-promote');
            if (!btn) return;

            const currentRankIdx = STATE.player.rank;
            if (currentRankIdx <= 0) {
                btn.innerText = "å·²è‡³å·…å³°";
                btn.disabled = true;
                btn.className = "btn btn-secondary";
                return;
            }

            const nextRank = RANKS[currentRankIdx - 1];
            const currentFavor = STATE.player.favor;
            const allStatsQualified = Object.values(STATE.player.stats).every(val => val >= nextRank.minStat);
            
            // æ£€æŸ¥ç›®æ ‡ä½ä»½æ˜¯å¦æ»¡å‘˜
            const count = STATE.concubines.filter(c => c.rank === (currentRankIdx - 1)).length;
            const isFull = count >= nextRank.limit;
            
            if (currentFavor >= nextRank.minFavor && allStatsQualified) {
                if (isFull) {
                    btn.disabled = true;
                    btn.className = "btn btn-secondary";
                    btn.innerText = `${nextRank.name}ä½ä»½å·²æ»¡`;
                } else {
                    btn.disabled = false;
                    btn.className = "btn"; // æ¿€æ´»æ ·å¼
                    btn.innerText = `æ™‹å‡${nextRank.name}`;
                }
            } else {
                btn.disabled = true;
                btn.className = "btn btn-secondary";
                btn.innerText = "æ™‹å‡æ¡ä»¶æœªè¾¾";
            }
        }

        function promotePlayer() {
            const currentRankIdx = STATE.player.rank;
            if (currentRankIdx <= 0) return;

            const nextRank = RANKS[currentRankIdx - 1];
            
            // æ‰§è¡Œæ™‹å‡
            STATE.player.rank--;
            addLog(`æ™‹å‡ä¸º${nextRank.name}ã€‚`);
            
            // ç”Ÿæˆåœ£æ—¨å†…å®¹
            const edictText = generateEdictText(nextRank.name, STATE.player.name, STATE.player.background);
            document.getElementById('edict-text').innerHTML = edictText;
            document.getElementById('edict-modal').style.display = 'flex';
            
            updateProfileView();
            updatePromotionButton();
        }

        function generateEdictText(rankName, name, background) {
            const date = `å®£å’Œ${STATE.time.year}å¹´${STATE.time.month}æœˆ`;
            const bgSimple = background.split(' ')[1] || "è‰¯å®¶å­";
            
            // ç«–æ’æ–‡å­—ï¼Œä½¿ç”¨å…¨è§’ç©ºæ ¼å’Œæ¢è¡Œ
            let text = `
                å¥‰å¤©æ‰¿è¿<br>
                çš‡å¸è¯æ›°<br>
                <br>
                å…¹æœ‰${bgSimple}ä¹‹å¥³${name}<br>
                æ·‘æ…æ€§æˆã€€å‹¤å‹‰æŸ”é¡º<br>
                é›å’Œç²¹çº¯ã€€æ€§è¡Œæ¸©è‰¯<br>
                å…‹å¨´å†…åˆ™ã€€æ·‘å¾·å«ç« <br>
                <br>
                ç€å³å†Œå°ä¸º<strong>${rankName}</strong><br>
                <br>
                é’¦æ­¤<br>
                <br>
                ${date}
            `;
            return text;
        }

        function closeEdict() {
            document.getElementById('edict-modal').style.display = 'none';
        }

        function openLocationDetail(locName) {
            // ä¾å¯ç‰¹æ®Šå¤„ç†ï¼šå¦‚æœè¢«ç¿»ç‰Œå­ï¼Œç‚¹å‡»å…»å¿ƒæ®¿ç›´æ¥è¿›å…¥ä¾å¯
            if (locName === 'å…»å¿ƒæ®¿' && STATE.emperor.state === 'ç­‰å¾…ä¾å¯' && STATE.shiqin.pending) {
                openShiQin();
                return;
            }

            // é‡ç½®å…³é—­æŒ‰é’®æ˜¾ç¤º
            document.querySelector('.loc-close').style.display = 'flex';

            // å†·å®«ç‰¹æ®Šå¤„ç†
            if (STATE.player.inColdPalace) {
                if (locName !== 'å†·å®«') {
                    showToast("ç¦è¶³ä¸­ï¼Œæ— æ³•å‰å¾€å…¶ä»–å®«æ®¿ã€‚");
                    return;
                }
                openColdPalaceSpecial();
                return;
            }

            // æ­£å¸¸å†·å®«è®¿é—®
            if (locName === 'å†·å®«' && !STATE.player.inColdPalace) {
                // ä½¿ç”¨é»˜è®¤é€»è¾‘ï¼Œä½†ç¡®ä¿ä¸æ˜¾ç¤ºå¤å‡ºç›¸å…³å†…å®¹
            }

            // æ£€æŸ¥å¶é‡
            if (STATE.emperor.location === locName && locName !== 'å…»å¿ƒæ®¿') {
                if (Math.random() < 0.3) { // 30%æ¦‚ç‡å¶é‡
                    if(confirm(`åœ¨${locName}å¶é‡çš‡ä¸Šï¼æ˜¯å¦ä¸Šå‰è¯·å®‰ï¼Ÿ`)) {
                        interactWithEmperor('å¶é‡');
                        return; // å¶é‡äº’åŠ¨åä¸å†æ˜¾ç¤ºåœ°ç‚¹è¯¦æƒ…
                    }
                }
            }

            const loc = LOCATIONS[locName];
            if (!loc) return;

            document.getElementById('loc-title').innerText = locName;
            document.getElementById('loc-desc').innerText = loc.desc;
            document.getElementById('loc-bg-img').src = loc.bg;
            
            // æ¸²æŸ“å­åœ°ç‚¹
            const subContainer = document.getElementById('sub-loc-container');
            const subList = document.getElementById('sub-loc-list');
            subList.innerHTML = '';
            if (loc.subLocations && loc.subLocations.length > 0) {
                subContainer.style.display = 'block';
                loc.subLocations.forEach((sub, index) => {
                    const div = document.createElement('div');
                    div.className = `sub-loc-item ${index === 0 ? 'active' : ''}`;
                    div.innerHTML = `<div>${sub}</div>`;
                    div.onclick = function() {
                        document.querySelectorAll('.sub-loc-item').forEach(el => el.classList.remove('active'));
                        this.classList.add('active');
                        showToast(`è¿›å…¥${sub}`);
                    };
                    subList.appendChild(div);
                });
            } else {
                subContainer.style.display = 'none';
            }

            // æ¸²æŸ“åŠ¨ä½œ
            const actionList = document.getElementById('loc-actions-list');
            actionList.innerHTML = '';
            if (loc.actions) {
                loc.actions.forEach(act => {
                    const div = document.createElement('div');
                    div.className = 'action-card';
                    div.innerHTML = `
                        <div class="action-icon">${act.icon}</div>
                        <div class="action-info">
                            <h4>${act.name}</h4>
                            <p class="action-desc">${act.desc}</p>
                        </div>
                    `;
                    div.onclick = () => handleAction(locName, act);
                    actionList.appendChild(div);
                });
            }

            document.getElementById('location-detail-page').style.display = 'flex';
            addLog(`æŠµè¾¾${locName}ã€‚`);
        }

        function closeLocationDetail() {
            if (STATE.player.inColdPalace) {
                showToast("ç¦è¶³ä¸­ï¼Œæ— æ³•ç¦»å¼€å†·å®«ã€‚");
                return;
            }
            document.getElementById('location-detail-page').style.display = 'none';
        }

        async function handleAction(locName, action) {
            // æ£€æŸ¥è¡ŒåŠ¨ç‚¹
            if (STATE.time.period === 2 && STATE.time.timeSlot >= 6) {
                showToast("æœ¬æœˆè¡ŒåŠ¨ç‚¹å·²ç”¨å°½ï¼Œè¯·å‰å¾€æ¡£æ¡ˆé¡µè¿›å…¥ä¸‹ä¸€æœˆã€‚");
                return;
            }

            // ç‰¹æ®ŠåŠ¨ä½œæ‹¦æˆª
            if (action.name === 'è§è§çš‡ä¸Š') {
                openYangXinDian();
                return;
            }

            // é¢„å…ˆè®¡ç®—éšæœºäº‹ä»¶ï¼ˆä¸ç«‹å³åº”ç”¨ï¼Œç­‰ä¸»é€»è¾‘å®Œæˆåå åŠ ï¼‰
            // å†·å®«ä¸­ä¸è§¦å‘æ™®é€šéšæœºäº‹ä»¶
            let randomEvent = null;
            if (!STATE.player.inColdPalace && Math.random() < 0.2) { // 20%æ¦‚ç‡è§¦å‘
                randomEvent = RANDOM_EVENTS[Math.floor(Math.random() * RANDOM_EVENTS.length)];
            }

            // è¾…åŠ©å‡½æ•°ï¼šåº”ç”¨éšæœºäº‹ä»¶æ•ˆæœ
            const applyRandomEvent = (evt) => {
                let msg = "";
                for (let key in evt.effect) {
                    let val = evt.effect[key];
                    if (key === 'money') {
                        // é“¶ä¸¤æ£€æŸ¥ï¼šå¦‚æœæ˜¯æ‰£é’±ï¼Œä¸èƒ½æ‰£æˆè´Ÿæ•°
                        if (val < 0 && STATE.player.money + val < 0) {
                            val = -STATE.player.money; // æœ€å¤šæ‰£å…‰
                        }
                        STATE.player.money += val;
                    } else if (key === 'favor') {
                        STATE.player.favor += val;
                    } else if (STATE.player.stats[key] !== undefined) {
                        STATE.player.stats[key] = Math.max(0, Math.min(1000, STATE.player.stats[key] + val));
                    }
                    
                    if (val !== 0) {
                        const map = {money:'é“¶ä¸¤', favor:'åœ£å® ', charm:'å®¹è²Œ', intelligence:'æ‰æƒ…', health:'ä½“è´¨', social:'äº¤é™…', scheme:'å¿ƒæœº', luck:'ç¦è¿', mood:'å¿ƒæƒ…'};
                        msg += ` ${map[key] || key}${val > 0 ? '+' : ''}${val}`;
                    }
                }
                return msg;
            };

            // å‚¨ç§€å®«å¯å®«ä¸“å±è®­ç»ƒé€»è¾‘
            if (action.type === 'train') {
                const gain = Math.floor(Math.random() * 5) + 1;
                STATE.player.stats[action.stat] = Math.min(1000, STATE.player.stats[action.stat] + gain);
                
                advanceTime();
                
                let result = `ä½ è¿›è¡Œäº†${action.name}ï¼Œ${action.desc.split('ï¼Œ')[1]} +${gain}`;
                
                if (randomEvent) {
                    const extraMsg = applyRandomEvent(randomEvent);
                    result += `\n\nã€éšæœºäº‹ä»¶ã€‘${randomEvent.text}\n(${extraMsg})`;
                }
                
                document.getElementById('explore-text').innerText = result;
                document.getElementById('explore-result-modal').style.display = 'block';
                addLog(result);
                updateProfileView();
                return;
            }

            // è´­ä¹°å¢å­•ä¸¸é€»è¾‘
            if (action.name === 'è´­ä¹°å¢å­•ä¸¸') {
                if (STATE.player.money < 500) {
                    showToast("é“¶ä¸¤ä¸è¶³500ä¸¤");
                    return;
                }
                STATE.player.money -= 500;
                STATE.player.pregnancyRate += 5;
                showToast("è´­ä¹°æˆåŠŸï¼Œå­•ç‡æå‡5%");
                addLog("èŠ±è´¹500ä¸¤è´­ä¹°å¢å­•ä¸¸ï¼Œå­•ç‡+5%ã€‚");
                updateProfileView();
                return;
            }

            // AI ç”Ÿæˆäº‹ä»¶
            // ç¡®ä¿å¼¹çª—æ˜¾ç¤ºå¹¶æ¸…ç©ºæ—§å†…å®¹
            document.getElementById('explore-title').innerText = "éšæœºäº‹ä»¶";
            document.getElementById('explore-text').innerText = "æ­£åœ¨ç”Ÿæˆéšæœºäº‹ä»¶ï¼Œè¯·ç¨å€™...";
            document.getElementById('explore-result-modal').style.display = 'block';

            // å‡†å¤‡ä¸Šä¸‹æ–‡
            const context = {
                player: {
                    name: STATE.player.name,
                    rank: RANKS[STATE.player.rank].name,
                    stats: STATE.player.stats,
                    favor: STATE.player.favor,
                    money: STATE.player.money
                },
                emperor: {
                    name: STATE.emperor.name,
                    trait: STATE.emperor.trait,
                    like: STATE.emperor.like
                },
                location: locName,
                action: action.name,
                time: `ç¬¬${STATE.time.year}å¹´${STATE.time.month}æœˆ`
            };

            const systemPrompt = `ä½ æ˜¯ä¸€ä¸ªå®«æ–—æ¸¸æˆçš„äº‹ä»¶ç”Ÿæˆå™¨ã€‚è¯·æ ¹æ®ç©å®¶ä¿¡æ¯ã€çš‡å¸ä¿¡æ¯å’Œå½“å‰åœ°ç‚¹åŠ¨ä½œï¼Œç”Ÿæˆä¸€æ®µç®€çŸ­çš„éšæœºå‰§æƒ…ï¼ˆ50å­—ä»¥å†…ï¼‰ã€‚
            å¦‚æœå‰§æƒ…æ¶‰åŠå±æ€§å˜åŒ–ï¼Œè¯·åœ¨å‰§æƒ…åé™„åŠ JSONæ•°æ®ï¼Œæ ¼å¼ä¸ºï¼š
            {"changes": {"charm": 1, "money": -10, "favor": 1}}
            å¯å˜å±æ€§ï¼šcharm(å®¹è²Œ), intelligence(æ‰æƒ…), health(ä½“è´¨), social(äº¤é™…), scheme(å¿ƒæœº), luck(ç¦è¿), favor(åœ£å® ), money(é“¶ä¸¤)ã€‚
            è¯·ç¡®ä¿å‰§æƒ…ç¬¦åˆå¤ä»£å®«å»·èƒŒæ™¯ã€‚
            ç‰¹åˆ«æ³¨æ„ï¼šå¦‚æœå‰§æƒ…ä¸­æ¶‰åŠé€šå‘Šï¼Œå³ä½¿æ˜¯æœ€å¥½çš„é€šå‘Šæœ€å¤šä¹Ÿåªæ¶ˆè€—ä¸ƒä¸ªè¡ŒåŠ¨ç‚¹ï¼`;

            const userPrompt = JSON.stringify(context);

            try {
                const response = await callAI(systemPrompt, userPrompt);
                
                // è§£æå“åº”
                let text = response;
                let changes = {};
                
                const jsonMatch = response.match(/\{[\s\S]*\}/);
                if (jsonMatch) {
                    try {
                        const jsonStr = jsonMatch[0];
                        const data = JSON.parse(jsonStr);
                        if (data.changes) changes = data.changes;
                        text = response.replace(jsonStr, "").trim();
                    } catch (e) {
                        console.error("JSONè§£æå¤±è´¥", e);
                    }
                }

                // åº”ç”¨å±æ€§å˜åŒ–
                let changeLog = [];
                for (const [key, val] of Object.entries(changes)) {
                    if (key === 'money') {
                        // é“¶ä¸¤æ£€æŸ¥
                        let actualVal = val;
                        if (actualVal < 0 && STATE.player.money + actualVal < 0) {
                            actualVal = -STATE.player.money;
                        }
                        STATE.player.money += actualVal;
                        if (actualVal !== 0) changeLog.push(`é“¶ä¸¤${actualVal > 0 ? '+' : ''}${actualVal}`);
                    } else if (key === 'favor') {
                        STATE.player.favor += val;
                        changeLog.push(`åœ£å® ${val > 0 ? '+' : ''}${val}`);
                    } else if (STATE.player.stats[key] !== undefined) {
                        STATE.player.stats[key] = Math.max(0, Math.min(1000, STATE.player.stats[key] + val));
                        const nameMap = {charm:'å®¹è²Œ', intelligence:'æ‰æƒ…', health:'ä½“è´¨', social:'äº¤é™…', scheme:'å¿ƒæœº', luck:'ç¦è¿'};
                        changeLog.push(`${nameMap[key]}${val > 0 ? '+' : ''}${val}`);
                    }
                }

                if (changeLog.length > 0) {
                    text += `\n(${changeLog.join(', ')})`;
                }

                // å åŠ éšæœºäº‹ä»¶
                if (randomEvent) {
                    const extraMsg = applyRandomEvent(randomEvent);
                    text += `\n\nã€éšæœºäº‹ä»¶ã€‘${randomEvent.text}\n(${extraMsg})`;
                }

                document.getElementById('explore-text').innerText = text;
                addLog(`åœ¨${locName}${action.name}ï¼š${text}`);
                
                advanceTime();
                updateProfileView();

            } catch (e) {
                document.getElementById('explore-text').innerText = "äº‹ä»¶ç”Ÿæˆå¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–APIè®¾ç½®ã€‚\n\n(ç³»ç»Ÿè‡ªåŠ¨æ‰§è¡Œé»˜è®¤æ“ä½œ)";
                console.error(e);
                // å¤±è´¥æ—¶çš„é»˜è®¤åé¦ˆ
                addLog(`åœ¨${locName}${action.name}ã€‚`);
                advanceTime();
                updateProfileView();
            }
        }

        function buyStat(stat) {
            const cost = 100;
            const gain = 5;
            const maxGain = 50;
            const maxCost = 1000;
            
            // å¼¹çª—è¯¢é—®è´­ä¹°æ•°é‡
            const input = prompt(`è¯·è¾“å…¥è¦èŠ±è´¹çš„é“¶ä¸¤ï¼ˆ${cost}ä¸¤=${gain}ç‚¹ï¼Œæœ€é«˜${maxCost}ä¸¤=${maxGain}ç‚¹ï¼‰ï¼š`, "100");
            if (input === null) return;
            
            let amount = parseInt(input);
            if (isNaN(amount) || amount < cost) {
                showToast(`è‡³å°‘éœ€è¦${cost}ä¸¤é“¶å­`);
                return;
            }
            
            if (amount > maxCost) amount = maxCost;
            if (STATE.player.money < amount) {
                showToast("é“¶ä¸¤ä¸è¶³");
                return;
            }
            
            const actualGain = Math.floor(amount / cost) * gain;
            
            STATE.player.money -= amount;
            STATE.player.stats[stat] = Math.min(1000, STATE.player.stats[stat] + actualGain);
            
            showToast(`èŠ±è´¹${amount}ä¸¤ï¼Œ${stat}æå‡${actualGain}ç‚¹`);
            updateProfileView();
        }

        function showToast(msg) {
            const toast = document.getElementById('toast');
            toast.innerText = msg;
            toast.style.opacity = 1;
            setTimeout(() => {
                toast.style.opacity = 0;
            }, 2000);
        }

        // --- èº«ä»½åˆ›å»º ---

        function generateRandomName(gender = 'female') {
            const surname = SURNAMES[Math.floor(Math.random() * SURNAMES.length)];
            let name = "";
            
            // 50%æ¦‚ç‡å•å­—ï¼Œ50%æ¦‚ç‡åŒå­—
            const isDouble = Math.random() > 0.5;
            
            if (gender === 'female') {
                if (isDouble) {
                    name = FEMALE_NAMES_DOUBLE[Math.floor(Math.random() * FEMALE_NAMES_DOUBLE.length)];
                } else {
                    name = FEMALE_NAMES_SINGLE[Math.floor(Math.random() * FEMALE_NAMES_SINGLE.length)];
                }
            } else {
                if (isDouble) {
                    name = MALE_NAMES_DOUBLE[Math.floor(Math.random() * MALE_NAMES_DOUBLE.length)];
                } else {
                    name = MALE_NAMES_SINGLE[Math.floor(Math.random() * MALE_NAMES_SINGLE.length)];
                }
            }
            
            // å¦‚æœæ˜¯ç©å®¶è°ƒç”¨ï¼ˆæ— å‚æ•°æˆ–é»˜è®¤femaleï¼‰ï¼Œæ›´æ–°è¾“å…¥æ¡†
            if (event && event.target && event.target.closest('#page-create')) {
                document.getElementById('input-name').value = surname + name;
            }
            
            return surname + name;
        }

        function generateRandomBackground() {
            const isOfficial = Math.random() < 0.6;
            let desc = "";
            let bgType = "";
            let bgLevel = 0;
            let isDi = false;

            if (isOfficial) {
                bgType = "official";
                const r = Math.random();
                if (r < 0.05) bgLevel = 1; 
                else if (r < 0.1) bgLevel = 2; 
                else if (r < 0.2) bgLevel = 3; 
                else if (r < 0.3) bgLevel = 4; 
                else if (r < 0.45) bgLevel = 5; 
                else if (r < 0.6) bgLevel = 6; 
                else if (r < 0.75) bgLevel = 7; 
                else if (r < 0.9) bgLevel = 8; 
                else bgLevel = 9; 

                const titles = OFFICIAL_TITLES[bgLevel];
                const title = titles[Math.floor(Math.random() * titles.length)];
                
                isDi = Math.random() < 0.4; 
                const identity = isDi ? "å«¡å¥³" : "åº¶å¥³";
                
                desc = `ã€${bgLevel}å“å®˜å®¦ã€‘ ${title} ä¹‹ ${identity}`;
            } else {
                bgType = "other";
                bgLevel = 10;
                const bg = OTHER_BACKGROUNDS[Math.floor(Math.random() * OTHER_BACKGROUNDS.length)];
                desc = `ã€ä¸–ä¿—æ°‘å®¶ã€‘ ${bg}`;
            }

            STATE.player.background = desc;
            STATE.player.bgType = bgType;
            STATE.player.bgLevel = bgLevel;
            STATE.player.isDi = isDi;

            document.getElementById('background-display').innerText = desc;
        }

        function generateEmperor() {
            const name = SURNAMES[Math.floor(Math.random() * SURNAMES.length)] + "çš‡"; // ç®€å•ç”Ÿæˆ
            const age = Math.floor(Math.random() * 30) + 20; // 20-50å²
            const trait = EMPEROR_TRAITS[Math.floor(Math.random() * EMPEROR_TRAITS.length)];
            const look = EMPEROR_LOOKS[Math.floor(Math.random() * EMPEROR_LOOKS.length)];
            const like = EMPEROR_LIKES[Math.floor(Math.random() * EMPEROR_LIKES.length)];
            const avatar = EMPEROR_AVATARS[look];

            STATE.emperor = { name, age, trait, look, like, avatar };

            const infoHtml = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <img src="${avatar}" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary-color);">
                    <div>
                        <div><strong>ç›¸è²Œï¼š</strong>${look}</div>
                        <div><strong>æ€§æ ¼ï¼š</strong>${trait}</div>
                        <div><strong>åå¥½ï¼š</strong>${like}</div>
                    </div>
                </div>
            `;
            document.getElementById('emperor-info').innerHTML = infoHtml;
        }

        function handleEmperorImage(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    STATE.emperor.avatar = e.target.result;
                    // åˆ·æ–°æ˜¾ç¤º
                    if (STATE.emperor.look) {
                        const infoHtml = `
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <img src="${STATE.emperor.avatar}" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 2px solid var(--primary-color);">
                                <div>
                                    <div><strong>ç›¸è²Œï¼š</strong>${STATE.emperor.look}</div>
                                    <div><strong>æ€§æ ¼ï¼š</strong>${STATE.emperor.trait}</div>
                                    <div><strong>åå¥½ï¼š</strong>${STATE.emperor.like}</div>
                                </div>
                            </div>
                        `;
                        document.getElementById('emperor-info').innerHTML = infoHtml;
                    }
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function generateConcubines() {
            const sizeMap = { 'small': 15, 'medium': 40, 'large': 100 };
            const size = document.getElementById('harem-size').value;
            const count = sizeMap[size] || 40;
            
            STATE.concubines = [];
            const rankCounts = new Array(RANKS.length).fill(0); // è®°å½•æ¯ä¸ªä½ä»½çš„äººæ•°
            
            for (let i = 0; i < count; i++) {
                let rankIdx;
                let attempts = 0;
                
                // å°è¯•ç”Ÿæˆä½ä»½ï¼Œç›´åˆ°æ‰¾åˆ°ä¸€ä¸ªæœªæ»¡å‘˜çš„
                do {
                    if (i < 1 && Math.random() < 0.3) rankIdx = 0; // 30%æ¦‚ç‡æœ‰çš‡å
                    else if (i < 4) rankIdx = Math.floor(Math.random() * 6) + 1; // çš‡è´µå¦ƒåˆ°å››å¦ƒ
                    else rankIdx = Math.floor(Math.random() * 20) + 7; // å¦ƒä»¥ä¸‹
                    
                    if (rankIdx > 29) rankIdx = 29;
                    attempts++;
                } while (rankCounts[rankIdx] >= RANKS[rankIdx].limit && attempts < 10);
                
                // å¦‚æœå°è¯•å¤šæ¬¡è¿˜æ˜¯æ»¡å‘˜ï¼Œå°±é™çº§å¤„ç†ï¼ˆå¾€ä½ä½æ‰¾ï¼‰
                while (rankCounts[rankIdx] >= RANKS[rankIdx].limit && rankIdx < 29) {
                    rankIdx++;
                }

                rankCounts[rankIdx]++;

                const name = generateRandomName('female');
                const trait = CONCUBINE_TRAITS[Math.floor(Math.random() * CONCUBINE_TRAITS.length)];
                const charm = Math.floor(Math.random() * 800) + 100;
                const mood = Math.floor(Math.random() * 100);
                const state = "æ­£å¸¸";
                const avatarSeed = Math.random(); // ç”¨äºç”Ÿæˆå¤´åƒ
                
                // æ–°å¢å±æ€§
                const favor = Math.floor(Math.random() * 200); // åˆå§‹åœ£å® 
                const affection = Math.floor(Math.random() * 60) - 10; // åˆå§‹å¥½æ„Ÿ -10åˆ°50
                const scheme = Math.floor(Math.random() * 800) + 50; // åˆå§‹å¿ƒæœº
                const health = Math.floor(Math.random() * 100) + 50; // åˆå§‹å¥åº·

                STATE.concubines.push({
                    id: i,
                    name,
                    rank: rankIdx,
                    trait,
                    charm,
                    mood,
                    state,
                    avatarSeed,
                    favor,
                    affection,
                    scheme,
                    health,
                    isPregnant: false,
                    pregnancyMonth: 0,
                    dead: false,
                    disfigured: false
                });
            }
            
            // æŒ‰ä½ä»½æ’åº
            STATE.concubines.sort((a, b) => a.rank - b.rank);
        }

        function showConcubineList() {
            const container = document.getElementById('concubine-list-container');
            container.innerHTML = '';
            
            STATE.concubines.forEach(c => {
                const div = document.createElement('div');
                div.className = 'concubine-item';
                div.style.position = 'relative'; // ä¸ºçº¢ç‚¹å®šä½
                
                // çŠ¶æ€æ ·å¼
                let statusStyle = "";
                let statusText = "";
                if (c.dead || c.state === 'æš´æ¯™') {
                    statusStyle = "filter: grayscale(100%); opacity: 0.6; cursor: not-allowed;";
                    statusText = " (äº¡)";
                } else if (c.state === 'å†·å®«') {
                    statusStyle = "filter: sepia(100%); opacity: 0.8;";
                    statusText = " (å†·)";
                } else if (c.isPregnant) {
                    statusText = ` (å­•${c.pregnancyMonth}æœˆ)`;
                }

                div.style.cssText = statusStyle;
                
                // åˆ›å»ºcanvasç”Ÿæˆå¤´åƒ
                const canvas = document.createElement('canvas');
                canvas.width = 60;
                canvas.height = 60;
                canvas.className = 'concubine-avatar';
                
                // å¼‚æ­¥ç»˜åˆ¶ï¼Œé¿å…é˜»å¡
                setTimeout(() => {
                    const ctx = canvas.getContext('2d');
                    drawAvatarOnCtx(ctx, 60, 60, c.avatarSeed);
                }, 0);

                div.appendChild(canvas);
                
                // çº¢ç‚¹
                if (c.unread) {
                    const badge = document.createElement('div');
                    badge.style.position = 'absolute';
                    badge.style.top = '5px';
                    badge.style.right = '25px';
                    badge.style.width = '10px';
                    badge.style.height = '10px';
                    badge.style.backgroundColor = 'red';
                    badge.style.borderRadius = '50%';
                    badge.style.border = '1px solid #fff';
                    div.appendChild(badge);
                }
                
                const nameDiv = document.createElement('div');
                nameDiv.className = 'concubine-name';
                nameDiv.innerText = c.name + statusText;
                div.appendChild(nameDiv);
                
                const rankDiv = document.createElement('div');
                rankDiv.className = 'concubine-rank';
                rankDiv.innerText = RANKS[c.rank].name;
                div.appendChild(rankDiv);
                
                if (!c.dead && c.state !== 'æš´æ¯™') {
                    div.onclick = () => showConcubineDetail(c);
                }
                
                container.appendChild(div);
            });
            
            document.getElementById('concubine-list-modal').style.display = 'flex';
        }

        function showConcubineDetail(c) {
            // æ¶ˆé™¤çº¢ç‚¹
            if (c.unread) {
                c.unread = false;
                // åˆ·æ–°åˆ—è¡¨ä»¥ç§»é™¤çº¢ç‚¹ï¼ˆå¦‚æœåˆ—è¡¨å¼€ç€ï¼‰
                showConcubineList(); 
            }

            document.getElementById('concubine-detail-name').innerText = c.name;
            document.getElementById('concubine-detail-rank').innerText = RANKS[c.rank].name;
            document.getElementById('concubine-detail-trait').innerText = c.trait;
            document.getElementById('concubine-detail-charm').innerText = c.charm;
            document.getElementById('concubine-detail-mood').innerText = c.mood;
            document.getElementById('concubine-detail-state').innerText = c.state;
            document.getElementById('concubine-detail-affection').innerText = c.affection || 0;
            document.getElementById('concubine-detail-scheme').innerText = c.scheme || 0;
            
            const canvas = document.getElementById('concubine-detail-avatar');
            const ctx = canvas.getContext('2d');
            drawAvatarOnCtx(ctx, 100, 100, c.avatarSeed);
            
            // ç»‘å®šèŠå¤©æŒ‰é’®
            const chatBtn = document.querySelector('#concubine-detail-modal button');
            chatBtn.onclick = () => startAIChat('concubine', c.id);

            document.getElementById('concubine-detail-modal').style.display = 'flex';
        }

        // --- AI èŠå¤©åŠŸèƒ½ ---
        let currentChatTarget = null;
        let currentChatType = ''; // 'concubine' or 'emperor'

        function startAIChat(type, targetId) {
            currentChatType = type;
            if (type === 'concubine') {
                currentChatTarget = STATE.concubines.find(c => c.id === targetId);
                document.getElementById('chat-target-name').innerText = `ä¸ ${currentChatTarget.name} é—²èŠ`;
            } else {
                currentChatTarget = STATE.emperor;
                document.getElementById('chat-target-name').innerText = `ä¸ çš‡ä¸Š é—²èŠ`;
            }
            
            document.getElementById('chat-messages').innerHTML = '';
            document.getElementById('ai-chat-modal').style.display = 'flex';
            
            // åˆå§‹é—®å€™
            addChatMessage('ai', type === 'concubine' ? `å§å§ä»Šæ—¥æ€ä¹ˆæœ‰ç©ºæ¥æ‰¾æˆ‘ï¼Ÿ` : `çˆ±å¦ƒä»Šæ—¥å‰æ¥ï¼Œæ‰€ä¸ºä½•äº‹ï¼Ÿ`);
        }

        function addChatMessage(role, text) {
            const div = document.createElement('div');
            div.className = `message ${role}`;
            div.innerText = text;
            const container = document.getElementById('chat-messages');
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
        }

        async function sendChatMessage() {
            // æ£€æŸ¥è¡ŒåŠ¨ç‚¹
            if (STATE.time.period === 2 && STATE.time.timeSlot >= 6) {
                addChatMessage('ai', '(ç³»ç»Ÿ) æœ¬æœˆè¡ŒåŠ¨ç‚¹å·²ç”¨å°½ï¼Œæ— æ³•ç»§ç»­å¯¹è¯ã€‚');
                return;
            }

            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text) return;
            
            addChatMessage('user', text);
            input.value = '';
            
            // æ¶ˆè€—è¡ŒåŠ¨ç‚¹
            advanceTime();

            // æ„å»º Prompt
            let systemPrompt = "";
            if (currentChatType === 'concubine') {
                systemPrompt = `ä½ ç°åœ¨æ‰®æ¼”å®«æ–—æ¸¸æˆä¸­çš„ä¸€ä½å¦ƒå«”ã€‚
                ä½ çš„åå­—æ˜¯${currentChatTarget.name}ï¼Œä½ä»½æ˜¯${RANKS[currentChatTarget.rank].name}ã€‚
                ä½ çš„æ€§æ ¼æ˜¯${currentChatTarget.trait}ï¼Œå½“å‰å¿ƒæƒ…${currentChatTarget.mood}ï¼Œå¯¹ç©å®¶å¥½æ„Ÿåº¦${currentChatTarget.affection}ã€‚
                ç©å®¶æ˜¯${STATE.player.name}ï¼Œä½ä»½æ˜¯${RANKS[STATE.player.rank].name}ã€‚
                è¯·æ ¹æ®ä½ çš„æ€§æ ¼å’Œå¥½æ„Ÿåº¦å›å¤ç©å®¶ã€‚å›å¤è¦ç®€çŸ­ï¼ˆ50å­—ä»¥å†…ï¼‰ï¼Œç¬¦åˆå¤é£å£å»ã€‚`;
            } else {
                systemPrompt = `ä½ ç°åœ¨æ‰®æ¼”å®«æ–—æ¸¸æˆä¸­çš„çš‡å¸ã€‚
                ä½ çš„æ€§æ ¼æ˜¯${STATE.emperor.trait}ï¼Œå½“å‰å¿ƒæƒ…${STATE.emperor.mood}ã€‚
                ç©å®¶æ˜¯${STATE.player.name}ï¼Œä½ä»½æ˜¯${RANKS[STATE.player.rank].name}ï¼Œåœ£å® ${STATE.player.favor}ã€‚
                è¯·æ ¹æ®ä½ çš„æ€§æ ¼å’Œå¯¹ç©å®¶çš„å® çˆ±ç¨‹åº¦å›å¤ã€‚å›å¤è¦ç®€çŸ­ï¼ˆ50å­—ä»¥å†…ï¼‰ï¼Œç¬¦åˆå¸ç‹å£å»ã€‚`;
            }

            try {
                const response = await callAI(systemPrompt, text);
                addChatMessage('ai', response);
                
                // èŠå¤©å¢åŠ å¥½æ„Ÿ/åœ£å® 
                if (currentChatType === 'concubine') {
                    const gain = Math.floor(Math.random() * 2) + 1; // 1-2ç‚¹
                    currentChatTarget.affection = (currentChatTarget.affection || 0) + gain;
                    showToast(`${currentChatTarget.name}å¥½æ„Ÿ +${gain}`);
                } else {
                    if (Math.random() < 0.5) {
                        STATE.player.favor += 1;
                        showToast("åœ£å®  +1");
                    }
                }
                updateProfileView(); // åˆ·æ–°å¯èƒ½å˜åŒ–çš„å±æ€§
            } catch (e) {
                addChatMessage('ai', '(ç³»ç»Ÿ) ä¼¼ä¹æœ‰äº›å¬ä¸æ¸…...');
            }
        }

        // ... (ä¿ç•™ updatePoints, generateRandomAvatar ç­‰å…¶ä»–å‡½æ•°) ...
        function updatePoints() {
            const inputs = document.querySelectorAll('.stat-input');
            let total = 0;
            inputs.forEach(i => {
                let val = parseInt(i.value);
                if (isNaN(val)) val = 0;
                total += val;
                
                // æ›´æ–°æè¿°
                const statName = i.dataset.stat;
                const descIndex = Math.min(Math.floor(val / 50), 19);
                const desc = ATTR_DESCS[statName][descIndex] || ATTR_DESCS[statName][0];
                document.getElementById(`desc-${statName}`).innerText = desc;
            });
            
            const remaining = 100 - total; 
            document.getElementById('points-left').innerText = remaining;
            
            if (remaining < 0) {
                document.getElementById('points-left').style.color = 'red';
            } else {
                document.getElementById('points-left').style.color = 'inherit';
            }
        }

        // --- å¤´åƒå¤„ç† ---
        function generateRandomAvatar() {
            STATE.player.customAvatar = null;
            STATE.player.avatarSeed = Math.random();
            drawAvatar('avatar-canvas', STATE.player.avatarSeed);
        }

        function handleImageUpload(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    STATE.player.customAvatar = e.target.result;
                    const img = new Image();
                    img.onload = function() {
                        const canvas = document.getElementById('avatar-canvas');
                        const ctx = canvas.getContext('2d');
                        ctx.clearRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                    }
                    img.src = e.target.result;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function drawAvatar(canvasId, seed) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            drawAvatarOnCtx(ctx, canvas.width, canvas.height, seed);
        }

        // æŠ½ç¦»ç»˜åˆ¶é€»è¾‘ï¼Œä»¥ä¾¿å¤ç”¨
        function drawAvatarOnCtx(ctx, w, h, seed) {
            // å¦‚æœæ˜¯ç©å®¶ä¸”æœ‰è‡ªå®šä¹‰å¤´åƒï¼Œè¿™é‡Œéœ€è¦ç‰¹æ®Šå¤„ç†ï¼Œä½†æ­¤å‡½æ•°ä¸»è¦ç”¨äºé€šç”¨ç»˜åˆ¶
            // ç©å®¶å¤´åƒåœ¨ drawAvatar ä¸­å¤„ç†äº†è‡ªå®šä¹‰é€»è¾‘
            
            const random = () => {
                seed = (seed * 9301 + 49297) % 233280;
                return seed / 233280;
            };

            ctx.clearRect(0, 0, w, h);
            
            // èƒŒæ™¯
            const bgColors = ['#fce4ec', '#e8f5e9', '#e3f2fd', '#fff3e0', '#f3e5f5'];
            ctx.fillStyle = bgColors[Math.floor(random() * bgColors.length)];
            ctx.fillRect(0, 0, w, h);

            // èº«ä½“/è¡£æœ
            const clothColors = ['#d32f2f', '#1976d2', '#388e3c', '#7b1fa2', '#fbc02d', '#e91e63', '#009688', '#5d4037', '#455a64'];
            ctx.fillStyle = clothColors[Math.floor(random() * clothColors.length)];
            ctx.beginPath();
            ctx.moveTo(w/2, h);
            ctx.quadraticCurveTo(w/2 - w*0.33, h - h*0.13, w/2 - w*0.3, h - h*0.4); // å·¦è‚©
            ctx.quadraticCurveTo(w/2, h - h*0.46, w/2 + w*0.3, h - h*0.4); // å³è‚©
            ctx.quadraticCurveTo(w/2 + w*0.33, h - h*0.13, w/2, h);
            ctx.fill();
            
            // é¢†å£
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = w * 0.02;
            ctx.beginPath();
            ctx.moveTo(w/2 - w*0.1, h - h*0.4);
            ctx.lineTo(w/2 + w*0.1, h - h*0.4);
            ctx.lineTo(w/2, h - h*0.3);
            ctx.closePath();
            ctx.stroke();

            // è„¸å‹
            ctx.fillStyle = '#ffccbc'; // è‚¤è‰²
            ctx.beginPath();
            ctx.ellipse(w/2, h/2 - h*0.06, w*0.23, h*0.3, 0, 0, Math.PI * 2);
            ctx.fill();

            // å¤´å‘ (å)
            ctx.fillStyle = '#212121';
            ctx.beginPath();
            ctx.arc(w/2, h/2 - h*0.1, w*0.26, Math.PI, 0);
            ctx.fill();

            // å‘é«»
            const bunType = Math.floor(random() * 3);
            if (bunType === 0) { // åŒå¹³é«»
                ctx.beginPath();
                ctx.arc(w/2 - w*0.23, h/2 - h*0.16, w*0.1, 0, Math.PI * 2);
                ctx.arc(w/2 + w*0.23, h/2 - h*0.16, w*0.1, 0, Math.PI * 2);
                ctx.fill();
            } else if (bunType === 1) { // é«˜æ¤é«»
                ctx.beginPath();
                ctx.ellipse(w/2, h/2 - h*0.4, w*0.13, h*0.2, 0, 0, Math.PI * 2);
                ctx.fill();
            } else { // ç‰¡ä¸¹å¤´
                ctx.beginPath();
                ctx.arc(w/2, h/2 - h*0.36, w*0.16, 0, Math.PI * 2);
                ctx.fill();
            }

            // åˆ˜æµ·
            ctx.beginPath();
            ctx.moveTo(w/2 - w*0.23, h/2 - h*0.13);
            ctx.quadraticCurveTo(w/2, h/2 - h*0.03, w/2 + w*0.23, h/2 - h*0.13);
            ctx.quadraticCurveTo(w/2, h/2 - h*0.26, w/2 - w*0.23, h/2 - h*0.13);
            ctx.fill();

            // çœ¼ç›
            ctx.fillStyle = '#000';
            ctx.beginPath();
            ctx.ellipse(w/2 - w*0.08, h/2 - h*0.06, w*0.026, h*0.02, 0, 0, Math.PI * 2);
            ctx.ellipse(w/2 + w*0.08, h/2 - h*0.06, w*0.026, h*0.02, 0, 0, Math.PI * 2);
            ctx.fill();

            // çœ‰æ¯›
            ctx.strokeStyle = '#5d4037';
            ctx.lineWidth = w * 0.006;
            ctx.beginPath();
            ctx.moveTo(w/2 - w*0.13, h/2 - h*0.12);
            ctx.quadraticCurveTo(w/2 - w*0.08, h/2 - h*0.14, w/2 - w*0.03, h/2 - h*0.12);
            ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(w/2 + w*0.13, h/2 - h*0.12);
            ctx.quadraticCurveTo(w/2 + w*0.08, h/2 - h*0.14, w/2 + w*0.03, h/2 - h*0.12);
            ctx.stroke();

            // å˜´å·´
            ctx.strokeStyle = '#d81b60';
            ctx.lineWidth = w * 0.013;
            ctx.beginPath();
            ctx.arc(w/2, h/2 + h*0.1, w*0.03, 0.2, Math.PI - 0.2);
            ctx.stroke();
            
            // è…®çº¢
            ctx.fillStyle = 'rgba(255, 0, 0, 0.1)';
            ctx.beginPath();
            ctx.arc(w/2 - w*0.13, h/2 + h*0.03, w*0.05, 0, Math.PI * 2);
            ctx.arc(w/2 + w*0.13, h/2 + h*0.03, w*0.05, 0, Math.PI * 2);
            ctx.fill();
            
            // å¤´é¥°
            ctx.fillStyle = '#ffd700'; // é‡‘è‰²
            if (random() > 0.5) {
                ctx.beginPath();
                ctx.arc(w/2, h/2 - h*0.36, w*0.03, 0, Math.PI * 2);
                ctx.fill();
                ctx.beginPath();
                ctx.moveTo(w/2, h/2 - h*0.36);
                ctx.lineTo(w/2 - w*0.06, h/2 - h*0.3);
                ctx.stroke();
            }
        }

        function startGame() {
            const name = document.getElementById('input-name').value;
            if (!name) {
                showToast('è¯·è¾“å…¥å§“å');
                return;
            }
            if (!STATE.player.background) {
                showToast('è¯·ç”Ÿæˆå®¶ä¸–');
                return;
            }
            if (!STATE.emperor.name) {
                showToast('è¯·ç”Ÿæˆçš‡å¸ä¿¡æ¯');
                return;
            }
            
            const pointsLeft = parseInt(document.getElementById('points-left').innerText);
            if (pointsLeft < 0) {
                showToast('å±æ€§ç‚¹åˆ†é…è¿‡å¤šï¼');
                return;
            }

            // --- é‡ç½®æ¸¸æˆçŠ¶æ€ ---
            STATE.time = { year: 1, month: 1, period: 0, timeSlot: 0 };
            STATE.player.logs = [];
            STATE.player.children = [];
            STATE.player.servants = [];
            STATE.player.alliances = [];
            STATE.player.enemies = [];
            STATE.player.isPregnant = false;
            STATE.player.pregnancyMonth = 0;
            STATE.player.favor = 0;
            // ------------------
            
            STATE.player.name = name;
            STATE.player.age = parseInt(document.getElementById('input-age').value);
            
            const stats = {};
            document.querySelectorAll('.stat-input').forEach(input => {
                stats[input.dataset.stat] = parseInt(input.value) || 0;
            });
            STATE.player.stats = stats;

            // ç¡®å®šåˆå§‹ä½ä»½ (æ˜ å°„åˆ°27çº§ç³»ç»Ÿ)
            let initialRankIndex = 29; // é»˜è®¤å®˜å¥³å­ (æœ€ä½)
            let initialMoney = 30; // é»˜è®¤åˆå§‹é“¶ä¸¤

            if (STATE.player.bgType === 'official') {
                const level = STATE.player.bgLevel;
                const isDi = STATE.player.isDi;
                
                // åˆå§‹ä½ä»½é€»è¾‘ (æœ€é«˜å¸¸åœ¨-22)
                if (level <= 3) {
                    initialRankIndex = isDi ? 22 : 23; // 1-3å“å«¡å¥³å¸¸åœ¨ï¼Œåº¶å¥³å¨˜å­
                    initialMoney = 500;
                } else if (level <= 6) {
                    initialRankIndex = isDi ? 23 : 24; // 4-6å“å«¡å¥³å¨˜å­ï¼Œåº¶å¥³èˆæ¶“
                    initialMoney = 300;
                } else if (level <= 9) {
                    initialRankIndex = isDi ? 24 : 25; // 7-9å“å«¡å¥³èˆæ¶“ï¼Œåº¶å¥³é€‰ä¾
                    initialMoney = 100;
                } else {
                    initialRankIndex = 27; // ç­”åº”
                    initialMoney = 50;
                }
            } else {
                // å¹³æ°‘/å…¶ä»–èƒŒæ™¯ï¼Œæœ€ä½ä½ä»½
                initialRankIndex = 29; // å®˜å¥³å­
                initialMoney = 20;
            }

            STATE.player.rank = initialRankIndex;
            STATE.player.money = initialMoney;
            const rankName = RANKS[initialRankIndex].name;
            
            generateConcubines(); // ç”Ÿæˆåå®«å¦ƒå«”

            addLog(`å…¥å®«é€‰ç§€ï¼Œ${STATE.player.background}ï¼Œå¹´æ–¹${STATE.player.age}ï¼Œåˆå°ä¸º${rankName}ï¼Œæºå¸¦é“¶ä¸¤${initialMoney}ä¸¤ã€‚`);
            
            // ç«‹å³æ›´æ–°UIä»¥åæ˜ é‡ç½®åçš„çŠ¶æ€
            updateTimeUI();
            updateProfileView();

            const story = generateIntroStory(STATE.player);
            document.getElementById('story-content').innerHTML = story;
            document.getElementById('story-modal').style.display = 'flex';
        }

        function generateIntroStory(player) {
            const rankName = RANKS[player.rank].name;
            const charm = player.stats.charm;
            
            let story = `<p>å®£å’Œä¸‰å¹´æ˜¥ï¼Œç´«ç¦åŸå†…ç‰å…°åˆç»½ï¼Œé¦™é£æ‹‚é¢ã€‚è¿™ä¸€æ—¥ï¼Œæ­£æ˜¯ä¸‰å¹´ä¸€åº¦çš„é€‰ç§€å¤§å…¸ã€‚ç¥æ­¦é—¨å¤–ï¼Œè½¦æ°´é©¬é¾™ï¼Œé¦™è½¦å®é©¬ç»œç»ä¸ç»ã€‚æ¥è‡ªå¤©å—æµ·åŒ—çš„ç§€å¥³ä»¬ï¼Œæ€€æ£ç€å®¶æ—çš„è£è¾±ä¸ä¸ªäººçš„æœŸè®¸ï¼Œè¸å…¥äº†è¿™é“æœ±çº¢è‰²çš„å®«é—¨ã€‚å¤©è‰²å¾®æ˜ï¼Œæ™¨é’Ÿæš®é¼“å£°ä¸­ï¼Œä½ éšç€å¼•è·¯å¤ªç›‘ç¼“ç¼“æ­¥å…¥å¾¡èŠ±å›­ï¼Œè„šä¸‹çš„é’çŸ³æ¿è·¯ä»¿ä½›å»¶ä¼¸è‡³æ— å°½çš„æ·±å®«å²æœˆã€‚</p>`;

            if (player.bgType === 'official') {
                if (player.bgLevel <= 3) {
                    story += `<p>æƒ³ä½ å‡ºèº«åé—¨ï¼Œçˆ¶äº²ä¹ƒæ˜¯æœä¸­é‡è‡£${player.background.split(' ')[1]}ã€‚è‡ªå¹¼é”¦è¡£ç‰é£Ÿï¼Œä¹ å¾—ç´æ£‹ä¹¦ç”»ï¼Œä¸¾æ‰‹æŠ•è¶³é—´çš†æ˜¯å¤§å®¶é—ºç§€çš„é£èŒƒã€‚ä»Šæ—¥å…¥å®«ï¼Œçˆ¶äº²ç‰¹æ„å®å˜±ï¼Œå®¶æ—è£è€€ç³»äºä¸€èº«ï¼Œåˆ‡ä¸å¯è¡Œå·®è¸é”™ã€‚çœ‹ç€å‘¨å›´é‚£äº›å‡ºèº«ä½å¾®çš„ç§€å¥³ä»¬è‰³ç¾¡çš„ç›®å…‰ï¼Œä½ å¿ƒä¸­è™½æœ‰å‡ åˆ†å‚²æ°”ï¼Œå´ä¹Ÿæ·±çŸ¥ä¼´å›å¦‚ä¼´è™çš„é“ç†ï¼Œä¸æ•¢æœ‰ä¸æ¯«æ‡ˆæ€ ã€‚</p>`;
                } else if (player.bgLevel <= 6) {
                    story += `<p>ä½ å‡ºèº«å®˜å®¦äººå®¶ï¼Œè™½éæ˜¾èµ«æƒè´µï¼Œå´ä¹Ÿç®—å¾—ä¸Šä¹¦é¦™é—¨ç¬¬ã€‚çˆ¶äº²${player.background.split(' ')[1]}ä¸ºå®˜æ¸…å»‰ï¼Œå®¶ä¸­æ•™å…»ç”šä¸¥ã€‚ä¸´è¡Œå‰ï¼Œæ¯äº²å«æ³ªä¸ºä½ æ¢³å¦†ï¼Œå®å˜±ä½ åœ¨å®«ä¸­è¦è°¨è¨€æ…è¡Œï¼Œè«è¦å¼ºå‡ºå¤´ã€‚ä½ æœ›ç€è¿™å·å³¨çš„å®«æ®¿ï¼Œå¿ƒä¸­æ—¢æœ‰å¯¹æœªæ¥çš„æ†§æ†¬ï¼Œä¹Ÿæœ‰å¯¹æœªçŸ¥çš„å¿å¿‘ã€‚</p>`;
                } else {
                    story += `<p>ä½ çˆ¶äº²ä¸è¿‡æ˜¯${player.background.split(' ')[1]}è¿™èˆ¬çš„å°å®˜ï¼Œå®¶ä¸–åœ¨ä¼—ç§€å¥³ä¸­å¹¶ä¸å‡ºä¼—ã€‚èƒ½å…¥é€‰ç§€å¥³ï¼Œå·²æ˜¯å®¶æ—è«å¤§çš„è£è€€ã€‚ä½ æ·±çŸ¥è‡ªå·±æ— ä¾æ— é ï¼Œåœ¨è¿™æ·±å®«ä¹‹ä¸­åªèƒ½æ­¥æ­¥ä¸ºè¥ã€‚çœ‹ç€é‚£äº›è¡£ç€åä¸½çš„é«˜é—¨è´µå¥³ï¼Œä½ æš—æš—ä¸‹å®šå†³å¿ƒï¼Œå®šè¦åœ¨è¿™åå®«ä¸­äº‰å¾—ä¸€å¸­ä¹‹åœ°ï¼Œä¸è´Ÿçˆ¶æ¯æœŸæœ›ã€‚</p>`;
                }
            } else {
                story += `<p>ä½ å‡ºèº«${player.background.split(' ')[1]}ï¼Œæœ¬æ— æ„æ”€é¾™é™„å‡¤ï¼Œå¥ˆä½•å¤©å‘½éš¾è¿ã€‚ä¸´è¡Œå‰ï¼Œæ¯äº²å«æ³ªç¼åˆ¶çš„é¦™å›Šå°šåœ¨è¢–ä¸­ï¼Œä½™æ¸©çŠ¹å­˜ã€‚åœ¨è¿™é‡‘ç¢§è¾‰ç…Œçš„å®«æ®¿ä¹‹ä¸­ï¼Œä½ æ˜¾å¾—æ ¼å¤–æ¸ºå°ï¼Œåªèƒ½ä½çœ‰é¡ºçœ¼ï¼Œå”¯æè§¦æ€’äº†è´µäººã€‚ä½ å¿ƒä¸­æ‰€æ±‚ï¼Œä¸è¿‡æ˜¯å¹³å®‰åº¦æ—¥ï¼Œè‹¥èƒ½å¾—å‡ åˆ†åœ£å® ï¼Œä¾¿æ˜¯æ„å¤–ä¹‹å–œäº†ã€‚</p>`;
            }

            story += `<p>å¤§æ®¿ä¹‹ä¸Šï¼Œé‡‘ç¢§è¾‰ç…Œï¼Œé¾™æ¶é¦™æ°”ç¼­ç»•ã€‚ä½ ä¾ç¤¼è·ªæ‹œï¼Œå¿ƒè·³å¦‚é¼“ã€‚`;
            if (charm >= 300) {
                story += `å½“ä½ ç¼“ç¼“æŠ¬é¦–ï¼Œé‚£å€¾å›½å€¾åŸçš„å®¹è²Œä»¤æ»¡æ®¿çš†æƒŠã€‚çš‡ä¸Šçœ¼ä¸­é—ªè¿‡ä¸€ä¸æƒŠè‰³ï¼Œå¤ªåäº¦æ˜¯è¿è¿ç‚¹å¤´ï¼Œèµä½ ï¼šâ€œç«¯åº„ç§€ä¸½ï¼Œå®ä¹ƒåå®«ä¹‹å¹¸ã€‚â€`;
            } else if (charm >= 150) {
                story += `ä½ è§„çŸ©ä¸æ¯«ä¸å·®ï¼Œè™½æ— å€¾å›½å€¾åŸä¹‹è²Œï¼Œå´ä¹Ÿèƒœåœ¨æ¸…ä¸½è„±ä¿—ï¼Œæ¸©å©‰å¯äººã€‚çš‡ä¸Šå¾®å¾®é¢”é¦–ï¼Œä¼¼ä¹å¯¹ä½ é¢‡ä¸ºæ»¡æ„ã€‚`;
            } else {
                story += `ä½ è™½å®¹è²Œå¹³å¹³ï¼Œä½†èƒœåœ¨å®‰åˆ†å®ˆå·±ï¼Œç¤¼æ•°å‘¨å…¨ã€‚å¤ªåè§ä½ è€å®æœ¬åˆ†ï¼Œä¾¿ä¹Ÿç‚¹äº†ç‚¹å¤´ã€‚`;
            }
            story += `</p>`;

            story += `<p>ç‰‡åˆ»åï¼Œåœ£æ—¨å·²ä¸‹ã€‚éšè¡Œçš„å…¬å…¬é«˜å£°å”±å–ï¼šâ€œ${player.background.split(' ')[0]} ${player.name}ï¼Œç€å°ä¸º<strong>${rankName}</strong>ï¼Œèµå±…å‚¨ç§€å®«ï¼â€</p>`;

            story += `<p>è¿™ä¸€å£°å”±å–ï¼Œä¾¿å®šäº†ä½ åŠç”Ÿæµ®æ²‰ã€‚æ¥è¿‡åœ£æ—¨çš„é‚£ä¸€åˆ»ï¼Œä½ åªè§‰æ‰‹ä¸­æ²‰ç”¸ç”¸çš„ã€‚æœ›ç€é‚£é«˜è€¸çš„å®«å¢™ï¼Œä½ æ·±å¸ä¸€å£æ°”ï¼Œä¸çŸ¥è¿™æ·±å®«ä¹‹ä¸­ï¼Œç­‰å¾…ä½ çš„å°†æ˜¯æ³¼å¤©çš„å¯Œè´µï¼Œè¿˜æ˜¯æ— å°½çš„å¯‚å¯¥ã€‚æ— è®ºå¦‚ä½•ï¼Œè¿™æ¡è·¯ï¼Œç»ˆç©¶æ˜¯è¦è‡ªå·±èµ°ä¸‹å»äº†ã€‚</p>`;

            return story;
        }

        function closeStoryModal() {
            document.getElementById('story-modal').style.display = 'none';
            showToast('å…¥å®«æˆåŠŸï¼');
            switchPage('map');
        }

        function showRankTable() {
            const tbody = document.getElementById('rank-table-body');
            tbody.innerHTML = '';
            RANKS.forEach(r => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${r.level}</td>
                    <td>${r.name}</td>
                    <td>
                        ${r.condition}<br>
                        <span style="font-size:0.8rem; color:#8e2e2e;">
                            [éœ€åœ£å® â‰¥${r.minFavor}, å„é¡¹å±æ€§â‰¥${r.minStat}]
                        </span>
                    </td>
                `;
                tbody.appendChild(tr);
            });
            document.getElementById('rank-modal').style.display = 'flex';
        }

        // --- æ¡£æ¡ˆ ---
        function updateProfileView() {
            drawAvatar('profile-avatar-canvas', STATE.player.avatarSeed);
            document.getElementById('profile-name').innerText = STATE.player.name || 'æœªå‘½å';
            
            const rankData = RANKS[STATE.player.rank];
            document.getElementById('profile-rank').innerText = 'ä½åˆ†ï¼š' + (rankData ? rankData.name : 'æœªçŸ¥');
            document.getElementById('profile-bg').innerText = 'å®¶ä¸–ï¼š' + (STATE.player.background || '--');
            
            let nextRank = null;
            if (STATE.player.rank > 0) {
                nextRank = RANKS[STATE.player.rank - 1];
            }
            
            let conditionText = "";
            if (nextRank) {
                conditionText = `è·ç¦»æ™‹å‡ã€${nextRank.name}ã€‘ï¼š${nextRank.condition}`;
            } else {
                conditionText = "å·²è‡³åå®«å·…å³°ã€‚";
            }
            document.getElementById('rank-condition').innerText = conditionText;
            
            // æ›´æ–°æ™‹å‡æŒ‰é’®çŠ¶æ€
            updatePromotionButton();

            // æ›´æ–°å±æ€§æ˜¾ç¤ºå’Œæè¿°
            const stats = ['charm', 'intelligence', 'health', 'social', 'scheme', 'luck'];
            stats.forEach(s => {
                const val = STATE.player.stats[s];
                document.getElementById(`val-${s}`).innerText = val;
                const descIndex = Math.min(Math.floor(val / 50), 10);
                const desc = ATTR_DESCS[s][descIndex] || ATTR_DESCS[s][0];
                document.getElementById(`view-desc-${s}`).innerText = desc;
            });

            document.getElementById('val-favor').innerText = STATE.player.favor;
            document.getElementById('val-money').innerText = STATE.player.money;

            const logContainer = document.getElementById('profile-log');
            if (STATE.player.logs.length > 0) {
                logContainer.innerHTML = STATE.player.logs.map(log => `<p>â€¢ ${log}</p>`).join('');
            } else {
                logContainer.innerHTML = '<p>æš‚æ— è®°å½•...</p>';
            }
        }

        function addLog(msg) {
            const time = new Date().toLocaleTimeString();
            STATE.player.logs.unshift(`[${time}] ${msg}`);
        }

        // --- ç©æ³•ä¸API ---
        function visitLocation(loc) {
            const msgs = [
                `ä½ æ¥åˆ°äº†${loc}ï¼Œå››å¤„çœ‹äº†çœ‹ã€‚`,
                `${loc}ä»Šæ—¥æ ¼å¤–å†·æ¸…ã€‚`,
                `åœ¨${loc}é‡åˆ°äº†ä¸€ä½æ•…äººã€‚`
            ];
            const msg = msgs[Math.floor(Math.random() * msgs.length)];
            document.getElementById('map-message').style.display = 'block';
            document.getElementById('map-message').innerText = msg;
            addLog(`å‰å¾€${loc}ã€‚`);
        }

        // --- å®«æ–—ç©æ³•æ¨¡å— ---
        let currentModule = '';
        let selectedTargetId = -1;
        let currentSchemeType = ''; // è®°å½•å½“å‰æ–½å±•çš„æ‰‹æ®µ

        function openGameModule(module) {
            currentModule = module;
            const modal = document.getElementById('action-select-modal');
            const title = document.getElementById('action-select-title');
            const list = document.getElementById('action-select-list');
            const optionsDiv = document.getElementById('action-options');
            const buttonsDiv = document.getElementById('action-buttons');
            
            optionsDiv.style.display = 'none';
            list.innerHTML = '';
            selectedTargetId = -1;

            if (module === 'scheme') {
                title.innerText = "é€‰æ‹©é™·å®³ç›®æ ‡";
                renderConcubineList(list, true); // æ’é™¤è‡ªå·±å’Œå†·å®«
            } else if (module === 'alliance') {
                title.innerText = "é€‰æ‹©æ‹‰æ‹¢ç›®æ ‡";
                renderConcubineList(list, true);
            } else if (module === 'servant') {
                title.innerText = "å¿ƒè…¹ç®¡ç†";
                renderServantList(list);
                modal.style.display = 'flex';
                return;
            } else if (module === 'family') {
                handleFamilyAction();
                return;
            } else if (module === 'info') {
                title.innerText = "æ‰“æ¢æ¶ˆæ¯";
                renderConcubineList(list, false);
            }

            modal.style.display = 'flex';
        }

        function renderConcubineList(container, excludeCold) {
            STATE.concubines.forEach(c => {
                // æ’é™¤é€»è¾‘ï¼šå¦‚æœexcludeColdä¸ºtrueï¼Œæ’é™¤å†·å®«å’Œæ­»äº¡
                if (excludeCold && (c.state === 'å†·å®«' || c.dead || c.state === 'æš´æ¯™')) return;
                
                const div = document.createElement('div');
                div.className = 'concubine-item';
                
                // çŠ¶æ€æ ·å¼
                let statusStyle = "";
                let statusText = "";
                if (c.dead || c.state === 'æš´æ¯™') {
                    statusStyle = "filter: grayscale(100%); opacity: 0.6; cursor: not-allowed;";
                    statusText = " (äº¡)";
                } else if (c.state === 'å†·å®«') {
                    statusStyle = "filter: sepia(100%); opacity: 0.8;";
                    statusText = " (å†·)";
                } else if (c.isPregnant) {
                    statusText = ` (å­•${c.pregnancyMonth}æœˆ)`;
                }

                div.style.cssText = statusStyle;
                
                div.innerHTML = `
                    <img src="" class="concubine-avatar" id="avatar-c-${c.id}">
                    <div class="concubine-name">${c.name}${statusText}</div>
                    <div class="concubine-rank">${RANKS[c.rank].name}</div>
                    <div style="font-size:0.7rem; color:#888;">å¥½æ„Ÿ:${c.affection || 0}</div>
                `;
                
                // å¼‚æ­¥ç»˜åˆ¶å¤´åƒ
                setTimeout(() => {
                    const canvas = document.createElement('canvas');
                    canvas.width = 60; canvas.height = 60;
                    const ctx = canvas.getContext('2d');
                    drawAvatarOnCtx(ctx, 60, 60, c.avatarSeed);
                    const img = document.getElementById(`avatar-c-${c.id}`);
                    if(img) img.src = canvas.toDataURL();
                }, 0);

                if (!c.dead && c.state !== 'æš´æ¯™') {
                    div.onclick = () => selectTarget(c.id, div);
                }
                
                container.appendChild(div);
            });
        }

        function selectTarget(id, element) {
            selectedTargetId = id;
            document.querySelectorAll('.concubine-item').forEach(el => el.style.borderColor = 'transparent');
            element.style.borderColor = 'var(--primary-color)';
            
            const optionsDiv = document.getElementById('action-options');
            const buttonsDiv = document.getElementById('action-buttons');
            optionsDiv.style.display = 'block';
            buttonsDiv.innerHTML = '';

            if (currentModule === 'scheme') {
                createActionButton(buttonsDiv, 'é€ è°£ (å¿ƒæœº)', () => executeScheme('rumor'));
                createActionButton(buttonsDiv, 'ä¸‹æ¯’ (é“¶ä¸¤)', () => executeScheme('poison'));
                createActionButton(buttonsDiv, 'å·«è›Š (ç¦æœ¯)', () => executeScheme('curse'));
            } else if (currentModule === 'alliance') {
                const isAlly = STATE.player.alliances.includes(id);
                if (isAlly) {
                    createActionButton(buttonsDiv, 'è§£é™¤ç›Ÿçº¦', () => executeAlliance('break'));
                } else {
                    createActionButton(buttonsDiv, 'èµ é€é“¶ä¸¤ (50ä¸¤)', () => executeAlliance('money'));
                    createActionButton(buttonsDiv, 'èµ é€é¦–é¥° (100ä¸¤)', () => executeAlliance('gift'));
                }
            } else if (currentModule === 'info') {
                const target = STATE.concubines.find(c => c.id === id);
                buttonsDiv.innerHTML = `
                    <div style="grid-column: 1/-1; text-align: left; font-size: 0.9rem;">
                        <p>æ€§æ ¼ï¼š${target.trait}</p>
                        <p>å®¹è²Œï¼š${target.charm}</p>
                        <p>çŠ¶æ€ï¼š${target.state}</p>
                        <p>å¥½æ„Ÿï¼š${target.affection || 0}</p>
                    </div>
                `;
            }
        }

        function createActionButton(container, text, onClick) {
            const btn = document.createElement('button');
            btn.className = 'btn btn-small';
            btn.innerText = text;
            btn.onclick = onClick;
            container.appendChild(btn);
        }

        function executeScheme(type) {
            if (STATE.time.period === 2 && STATE.time.timeSlot >= 6) {
                showToast("æœ¬æœˆè¡ŒåŠ¨ç‚¹å·²ç”¨å°½");
                return;
            }

            const target = STATE.concubines.find(c => c.id === selectedTargetId);
            currentSchemeType = type;
            
            if (target.dead || target.state === 'å†·å®«' || target.state === 'æš´æ¯™') {
                showToast("ç›®æ ‡å·²æ— æ³•è¢«é™·å®³");
                return;
            }

            let successRate = 0;
            let cost = 0;
            let msg = "";
            let risk = 0; 

            // ä½ä»½å‹åˆ¶ï¼šå¯¹æ–¹ä½ä»½è¶Šé«˜ï¼ŒæˆåŠŸç‡è¶Šä½ï¼Œåå™¬é£é™©è¶Šé«˜
            const rankDiff = target.rank - STATE.player.rank; // è´Ÿæ•°è¡¨ç¤ºå¯¹æ–¹ä½ä»½é«˜
            let rankPenalty = 0;
            if (rankDiff < 0) {
                rankPenalty = Math.abs(rankDiff) * 8; // æ¯é«˜ä¸€çº§ï¼ŒæˆåŠŸç‡-8%
            }

            // å¿ƒæœºå¯¹æŠ—
            const schemeDiff = STATE.player.stats.scheme - target.scheme;
            
            // ç›Ÿå‹åŠ æˆ
            let allyBonus = 0;
            let allyNames = [];
            STATE.player.alliances.forEach(id => {
                const ally = STATE.concubines.find(c => c.id === id);
                if (ally && !ally.dead && ally.state !== 'å†·å®«') {
                    // ä½ä»½è¶Šé«˜(rankè¶Šå°)ï¼ŒåŠ æˆè¶Šé«˜ï¼›å¿ƒæœºè¶Šé«˜ï¼ŒåŠ æˆè¶Šé«˜
                    const bonus = (30 - ally.rank) * 0.5 + (ally.scheme / 100);
                    allyBonus += bonus;
                    allyNames.push(ally.name);
                }
            });
            
            if (type === 'rumor') {
                if (STATE.player.stats.scheme < 100) {
                    showToast("å¿ƒæœºä¸è¶³100ï¼Œæ— æ³•é€ è°£");
                    return;
                }
                successRate = 50 + (schemeDiff / 10) - rankPenalty + allyBonus;
                risk = 10; // é€ è°£é£é™©è¾ƒä½
                msg = "æ•£å¸ƒè°£è¨€";
            } else if (type === 'poison') {
                cost = 300;
                if (STATE.player.money < cost) { showToast("é“¶ä¸¤ä¸è¶³300ä¸¤"); return; }
                STATE.player.money -= cost;
                
                successRate = 40 + (STATE.player.stats.scheme / 20) - rankPenalty + allyBonus;
                risk = 30; 
                msg = "æš—ä¸­ä¸‹æ¯’";
            } else if (type === 'curse') {
                cost = 500;
                if (STATE.player.money < cost) { showToast("é“¶ä¸¤ä¸è¶³500ä¸¤"); return; }
                STATE.player.money -= cost;

                successRate = 30 + (STATE.player.stats.luck / 10) - (rankPenalty / 2) + (allyBonus / 2); // å·«è›Šå—ç›Ÿå‹å½±å“è¾ƒå°
                risk = 50; // åŸºç¡€æŸ¥å‡ºç‡50%
                msg = "è¡Œå·«è›Šä¹‹æœ¯";
            }

            successRate = Math.max(0, Math.min(95, successRate));
            
            // ç»å¯¹å‹åˆ¶ï¼šå¦‚æœä½ä»½å·®å¤ªå¤§ä¸”å¿ƒæœºä¸è¶³ï¼Œå¿…å®šå¤±è´¥ä¸”åå™¬
            if (rankDiff < -5 && schemeDiff < -200) {
                successRate = 0;
                risk = 100;
            }

            const rollSuccess = Math.random() * 100;
            document.getElementById('action-select-modal').style.display = 'none';

            if (rollSuccess < successRate) {
                // æˆåŠŸ
                STATE.player.stats.scheme += 5;
                let result = "";
                let severe = false;
                
                let allyText = "";
                if (allyNames.length > 0) {
                    allyText = `<br><span style="font-size:0.8rem; color:#8e2e2e;">(ç›Ÿå‹${allyNames[0]}ç­‰äººæš—ä¸­ç›¸åŠ©ï¼ŒæˆåŠŸç‡+${Math.floor(allyBonus)}%)</span>`;
                }

                if (type === 'rumor') {
                    const favorLoss = 30 + Math.floor(Math.random() * 30);
                    target.favor = Math.max(0, target.favor - favorLoss);
                    result = `è°£è¨€å››èµ·ï¼Œ${target.name}åœ£å® å—æŸï¼ˆ-${favorLoss}ï¼‰ã€‚${allyText}`;
                    checkRankDown(target);
                    
                    document.getElementById('explore-title').innerText = "é€ è°£æˆåŠŸ";
                    document.getElementById('explore-text').innerHTML = result;
                    document.getElementById('explore-result-modal').style.display = 'block';
                } else {
                    // ä¸‹æ¯’æˆ–å·«è›Š
                    if (type === 'poison') {
                        if (Math.random() < 0.4) {
                            target.dead = true;
                            target.state = "æš´æ¯™";
                            target.charm = 0;
                            result = `æ¯’è¯å‘ä½œï¼Œ${target.name}æš´æ¯™èº«äº¡ï¼`;
                            severe = true;
                        } else {
                            target.state = "ç—…é‡";
                            target.charm = Math.max(0, target.charm - 300);
                            target.health = Math.max(0, target.health - 50);
                            target.favor = Math.max(0, target.favor - 50);
                            result = `${target.name}ä¸­æ¯’ç—…é‡ï¼Œå®¹è²Œå¤§æŸï¼Œåœ£å® å¤§é™ã€‚`;
                            checkRankDown(target);
                        }
                    } else if (type === 'curse') {
                        target.dead = true;
                        target.state = "æš´æ¯™";
                        result = `å·«è›Šç”Ÿæ•ˆï¼Œ${target.name}æš´æ¯™èº«äº¡ï¼`;
                        severe = true;
                    }

                    // è®°å½•æ¡ˆä»¶
                    const investigationId = Date.now();
                    STATE.investigation.push({
                        id: investigationId,
                        type: type,
                        victim: target.name,
                        culprit: 'player',
                        blameTarget: null,
                        month: STATE.time.month, // è®°å½•å½“å‰æœˆä»½
                        revealTime: STATE.time.month + 1, // ä¸‹ä¸ªæœˆå‡ºç»“æœ
                        risk: risk
                    });

                    // è§¦å‘çš‡ä¸Šå¾—çŸ¥å‰§æƒ…
                    triggerInvestigation(target.name, result, investigationId);
                }
            } else {
                // å¤±è´¥ï¼Œåˆ¤å®šåå™¬
                const rollBackfire = Math.random() * 100;
                // åå™¬æ¦‚ç‡å—ä½ä»½å·®å½±å“
                const backfireChance = 20 + (rankDiff < 0 ? Math.abs(rankDiff) * 10 : 0);
                
                if (rollBackfire < backfireChance) {
                    let penalty = "";
                    if (rankDiff < 0) {
                        // è¢«é«˜ä½åå‡»
                        STATE.player.favor -= 50;
                        STATE.player.stats.social -= 20;
                        penalty = `ä½ é™·å®³${target.name}ä¸æˆï¼Œåè¢«å…¶å¯Ÿè§‰ï¼å¥¹å‘çš‡ä¸Šå“­è¯‰ï¼Œä½ åœ£å® å¤§é™(-50)ï¼Œåå£°æ‰«åœ°ã€‚`;
                    } else {
                        STATE.player.favor -= 20;
                        penalty = "æ‰‹æ®µæ‹™åŠ£ï¼Œè™½æœªè¢«å½“åœºæŠ“è·ï¼Œä½†å®«ä¸­å·²æœ‰é£è¨€é£è¯­ï¼Œåœ£å® ç•¥æœ‰ä¸‹é™(-20)ã€‚";
                    }
                    
                    document.getElementById('explore-title').innerText = "é™·å®³å¤±è´¥";
                    document.getElementById('explore-text').innerHTML = penalty;
                    document.getElementById('explore-result-modal').style.display = 'block';
                    checkPlayerStatus();
                } else {
                    document.getElementById('explore-title').innerText = "é™·å®³å¤±è´¥";
                    document.getElementById('explore-text').innerHTML = "æ­¤æ¬¡è¡ŒåŠ¨æœªèƒ½æˆåŠŸï¼Œå¥½åœ¨å¹¶æœªæš´éœ²è¡Œè¸ªã€‚";
                    document.getElementById('explore-result-modal').style.display = 'block';
                }
            }
            
            advanceTime();
            updateProfileView();
        }

        function triggerInvestigation(victimName, resultText, investigationId) {
            // çš‡ä¸Šå¾—çŸ¥å‰§æƒ…
            const stories = [
                `çš‡ä¸Šå¬é—»${victimName}ä¹‹äº‹ï¼Œé¾™é¢œå¤§æ€’ï¼Œæ‹æ¡ˆè€Œèµ·ï¼šâ€œæŸ¥ï¼ç»™æœ•å½»æŸ¥ï¼æœ•å€’è¦çœ‹çœ‹æ˜¯è°å¦‚æ­¤å¤§èƒ†ï¼â€`,
                `å…»å¿ƒæ®¿å†…ï¼Œçš‡ä¸Šçœ‹ç€å¥æŠ˜ï¼Œå¬é—»${victimName}è¢«å®³ï¼Œé¢è‰²é˜´æ²‰å¦‚æ°´ã€‚è‰¯ä¹…ï¼Œä»–å†·å£°é“ï¼šâ€œä¼ ä»¤æ…åˆ‘å¸ï¼ŒåŠ¡å¿…æŸ¥ä¸ªæ°´è½çŸ³å‡ºã€‚â€`,
                `çš‡ä¸Šèµ¶åˆ°${victimName}å®«ä¸­ï¼Œè§å…¶æƒ¨çŠ¶ï¼Œç—›å¿ƒç–¾é¦–ã€‚ä»–ç´§æ¡${victimName}çš„æ‰‹ï¼Œèª“è¦ä¸ºå…¶è®¨å›å…¬é“ã€‚`
            ];
            const story = stories[Math.floor(Math.random() * stories.length)];
            
            document.getElementById('explore-title').innerText = "æš—å®³æˆåŠŸ";
            document.getElementById('explore-text').innerHTML = `${resultText}<br><br><strong>ã€çš‡ä¸Šå¾—çŸ¥ã€‘</strong><br>${story}<br><br>æ­¤äº‹å·²äº¤ç”±æ…åˆ‘å¸å½»æŸ¥ï¼Œä¸‹æœˆå°†å‡ºç»“æœã€‚`;
            
            // è¦†ç›–å…³é—­æŒ‰é’®ï¼Œç‚¹å‡»åè¿›å…¥å«ç¥¸é€‰æ‹©
            const btn = document.querySelector('#explore-result-modal .btn');
            // ç§»é™¤æ—§çš„ç›‘å¬å™¨ï¼ˆé€šè¿‡å…‹éš†èŠ‚ç‚¹ï¼‰
            const newBtn = btn.cloneNode(true);
            btn.parentNode.replaceChild(newBtn, btn);
            
            newBtn.onclick = function() {
                document.getElementById('explore-result-modal').style.display = 'none';
                // æ¢å¤é»˜è®¤è¡Œä¸º
                newBtn.onclick = function() { document.getElementById('explore-result-modal').style.display = 'none'; };
                
                // è¯¢é—®å«ç¥¸
                showBlameModal(investigationId);
            };
            
            document.getElementById('explore-result-modal').style.display = 'block';
        }

        function showBlameModal(investigationId) {
            // æ£€æŸ¥å¿ƒæœº
            if (STATE.player.stats.scheme < 100) {
                showToast("å¿ƒæœºä¸è¶³100ï¼Œæ— æ³•å¸ƒç½®å«ç¥¸å±€");
                return;
            }

            const list = document.getElementById('blame-list');
            list.innerHTML = '';
            
            STATE.concubines.forEach(c => {
                if (c.dead || c.state === 'å†·å®«' || c.state === 'æš´æ¯™' || c.id === selectedTargetId) return;
                
                const div = document.createElement('div');
                div.className = 'concubine-item';
                div.innerHTML = `
                    <img src="" class="concubine-avatar" id="avatar-b-${c.id}">
                    <div class="concubine-name">${c.name}</div>
                    <div class="concubine-rank">${RANKS[c.rank].name}</div>
                `;
                
                setTimeout(() => {
                    const canvas = document.createElement('canvas');
                    canvas.width = 60; canvas.height = 60;
                    const ctx = canvas.getContext('2d');
                    drawAvatarOnCtx(ctx, 60, 60, c.avatarSeed);
                    const img = document.getElementById(`avatar-b-${c.id}`);
                    if(img) img.src = canvas.toDataURL();
                }, 0);

                div.onclick = () => confirmBlame(c, investigationId);
                list.appendChild(div);
            });
            
            document.getElementById('blame-modal').style.display = 'flex';
        }

        function confirmBlame(target, investigationId) {
            // æ›´æ–°æ¡ˆä»¶
            const caseData = STATE.investigation.find(i => i.id === investigationId);
            if (caseData) {
                caseData.blameTarget = target.name;
                caseData.blameTargetId = target.id;
                
                // å«ç¥¸å‰§æƒ…
                const story = `ä½ å¿ƒæ€ç¼œå¯†ï¼Œå‘½å¿ƒè…¹å°†${currentSchemeType === 'curse' ? 'åˆ»æœ‰ç”Ÿè¾°å…«å­—çš„æœ¨å¶' : 'æœªç”¨å°½çš„æ¯’è¯ç²‰æœ«'}æ‚„æ‚„è—å…¥äº†${target.name}çš„å¦†å¥æ·±å¤„ã€‚è¿™ä¸€åˆ‡åšå¾—ç¥ä¸çŸ¥é¬¼ä¸è§‰ï¼Œåªå¾…æ…åˆ‘å¸æœæŸ¥...`;
                
                document.getElementById('blame-modal').style.display = 'none';
                
                document.getElementById('explore-title').innerText = "å«ç¥¸å¸ƒå±€";
                document.getElementById('explore-text').innerHTML = story;
                document.getElementById('explore-result-modal').style.display = 'block';
                
                addLog(`é™·å®³${caseData.victim}å¹¶å«ç¥¸ç»™${target.name}ã€‚`);
            }
        }

        function cancelBlame() {
            document.getElementById('blame-modal').style.display = 'none';
        }

        function resolveInvestigation() {
            const currentMonth = STATE.time.month;
            // æŸ¥æ‰¾æ‰€æœ‰éœ€è¦åœ¨æœ¬æœˆæ­æ™“çš„æ¡ˆä»¶
            // æ³¨æ„ï¼šå¦‚æœæ˜¯12æœˆå‘ç”Ÿçš„ï¼Œä¸‹ä¸ªæœˆæ˜¯1æœˆï¼Œè¿™é‡Œç®€å•å¤„ç†ï¼Œå‡è®¾å¹´ä»½å¢åŠ æœˆä»½é‡ç½®
            // å®é™…ä¸Š STATE.time.month åœ¨ nextMonth é‡Œå·²ç»å¢åŠ äº†
            
            // è¿‡æ»¤å‡º revealTime ç­‰äºå½“å‰æœˆä»½çš„æ¡ˆä»¶ï¼ˆæˆ–è€…ä¹‹å‰çš„ï¼Œé˜²æ­¢æ¼æ‰ï¼‰
            // ç”±äº nextMonth å…ˆå¢åŠ æœˆä»½ï¼Œæ‰€ä»¥è¿™é‡Œæ£€æŸ¥çš„æ˜¯å¢åŠ åçš„æœˆä»½
            // æ¯”å¦‚1æœˆå‘ç”Ÿï¼ŒrevealTime=2ï¼ŒnextMonthæŠŠmonthå˜ä¸º2ï¼Œè¿™é‡Œå°±åŒ¹é…ä¸Šäº†
            
            const cases = STATE.investigation.filter(i => {
                let reveal = i.revealTime;
                if (reveal > 12) reveal -= 12; // è·¨å¹´å¤„ç†
                return reveal === currentMonth && !i.resolved;
            });

            if (cases.length === 0) return;

            let resultHtml = "";
            
            cases.forEach(c => {
                c.resolved = true;
                let detected = false;
                let blameSuccess = false;

                if (c.blameTarget) {
                    // æœ‰å«ç¥¸å¯¹è±¡ï¼Œåˆ¤å®šå«ç¥¸æ˜¯å¦æˆåŠŸ
                    // æˆåŠŸç‡ = åŸºç¡€50% + (ç©å®¶å¿ƒæœº - ç›®æ ‡å¿ƒæœº)/10
                    const target = STATE.concubines.find(x => x.id === c.blameTargetId);
                    const targetScheme = target ? target.scheme : 50;
                    const successRate = 50 + (STATE.player.stats.scheme - targetScheme) / 10;
                    
                    if (Math.random() * 100 < successRate) {
                        blameSuccess = true;
                    } else {
                        // å«ç¥¸å¤±è´¥ï¼Œå¯èƒ½æŸ¥åˆ°ç©å®¶
                        if (Math.random() * 100 < 50) detected = true;
                    }
                } else {
                    // æ— å«ç¥¸ï¼Œç›´æ¥åˆ¤å®šæ˜¯å¦æŸ¥å‡ºç©å®¶
                    // æŸ¥å‡ºç‡ = åŸºç¡€risk
                    if (Math.random() * 100 < c.risk) detected = true;
                }

                if (blameSuccess) {
                    resultHtml += `<p>å…³äº<strong>${c.victim}</strong>è¢«å®³ä¸€æ¡ˆï¼Œæ…åˆ‘å¸åœ¨<strong>${c.blameTarget}</strong>å®«ä¸­æœå‡ºç½ªè¯ï¼çš‡ä¸Šéœ‡æ€’ï¼Œå°†å…¶æ‰“å…¥å†·å®«ï¼ä½ æˆåŠŸç½®èº«äº‹å¤–ã€‚</p>`;
                    // å¤„ç†æ›¿ç½ªç¾Š
                    const scapegoat = STATE.concubines.find(x => x.id === c.blameTargetId);
                    if (scapegoat) {
                        scapegoat.state = "å†·å®«";
                        scapegoat.favor = 0;
                        scapegoat.rank = 29;
                    }
                } else if (detected) {
                    // æ£€æŸ¥ç›Ÿå‹æ˜¯å¦å¸®å¿™é¡¶ç½ª/æ±‚æƒ…
                    let savedByAlly = false;
                    let allyName = "";
                    
                    for (let id of STATE.player.alliances) {
                        const ally = STATE.concubines.find(x => x.id === id);
                        if (ally && !ally.dead && ally.state !== 'å†·å®«') {
                            // å¸®å¿™æ¦‚ç‡ï¼šå¥½æ„Ÿåº¦ + å¿ƒæœº/10
                            const helpChance = (ally.affection || 0) + (ally.scheme / 10);
                            if (Math.random() * 100 < helpChance) {
                                savedByAlly = true;
                                allyName = ally.name;
                                break;
                            }
                        }
                    }

                    if (savedByAlly) {
                        resultHtml += `<p>å…³äº<strong>${c.victim}</strong>è¢«å®³ä¸€æ¡ˆï¼Œæ…åˆ‘å¸æœ¬å·²æŸ¥åˆ°ä½ å¤´ä¸Šï¼Œå¹¸å¾—ç›Ÿå‹<strong>${allyName}</strong>ä»ä¸­å‘¨æ—‹ï¼Œä¸ºä½ æ´—è„±äº†å«Œç–‘ï¼çš‡ä¸Šè™½æœ‰ç–‘è™‘ï¼Œä½†å¹¶æœªæ·±ç©¶ã€‚</p>`;
                    } else {
                        resultHtml += `<p>å…³äº<strong>${c.victim}</strong>è¢«å®³ä¸€æ¡ˆï¼Œæ…åˆ‘å¸é¡ºè—¤æ‘¸ç“œï¼Œç«ŸæŸ¥åˆ°äº†ä½ å®«ä¸­ï¼çš‡ä¸Šå¤§å¤±æ‰€æœ›ï¼Œåœ£å® -100ï¼Œé™ä¸ºå®˜å¥³å­ï¼</p>`;
                        STATE.player.favor -= 100;
                        STATE.player.rank = 29;
                        checkPlayerStatus();
                    }
                } else {
                    resultHtml += `<p>å…³äº<strong>${c.victim}</strong>è¢«å®³ä¸€æ¡ˆï¼Œæ…åˆ‘å¸æŸ¥æ— å®æ®ï¼Œæœ€ç»ˆæˆäº†æ‚¬æ¡ˆã€‚</p>`;
                }
            });

            if (resultHtml) {
                document.getElementById('explore-title').innerText = "æ¡ˆä»¶ç»“æœ";
                document.getElementById('explore-text').innerHTML = resultHtml;
                document.getElementById('explore-result-modal').style.display = 'block';
            }
        }

        function nextMonth() {
            // å…³é—­å¯èƒ½æ‰“å¼€çš„åœ°ç‚¹è¯¦æƒ…é¡µï¼ˆå¦‚æœåœ¨å†·å®«ä¸­ï¼Œè¿™æ˜¯å¿…é¡»çš„ï¼Œå¦åˆ™ä¼šè¢«é®æŒ¡ï¼‰
            document.getElementById('location-detail-page').style.display = 'none';
            document.getElementById('month-summary-modal').style.display = 'flex';
        }

        async function processNextMonth(type) {
            document.getElementById('month-summary-modal').style.display = 'none';

            // 1. æ¨è¿›æ—¶é—´
            STATE.time.month++;
            if (STATE.time.month > 12) {
                STATE.time.month = 1;
                STATE.time.year++;
            }
            STATE.time.period = 0;
            STATE.time.timeSlot = 0;
            
            // 2. ç»“ç®—æŸ¥æ¡ˆ (åœ¨æ–°æœˆä»½è°ƒç”¨)
            resolveInvestigation();
            
            // 3. å‘æ”¾æœˆé“¶ (å†·å®«ä¸­æ²¡æœ‰æœˆé“¶ï¼Œæˆ–è€…å¾ˆå°‘)
            let salary = (30 - STATE.player.rank) * 10 + 20;
            if (STATE.player.inColdPalace) salary = 0; // å†·å®«æ— æœˆé“¶
            
            if (salary > 0) {
                STATE.player.money += salary;
                showToast(`å‘æ”¾æœˆé“¶ ${salary} ä¸¤`);
                addLog(`è¿›å…¥${STATE.time.year}å¹´${STATE.time.month}æœˆï¼Œå‘æ”¾æœˆé“¶${salary}ä¸¤ã€‚`);
            } else {
                addLog(`è¿›å…¥${STATE.time.year}å¹´${STATE.time.month}æœˆï¼Œå†·å®«å‡„æ¸…ï¼Œæ— æœˆé“¶å‘æ”¾ã€‚`);
            }
            
            // 4. ç›Ÿå‹äº’åŠ¨ (éšæœº)
            STATE.player.alliances.forEach(id => {
                const ally = STATE.concubines.find(c => c.id === id);
                if (ally && !ally.dead && ally.state !== 'å†·å®«') {
                    if (Math.random() < 0.3) { // 30%æ¦‚ç‡è§¦å‘
                        const events = [
                            { text: `ç›Ÿå‹${ally.name}æ´¾äººé€æ¥äº†ä¸€äº›é“¶ä¸¤ï¼Œä»¥æ­¤èµ„åŠ©ä½ åœ¨å®«ä¸­çš„å¼€é”€ã€‚`, money: 50 },
                            { text: `ç›Ÿå‹${ally.name}å‘Šè¯‰ä½ ï¼Œçš‡ä¸Šæœ€è¿‘åçˆ±${STATE.emperor.like}ï¼Œè®©ä½ å¤šåŠ æ³¨æ„ã€‚`, favor: 2 },
                            { text: `ç›Ÿå‹${ally.name}åœ¨å¤ªåé¢å‰ç¾è¨€äº†å‡ å¥ï¼Œä½ çš„åå£°æœ‰æ‰€æå‡ã€‚`, social: 5 }
                        ];
                        const evt = events[Math.floor(Math.random() * events.length)];
                        if (evt.money) STATE.player.money += evt.money;
                        if (evt.favor) STATE.player.favor += evt.favor;
                        if (evt.social) STATE.player.stats.social += evt.social;
                        addLog(evt.text);
                    }
                }
            });

            // 5. æ­»æ•Œäº’åŠ¨
            enemyAction();

            // 6. å«”å¦ƒåŠ¨æ€ï¼ˆæ€€å­•ã€ç”Ÿå­ã€éšæœºäº‹ä»¶ï¼‰
            updateConcubinesStatus();
            
            // 7. å®´ä¼šæ£€æŸ¥
            checkBanquet();
            if ((STATE.time.month === 3 || STATE.time.month === 9) && !STATE.player.inColdPalace) {
                showToast("æœ¬æœˆæœ‰å®«å»·å®´ä¼šï¼Œè¯·å‰å¾€ç©æ³•é¡µé¢å‚åŠ ");
            }

            // 8. åˆ·æ–°UI
            updateTimeUI();
            updateProfileView();
            updateEmperorLocation();

            // å¦‚æœåœ¨å†·å®«ä¸­ï¼Œåˆ·æ–°å†·å®«ç•Œé¢
            if (STATE.player.inColdPalace) {
                openColdPalaceSpecial();
            }

            // 9. ç”Ÿæˆæ€»ç»“
            if (type === 'ai') {
                // æå–æœ€è¿‘çš„æ—¥å¿—ä½œä¸ºä¸Šä¸‹æ–‡
                const recentLogs = STATE.player.logs.slice(0, 5).join("\n");
                const context = {
                    year: STATE.time.year,
                    month: STATE.time.month,
                    player: STATE.player.name,
                    rank: RANKS[STATE.player.rank].name,
                    inColdPalace: STATE.player.inColdPalace,
                    recentEvents: recentLogs
                };
                
                const systemPrompt = "ä½ æ˜¯ä¸€ä¸ªå®«æ–—æ¸¸æˆçš„æ•…äº‹å™è¿°è€…ã€‚è¯·æ ¹æ®ç©å®¶çš„å½“å‰çŠ¶æ€å’Œæœ€è¿‘å‘ç”Ÿçš„äº‹ä»¶ï¼Œç”Ÿæˆä¸€æ®µç”ŸåŠ¨çš„æœˆåº¦æ€»ç»“ï¼ˆ100å­—å·¦å³ï¼‰ã€‚";
                const userPrompt = JSON.stringify(context);
                
                document.getElementById('explore-title').innerText = "æœˆåº¦æ€»ç»“ (AIç”Ÿæˆä¸­...)";
                document.getElementById('explore-text').innerText = "æ­£åœ¨æ’°å†™...";
                document.getElementById('explore-result-modal').style.display = 'block';
                
                try {
                    const summary = await callAI(systemPrompt, userPrompt);
                    document.getElementById('explore-title').innerText = "æœˆåº¦æ€»ç»“";
                    document.getElementById('explore-text').innerText = summary;
                } catch (e) {
                    document.getElementById('explore-text').innerText = "AIç”Ÿæˆå¤±è´¥ï¼Œè¯·æŸ¥çœ‹ç”Ÿå¹³è®°äº‹ã€‚";
                }
            } else {
                // ç³»ç»Ÿç®€æŠ¥
                document.getElementById('explore-title').innerText = "æœˆåº¦æ€»ç»“";
                document.getElementById('explore-text').innerHTML = `
                    <p>æ—¶é—´æµè½¬ï¼Œåˆæ˜¯ä¸€æœˆã€‚</p>
                    <p>å½“å‰ä½ä»½ï¼š${RANKS[STATE.player.rank].name}</p>
                    <p>å½“å‰åœ£å® ï¼š${STATE.player.favor}</p>
                    <p>æœ¬æœˆæ”¶æ”¯ï¼š${salary > 0 ? '+' + salary : 'æ— '}</p>
                    <p>å®«ä¸­é£äº‘å˜å¹»ï¼Œè¿˜éœ€æ­¥æ­¥ä¸ºè¥ã€‚</p>
                `;
                document.getElementById('explore-result-modal').style.display = 'block';
            }
        }

        function updateConcubinesStatus() {
            STATE.concubines.forEach(c => {
                if (c.dead || c.state === 'å†·å®«' || c.state === 'æš´æ¯™') return;
                
                // æ€€å­•é€»è¾‘
                if (c.isPregnant) {
                    c.pregnancyMonth++;
                    if (c.pregnancyMonth >= 10) {
                        c.isPregnant = false;
                        c.pregnancyMonth = 0;
                        const childSex = Math.random() > 0.5 ? 'çš‡å­' : 'å…¬ä¸»';
                        addLog(`${c.name}è¯ä¸‹äº†${childSex}ï¼Œæ™‹å‡ä¸€çº§ã€‚`);
                        c.rank = Math.max(0, c.rank - 1);
                        c.favor += 50;
                    }
                } else {
                    // éšæœºæ€€å­•
                    if (Math.random() < 0.02) { // 2%æ¦‚ç‡
                        c.isPregnant = true;
                        c.pregnancyMonth = 1;
                        addLog(`${c.name}è¢«è¯Šå‡ºå–œè„‰ã€‚`);
                    }
                }
                
                // éšæœºåœ£å® å˜åŠ¨
                const change = Math.floor(Math.random() * 10) - 5;
                c.favor = Math.max(0, c.favor + change);
                
                checkRankDown(c);
                checkRankUp(c);
            });
        }

        function checkRankDown(concubine) {
            const currentRank = RANKS[concubine.rank];
            if (!currentRank) return;
            
            // å¦‚æœåœ£å® ä½äºæ ‡å‡†å¤ªå¤šï¼Œé™ä½
            if (concubine.favor < (currentRank.minFavor - 30)) {
                const oldRankName = currentRank.name;
                concubine.rank = Math.min(29, concubine.rank + 1);
                const newRankName = RANKS[concubine.rank].name;
                addLog(`${concubine.name}å› åœ£å® æ·¡è–„ï¼Œç”±${oldRankName}é™ä¸º${newRankName}ã€‚`);
            }
        }

        function checkRankUp(concubine) {
            const currentRank = RANKS[concubine.rank];
            if (!currentRank || concubine.rank <= 0) return;
            
            const nextRank = RANKS[concubine.rank - 1];
            // ç®€å•åˆ¤å®šï¼šåœ£å® å¤Ÿé«˜ä¸”æœ‰ç©ºä½ï¼ˆè¿™é‡Œç®€åŒ–ï¼Œä¸ä¸¥æ ¼æ£€æŸ¥ç©ºä½ï¼Œåªçœ‹åœ£å® ï¼‰
            if (concubine.favor > (nextRank.minFavor + 50)) {
                const oldRankName = currentRank.name;
                concubine.rank--;
                const newRankName = nextRank.name;
                addLog(`${concubine.name}åœ£å® ä¼˜æ¸¥ï¼Œç”±${oldRankName}æ™‹ä¸º${newRankName}ã€‚`);
            }
        }

        function checkPlayerStatus() {
            if (STATE.player.favor <= -50 && !STATE.player.inColdPalace) {
                alert("åœ£å® è¿‡ä½ï¼Œçš‡ä¸Šé¾™é¢œå¤§æ€’ï¼Œé™æ—¨å°†ä½ æ‰“å…¥å†·å®«ï¼\nä»æ­¤ç¦è¶³äºæ­¤ï¼Œéè¯ä¸å¾—å‡ºã€‚");
                
                STATE.player.inColdPalace = true;
                STATE.player.rank = 29; // é™ä¸ºå®˜å¥³å­
                STATE.player.favor = -50;
                STATE.player.coldPalaceProgress = 0;
                
                enterColdPalaceMode();
            }
        }

        function enterColdPalaceMode() {
            switchPage('map');
            // æ»šåŠ¨åœ°å›¾åˆ°å†·å®«ä½ç½® (å·¦ä¸Šè§’)
            const viewport = document.getElementById('map-viewport');
            if (viewport) {
                viewport.scrollLeft = 0;
                viewport.scrollTop = 0;
            }
            openColdPalaceSpecial();
        }

        function openColdPalaceSpecial() {
            const loc = LOCATIONS['å†·å®«'];
            document.getElementById('loc-title').innerText = "å†·å®« (ç¦è¶³ä¸­)";
            document.getElementById('loc-desc').innerText = "æ®‹å£æ–­å£ï¼Œå‡„å‡‰è§ç‘Ÿã€‚ä½ è¢«ç¦è¶³äºæ­¤ï¼Œéœ€æƒ³æ–¹è®¾æ³•é‡è·åœ£å¿ƒã€‚";
            document.getElementById('loc-bg-img').src = loc.bg;
            
            // éšè—å…³é—­æŒ‰é’®
            document.querySelector('.loc-close').style.display = 'none';
            
            // éšè—å­åœ°ç‚¹
            document.getElementById('sub-loc-container').style.display = 'none';

            // æ¸²æŸ“ç‰¹æ®ŠåŠ¨ä½œ
            const actionList = document.getElementById('loc-actions-list');
            actionList.innerHTML = '';
            
            const actions = [
                { name: "æŠ„å†™ç»ä¹¦", icon: "âœï¸", desc: "ä¿®èº«å…»æ€§ï¼Œå¹³å¤å¿ƒæƒ…ã€‚(æ‰æƒ…+1ï¼Œå¤å‡ºè¿›åº¦+1)", cost: "action" },
                { name: "åšé’ˆçº¿æ´»", icon: "ğŸª¡", desc: "æ¢å–äº›è®¸é“¶ä¸¤åº¦æ—¥ã€‚(é“¶ä¸¤+5)", cost: "action" },
                { name: "è´¿èµ‚å®ˆå«", icon: "ğŸ’°", desc: "æ‰“ç‚¹å®ˆå«ï¼Œå¯»æ‰¾æœºä¼šã€‚(é“¶ä¸¤-50ï¼Œå¤å‡ºè¿›åº¦+5)", cost: "action" },
                { name: "è¿›å…¥ä¸‹ä¸€æœˆ", icon: "ğŸŒ™", desc: "åº¦æ—¥å¦‚å¹´ï¼Œç­‰å¾…è½¬æœºã€‚", cost: "month" }
            ];

            // æ˜¾ç¤ºè¿›åº¦
            const progressDiv = document.createElement('div');
            progressDiv.style.gridColumn = "1/-1";
            progressDiv.style.padding = "10px";
            progressDiv.style.background = "rgba(0,0,0,0.5)";
            progressDiv.style.borderRadius = "4px";
            progressDiv.style.marginBottom = "10px";
            progressDiv.innerHTML = `
                <div style="color:#fff; margin-bottom:5px;">å¤å‡ºè¿›åº¦ï¼š${STATE.player.coldPalaceProgress}/100</div>
                <div style="width:100%; height:10px; background:#555; border-radius:5px;">
                    <div style="width:${Math.min(100, STATE.player.coldPalaceProgress)}%; height:100%; background:#d4af37; border-radius:5px; transition:width 0.3s;"></div>
                </div>
            `;
            actionList.appendChild(progressDiv);

            actions.forEach(act => {
                const div = document.createElement('div');
                div.className = 'action-card';
                div.innerHTML = `
                    <div class="action-icon">${act.icon}</div>
                    <div class="action-info">
                        <h4>${act.name}</h4>
                        <p class="action-desc">${act.desc}</p>
                    </div>
                `;
                div.onclick = () => handleColdPalaceAction(act);
                actionList.appendChild(div);
            });

            document.getElementById('location-detail-page').style.display = 'flex';
        }

        function handleColdPalaceAction(action) {
            if (action.cost === 'month') {
                nextMonth();
                return;
            }

            if (STATE.time.period === 2 && STATE.time.timeSlot >= 6) {
                showToast("æœ¬æœˆè¡ŒåŠ¨ç‚¹å·²ç”¨å°½ï¼Œè¯·è¿›å…¥ä¸‹ä¸€æœˆã€‚");
                return;
            }

            let msg = "";
            if (action.name === "æŠ„å†™ç»ä¹¦") {
                STATE.player.stats.intelligence += 1;
                STATE.player.coldPalaceProgress += 1;
                msg = "ä½ é™å¿ƒæŠ„å†™ç»ä¹¦ï¼Œå†…å¿ƒç¨æ„Ÿå¹³é™ã€‚";
            } else if (action.name === "åšé’ˆçº¿æ´»") {
                STATE.player.money += 5;
                msg = "ä½ åšäº†ä¸€äº›é’ˆçº¿æ´»ï¼Œæ‰˜äººå–äº†æ¢å¾—5ä¸¤é“¶å­ã€‚";
            } else if (action.name === "è´¿èµ‚å®ˆå«") {
                if (STATE.player.money < 50) {
                    showToast("é“¶ä¸¤ä¸è¶³50ä¸¤");
                    return;
                }
                STATE.player.money -= 50;
                STATE.player.coldPalaceProgress += 5;
                msg = "ä½ æ‰“ç‚¹äº†å®ˆå«ï¼Œå®ˆå«ç­”åº”å¸®ä½ ä¼ é€’æ¶ˆæ¯ã€‚";
            }

            advanceTime();
            showToast(msg);
            
            // æ£€æŸ¥å¤å‡º
            if (STATE.player.coldPalaceProgress >= 100) {
                alert("ã€å¤å‡ºã€‘\nç»è¿‡ä½ çš„ä¸æ‡ˆåŠªåŠ›ï¼Œçš‡ä¸Šç»ˆäºæƒ³èµ·äº†ä½ ï¼Œä¸‹æ—¨è®©ä½ æ¬å‡ºå†·å®«ï¼\nè™½ç„¶ä½ä»½ä½å¾®ï¼Œä½†ç»ˆç©¶æ˜¯é‡è§å¤©æ—¥äº†ã€‚");
                STATE.player.inColdPalace = false;
                STATE.player.favor = 0;
                STATE.player.coldPalaceProgress = 0;
                document.getElementById('location-detail-page').style.display = 'none';
                switchPage('map');
                addLog("æˆåŠŸä»å†·å®«å¤å‡ºï¼Œé‡è·æ–°ç”Ÿã€‚");
            } else {
                // åˆ·æ–°ç•Œé¢
                openColdPalaceSpecial();
            }
        }

        function executeAlliance(type) {
            const target = STATE.concubines.find(c => c.id === selectedTargetId);

            if (type === 'break') {
                if (confirm(`ç¡®å®šè¦ä¸${target.name}è§£é™¤ç›Ÿçº¦å—ï¼Ÿæ­¤ä¸¾å°†å¯¼è‡´å¥½æ„Ÿå¤§å¹…ä¸‹é™ï¼`)) {
                    STATE.player.alliances = STATE.player.alliances.filter(id => id !== target.id);
                    target.affection -= 50;
                    updateFactionInfo();
                    document.getElementById('action-select-modal').style.display = 'none';
                    showToast("å·²è§£é™¤ç›Ÿçº¦");
                    addLog(`ä¸${target.name}è§£é™¤ç›Ÿçº¦ï¼Œåç›®æˆä»‡ã€‚`);
                    advanceTime();
                    updateProfileView();
                }
                return;
            }

            if (STATE.player.money < (type === 'money' ? 50 : 100)) {
                showToast("é“¶ä¸¤ä¸è¶³");
                return;
            }
            
            STATE.player.money -= (type === 'money' ? 50 : 100);
            
            if (!target.affection) target.affection = 0;
            const gain = type === 'money' ? 5 : 10;
            target.affection += gain;
            
            let result = `ä½ èµ é€äº†${type === 'money' ? 'é“¶ä¸¤' : 'é¦–é¥°'}ç»™${target.name}ï¼Œå¥½æ„Ÿ+${gain}ã€‚`;
            
            if (target.affection >= 50 && !STATE.player.alliances.includes(target.id)) {
                STATE.player.alliances.push(target.id);
                result += `\n\nã€ç»“ç›ŸæˆåŠŸã€‘\n${target.name}æ„¿ä¸ä½ ç»“ä¸ºåŒç›Ÿï¼\nç›Ÿå‹å¯åœ¨å®«æ–—ä¸­æš—ä¸­ç›¸åŠ©ï¼Œä½ä»½è¶Šé«˜ï¼ŒåŠ©ç›Šè¶Šå¤§ã€‚`;
                updateFactionInfo();
            }

            document.getElementById('action-select-modal').style.display = 'none';
            
            // æ˜¾ç¤ºç»“æœå¼¹çª—
            document.getElementById('explore-title').innerText = "æ‹‰æ‹¢ç»“æœ";
            document.getElementById('explore-text').innerText = result;
            document.getElementById('explore-result-modal').style.display = 'block';
            
            addLog(result);
            advanceTime();
            updateProfileView();
        }

        function renderServantList(container) {
            container.innerHTML = '<div style="padding:20px; text-align:center; color:#666;">åŠŸèƒ½å¼€å‘ä¸­...</div>';
        }

        function handleFamilyAction() {
            const modal = document.getElementById('explore-result-modal');
            const title = document.getElementById('explore-title');
            const text = document.getElementById('explore-text');
            
            title.innerText = "å®¶æ—æ¥ä¿¡";
            
            const bgLevel = STATE.player.bgLevel || 10; 
            const isOfficial = STATE.player.bgType === 'official';
            
            let baseMoney = 220 - (bgLevel * 20);
            if (baseMoney < 0) baseMoney = 0;
            
            const rMoney = Math.random();
            const getMoney = rMoney < 0.05;
            
            let content = "å®¶ä¹¦ä¸­é“å°½äº†å¯¹ä½ çš„æ€å¿µä¸æ‹…å¿§ã€‚";
            
            if (getMoney && baseMoney > 0) {
                STATE.player.money += baseMoney;
                content += `\n\n(å®¶æ—é€æ¥é“¶ä¸¤ ${baseMoney} ä¸¤)`;
            }
            
            text.innerText = content;
            
            modal.style.display = 'block';
            advanceTime();
            updateProfileView();
        }

        function updateFactionInfo() {
            const div = document.getElementById('faction-info');
            let html = "";
            
            if (STATE.player.alliances.length === 0) {
                html += "æš‚æ— ç»“ç›Ÿï¼Œå­¤ç«‹æ— æ´ã€‚<br>";
            } else {
                const names = STATE.player.alliances.map(id => {
                    const c = STATE.concubines.find(x => x.id === id);
                    return c ? c.name : '';
                }).filter(n => n).join(', ');
                html += `<strong>ç›Ÿå‹ï¼š</strong>${names}<br>`;
            }

            if (STATE.player.enemies && STATE.player.enemies.length > 0) {
                const names = STATE.player.enemies.map(id => {
                    const c = STATE.concubines.find(x => x.id === id);
                    return c ? c.name : '';
                }).filter(n => n).join(', ');
                html += `<strong>æ­»æ•Œï¼š</strong><span style="color:red">${names}</span>`;
            }
            
            div.innerHTML = html;
        }

        function executeAlliance(type) {
            const target = STATE.concubines.find(c => c.id === selectedTargetId);

            if (type === 'break') {
                if (confirm(`ç¡®å®šè¦ä¸${target.name}è§£é™¤ç›Ÿçº¦å—ï¼Ÿæ­¤ä¸¾å°†å¯¼è‡´å¥½æ„Ÿå¤§å¹…ä¸‹é™å¹¶ç»“ä¸ºæ­»æ•Œï¼`)) {
                    STATE.player.alliances = STATE.player.alliances.filter(id => id !== target.id);
                    target.affection -= 80;
                    if (!STATE.player.enemies) STATE.player.enemies = [];
                    if (!STATE.player.enemies.includes(target.id)) {
                        STATE.player.enemies.push(target.id);
                    }
                    updateFactionInfo();
                    document.getElementById('action-select-modal').style.display = 'none';
                    showToast("å·²è§£é™¤ç›Ÿçº¦");
                    addLog(`ä¸${target.name}è§£é™¤ç›Ÿçº¦ï¼Œåç›®æˆä»‡ï¼Œå¯¹æ–¹è§†ä½ ä¸ºæ­»æ•Œã€‚`);
                    advanceTime();
                    updateProfileView();
                }
                return;
            }

            if (STATE.player.money < (type === 'money' ? 50 : 100)) {
                showToast("é“¶ä¸¤ä¸è¶³");
                return;
            }
            
            STATE.player.money -= (type === 'money' ? 50 : 100);
            
            if (!target.affection) target.affection = 0;
            const gain = type === 'money' ? 2 : 4; // è°ƒæ•´ä¸º2å’Œ4
            target.affection += gain;
            
            // ç»“ç›Ÿé—¨æ§›ï¼šä½ä»½è¶Šé«˜ï¼Œé—¨æ§›è¶Šé«˜
            let threshold = 50;
            if (target.rank <= 6) threshold = 80; // å¦ƒä½ä»¥ä¸Š
            else if (target.rank <= 18) threshold = 60; // å«”ä½ä»¥ä¸Š

            let result = `ä½ èµ é€äº†${type === 'money' ? 'é“¶ä¸¤' : 'é¦–é¥°'}ç»™${target.name}ï¼Œå¥½æ„Ÿ+${gain}ã€‚`;
            
            if (target.affection >= threshold && !STATE.player.alliances.includes(target.id)) {
                if (STATE.player.enemies && STATE.player.enemies.includes(target.id)) {
                     result += `\n\n${target.name}è™½ç„¶æ”¶ä¸‹äº†ç¤¼ç‰©ï¼Œä½†å¯¹ä½ çš„æ•Œæ„ä»æœªæ¶ˆé™¤ï¼Œæš‚ä¸æ„¿ç»“ç›Ÿã€‚`;
                } else {
                    STATE.player.alliances.push(target.id);
                    const bonus = Math.floor((30 - target.rank) * 0.5 + (target.scheme / 100));
                    result += `\n\nã€ç»“ç›ŸæˆåŠŸã€‘\n${target.name}è¢«ä½ çš„è¯šæ„æ‰“åŠ¨ï¼Œæ„¿ä¸ä½ ç»“ä¸ºåŒç›Ÿï¼\n\nã€ç›Ÿå‹åŠ©ç›Šã€‘\n1. å®«æ–—æˆåŠŸç‡åŠ æˆï¼š+${bonus}%\n2. è¢«é™·å®³æ—¶æœ‰æ¦‚ç‡å‡ºé¢æ±‚æƒ…\n3. å®´ä¼šæ—¶ä¸ºä½ åŠ©å¨\n4. æ¯æœˆéšæœºèµ é€ç‰©èµ„æˆ–æƒ…æŠ¥`;
                    updateFactionInfo();
                }
            } else if (!STATE.player.alliances.includes(target.id)) {
                result += `\n(å½“å‰å¥½æ„Ÿ ${target.affection}/${threshold}ï¼Œæœªè¾¾ç»“ç›Ÿè¦æ±‚)`;
            }

            document.getElementById('action-select-modal').style.display = 'none';
            
            document.getElementById('explore-title').innerText = "æ‹‰æ‹¢ç»“æœ";
            document.getElementById('explore-text').innerText = result;
            document.getElementById('explore-result-modal').style.display = 'block';
            
            addLog(result);
            advanceTime();
            updateProfileView();
        }

        function enemyAction() {
            if (!STATE.player.enemies || STATE.player.enemies.length === 0) return;
            
            STATE.player.enemies.forEach(id => {
                const enemy = STATE.concubines.find(c => c.id === id);
                if (!enemy || enemy.dead || enemy.state === 'å†·å®«') return;
                
                // 20%æ¦‚ç‡è¡ŒåŠ¨
                if (Math.random() < 0.2) {
                    const actionType = Math.random();
                    if (actionType < 0.5) {
                        // é€ è°£
                        const loss = 10 + Math.floor(Math.random() * 10);
                        STATE.player.favor = Math.max(0, STATE.player.favor - loss);
                        addLog(`æ­»æ•Œ${enemy.name}åœ¨å®«ä¸­æ•£å¸ƒä½ çš„è°£è¨€ï¼Œåœ£å® -${loss}ã€‚`);
                    } else {
                        // ç ´åè´¢ç‰©
                        const loss = 20 + Math.floor(Math.random() * 30);
                        STATE.player.money = Math.max(0, STATE.player.money - loss);
                        addLog(`æ­»æ•Œ${enemy.name}ä¹°é€šä¸‹äººç ´åäº†ä½ çš„é¦–é¥°ï¼ŒæŸå¤±é“¶ä¸¤${loss}ä¸¤ã€‚`);
                    }
                }
            });
        }

        function checkBanquet() {
            const m = STATE.time.month;
            const btn = document.getElementById('btn-banquet');
            const status = document.getElementById('banquet-status');
            if (!btn) return;
            
            if (m === 3 || m === 9) {
                btn.classList.remove('locked');
                status.innerText = "æ­£åœ¨ä¸¾åŠ (ç‚¹å‡»å‚åŠ )";
                status.style.color = "red";
            } else {
                btn.classList.add('locked');
                status.innerText = "æœªå¼€å¯ (3æœˆ/9æœˆ)";
                status.style.color = "#666";
            }
        }

        function openBanquet() {
            const m = STATE.time.month;
            if (m !== 3 && m !== 9) {
                showToast("å®´ä¼šä»…åœ¨3æœˆå’Œ9æœˆä¸¾åŠ");
                return;
            }
            
            if (STATE.time.period === 2 && STATE.time.timeSlot >= 6) {
                showToast("æœ¬æœˆè¡ŒåŠ¨ç‚¹å·²ç”¨å°½");
                return;
            }

            const modal = document.getElementById('action-select-modal');
            const title = document.getElementById('action-select-title');
            const list = document.getElementById('action-select-list');
            const optionsDiv = document.getElementById('action-options');
            const buttonsDiv = document.getElementById('action-buttons');
            
            title.innerText = "å®«å»·å®´ä¼š - é€‰æ‹©æ‰è‰º";
            list.innerHTML = `
                <div style="padding: 10px; text-align: center; color: #666;">
                    è¯·é€‰æ‹©ä¸€é¡¹æ‰è‰ºè¿›è¡Œè¡¨æ¼”ï¼Œå±æ€§è¶Šé«˜ï¼Œå¾—åˆ†è¶Šé«˜ã€‚<br>
                    ç›Ÿå‹ä¼šä¸ºä½ åŠ©å¨ï¼Œæ­»æ•Œä¼šè¯•å›¾ç ´åã€‚
                </div>
            `;
            
            optionsDiv.style.display = 'block';
            document.getElementById('action-options-title').innerText = "é€‰æ‹©è¡¨æ¼”é¡¹ç›®";
            buttonsDiv.innerHTML = '';
            
            const arts = [
                { name: 'æƒŠé¸¿èˆ', stat: 'charm', icon: 'ğŸ’ƒ' },
                { name: 'åŸè¯—ä½œå¯¹', stat: 'intelligence', icon: 'ğŸ“œ' },
                { name: 'æŠšç´ä¸€æ›²', stat: 'social', icon: 'ğŸµ' },
                { name: 'å±•ç¤ºåˆºç»£', stat: 'scheme', icon: 'ğŸª¡' }
            ];
            
            arts.forEach(art => {
                const val = STATE.player.stats[art.stat];
                createActionButton(buttonsDiv, `${art.icon} ${art.name} (${val})`, () => attendBanquet(art));
            });
            
            modal.style.display = 'flex';
        }

        function attendBanquet(art) {
            document.getElementById('action-select-modal').style.display = 'none';
            
            const baseScore = STATE.player.stats[art.stat];
            const rand = Math.floor(Math.random() * 50);
            
            let allyBonus = 0;
            let allyNames = [];
            STATE.player.alliances.forEach(id => {
                const ally = STATE.concubines.find(c => c.id === id);
                if (ally && !ally.dead && ally.state !== 'å†·å®«') {
                    const bonus = 20 + Math.floor(ally.rank / 2);
                    allyBonus += bonus;
                    allyNames.push(ally.name);
                }
            });
            
            let enemyPenalty = 0;
            let enemyNames = [];
            if (STATE.player.enemies) {
                STATE.player.enemies.forEach(id => {
                    const enemy = STATE.concubines.find(c => c.id === id);
                    if (enemy && !enemy.dead && enemy.state !== 'å†·å®«') {
                        const penalty = 15 + Math.floor(enemy.scheme / 20);
                        enemyPenalty += penalty;
                        enemyNames.push(enemy.name);
                    }
                });
            }
            
            const totalScore = baseScore + rand + allyBonus - enemyPenalty;
            
            let result = `ä½ åœ¨å®´ä¼šä¸Šè¡¨æ¼”äº†${art.name}ã€‚\nåŸºç¡€åˆ†ï¼š${baseScore} + ä¸´åœºå‘æŒ¥ï¼š${rand}`;
            
            if (allyBonus > 0) {
                result += `\nç›Ÿå‹åŠ©å¨ï¼š+${allyBonus} (${allyNames.join(',')})`;
            }
            if (enemyPenalty > 0) {
                result += `\næ­»æ•Œç ´åï¼š-${enemyPenalty} (${enemyNames.join(',')})`;
            }
            
            result += `\n\næ€»åˆ†ï¼š${totalScore}`;
            
            let reward = "";
            if (totalScore > 400) {
                reward = "æŠ€æƒŠå››åº§ï¼çš‡ä¸Šé¾™é¢œå¤§æ‚¦ï¼Œèµèµé»„é‡‘ç™¾ä¸¤ï¼Œåœ£å® +30ï¼";
                STATE.player.money += 100;
                STATE.player.favor += 30;
            } else if (totalScore > 200) {
                reward = "è¡¨ç°å°šå¯ï¼Œçš‡ä¸Šå¾®å¾®ç‚¹å¤´ï¼Œèµèµé“¶ä¸¤50ä¸¤ï¼Œåœ£å® +10ã€‚";
                STATE.player.money += 50;
                STATE.player.favor += 10;
            } else {
                reward = "è¡¨ç°å¹³å¹³ï¼Œæœªèƒ½å¼•èµ·çš‡ä¸Šæ³¨æ„ã€‚";
            }
            
            result += `\n\nã€ç»“æœã€‘${reward}`;
            
            document.getElementById('explore-title').innerText = "å®´ä¼šç»“æœ";
            document.getElementById('explore-text').innerText = result;
            document.getElementById('explore-result-modal').style.display = 'block';
            
            addLog(`å‚åŠ å®«å»·å®´ä¼šï¼Œè¡¨æ¼”${art.name}ï¼Œ${reward}`);
            advanceTime();
            updateProfileView();
        }

        function renderServantList(container) {
            container.innerHTML = '<div style="padding:20px; text-align:center; color:#666;">åŠŸèƒ½å¼€å‘ä¸­...</div>';
        }

        function handleFamilyAction() {
            const modal = document.getElementById('explore-result-modal');
            const title = document.getElementById('explore-title');
            const text = document.getElementById('explore-text');
            
            title.innerText = "å®¶æ—æ¥ä¿¡";
            
            const bgLevel = STATE.player.bgLevel || 10; 
            const isOfficial = STATE.player.bgType === 'official';
            
            let baseMoney = 220 - (bgLevel * 20);
            if (baseMoney < 0) baseMoney = 0;
            
            const rMoney = Math.random();
            const getMoney = rMoney < 0.05;
            
            let content = "å®¶ä¹¦ä¸­é“å°½äº†å¯¹ä½ çš„æ€å¿µä¸æ‹…å¿§ã€‚";
            
            if (getMoney && baseMoney > 0) {
                STATE.player.money += baseMoney;
                content += `\n\n(å®¶æ—é€æ¥é“¶ä¸¤ ${baseMoney} ä¸¤)`;
            }
            
            text.innerText = content;
            
            modal.style.display = 'block';
            advanceTime();
            updateProfileView();
        }

        function updateFactionInfo() {
            const div = document.getElementById('faction-info');
            if (STATE.player.alliances.length === 0) {
                div.innerText = "æš‚æ— ç»“ç›Ÿï¼Œå­¤ç«‹æ— æ´ã€‚";
            } else {
                const names = STATE.player.alliances.map(id => {
                    const c = STATE.concubines.find(x => x.id === id);
                    return c ? c.name : '';
                }).filter(n => n).join(', ');
                div.innerText = `ç›Ÿå‹ï¼š${names}`;
            }
        }

        // --- è®¾ç½®ä¸å­˜æ¡£ ---
        
        function loadSettings() {
            const saved = localStorage.getItem('palace_settings');
            if (saved) {
                STATE.settings = JSON.parse(saved);
                document.getElementById('api-url').value = STATE.settings.apiUrl;
                document.getElementById('api-key').value = STATE.settings.apiKey;
                
                const select = document.getElementById('model-select');
                if (STATE.settings.model && !Array.from(select.options).some(o => o.value === STATE.settings.model)) {
                    const opt = document.createElement('option');
                    opt.value = STATE.settings.model;
                    opt.text = STATE.settings.model;
                    select.add(opt);
                }
                select.value = STATE.settings.model;
            }
        }

        function saveSettings() {
            STATE.settings.apiUrl = document.getElementById('api-url').value;
            STATE.settings.apiKey = document.getElementById('api-key').value;
            STATE.settings.model = document.getElementById('model-select').value;
            
            localStorage.setItem('palace_settings', JSON.stringify(STATE.settings));
            showToast('é…ç½®å·²ä¿å­˜');
        }

        async function fetchModels() {
            const url = document.getElementById('api-url').value;
            const key = document.getElementById('api-key').value;
            
            if (!key) {
                showToast('è¯·å¡«å†™API Key');
                return;
            }

            const btn = event.target;
            const originalText = btn.innerText;
            btn.innerText = 'è¿æ¥ä¸­...';
            btn.disabled = true;

            try {
                const response = await fetch(url + '/models', {
                    headers: {
                        'Authorization': `Bearer ${key}`
                    }
                });
                
                if (!response.ok) throw new Error(response.statusText);
                
                const data = await response.json();
                const select = document.getElementById('model-select');
                select.innerHTML = '';
                
                data.data.forEach(model => {
                    const opt = document.createElement('option');
                    opt.value = model.id;
                    opt.text = model.id;
                    select.add(opt);
                });
                
                showToast('æ¨¡å‹åˆ—è¡¨è·å–æˆåŠŸ');
            } catch (e) {
                showToast('è¿æ¥å¤±è´¥: ' + e.message);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        function toggleSaveMode(mode) {
            STATE.saveMode = mode;
            document.getElementById('mode-save').style.backgroundColor = mode === 'save' ? 'var(--primary-color)' : 'var(--secondary-color)';
            document.getElementById('mode-save').style.color = mode === 'save' ? '#fff' : '#ccc';
            
            document.getElementById('mode-load').style.backgroundColor = mode === 'load' ? 'var(--primary-color)' : 'var(--secondary-color)';
            document.getElementById('mode-load').style.color = mode === 'load' ? '#fff' : '#ccc';
            
            renderSaveSlots();
        }

        function renderSaveSlots() {
            const container = document.getElementById('save-slots-container');
            container.innerHTML = '';
            
            for (let i = 1; i <= 6; i++) {
                const slotKey = `palace_save_${i}`;
                const savedData = localStorage.getItem(slotKey);
                let info = 'ç©ºå­˜æ¡£';
                let isUsed = false;

                if (savedData) {
                    try {
                        const data = JSON.parse(savedData);
                        const date = new Date(data.timestamp).toLocaleString();
                        const rankName = RANKS[data.player.rank] ? RANKS[data.player.rank].name : 'æœªçŸ¥';
                        info = `${data.player.name} - ${rankName}<br>${date}`;
                        isUsed = true;
                    } catch (e) {
                        info = 'å­˜æ¡£æŸå';
                    }
                }

                const div = document.createElement('div');
                div.className = `slot-btn ${isUsed ? 'used' : ''}`;
                div.innerHTML = `
                    <div>å­˜æ¡£ ${i}</div>
                    <div class="slot-info">${info}</div>
                `;
                div.onclick = () => handleSlotClick(i, isUsed);
                container.appendChild(div);
            }
        }

        function handleSlotClick(index, isUsed) {
            const slotKey = `palace_save_${index}`;
            
            if (STATE.saveMode === 'save') {
                if (isUsed && !confirm('è¯¥å­˜æ¡£ä½å·²æœ‰æ•°æ®ï¼Œç¡®å®šè¦†ç›–å—ï¼Ÿ')) return;
                
                const saveData = {
                    version: 5, // æ›´æ–°ç‰ˆæœ¬å·
                    timestamp: Date.now(),
                    player: STATE.player,
                    time: STATE.time,
                    emperor: STATE.emperor,
                    concubines: STATE.concubines,
                    shiqin: STATE.shiqin,
                    investigation: STATE.investigation,
                    lastMonthExpense: STATE.lastMonthExpense
                };
                localStorage.setItem(slotKey, JSON.stringify(saveData));
                showToast(`è¿›åº¦å·²ä¿å­˜è‡³å­˜æ¡£ ${index}`);
                renderSaveSlots();
            } else {
                if (!isUsed) {
                    showToast('æ­¤å¤„æ— å­˜æ¡£');
                    return;
                }
                
                if (!confirm('ç¡®å®šè¯»å–è¯¥å­˜æ¡£å—ï¼Ÿå½“å‰æœªä¿å­˜çš„è¿›åº¦å°†ä¸¢å¤±ã€‚')) return;
                
                try {
                    const data = JSON.parse(localStorage.getItem(slotKey));
                    
                    // æ¢å¤æ•°æ®
                    if (data.player) STATE.player = data.player;
                    if (data.time) STATE.time = data.time;
                    if (data.emperor) STATE.emperor = data.emperor;
                    if (data.concubines) STATE.concubines = data.concubines;
                    if (data.shiqin) STATE.shiqin = data.shiqin;
                    if (data.investigation) STATE.investigation = data.investigation;
                    if (data.lastMonthExpense !== undefined) STATE.lastMonthExpense = data.lastMonthExpense;
                    
                    if (typeof STATE.player.rank === 'undefined') {
                        STATE.player.rank = 29; // é»˜è®¤ä¸ºå®˜å¥³å­
                    }
                    if (!STATE.player.stats.scheme) STATE.player.stats.scheme = 0;
                    if (!STATE.player.stats.luck) STATE.player.stats.luck = 0;
                    
                    drawAvatar('avatar-canvas', STATE.player.avatarSeed);
                    
                    showToast('è¯»å–æˆåŠŸ');
                    switchPage('map'); // è¿™ä¼šè§¦å‘ updateTimeUI
                } catch (e) {
                    showToast('è¯»å–å¤±è´¥ï¼šå­˜æ¡£å¯èƒ½å·²æŸå');
                    console.error(e);
                }
            }
        }

        function resetGame() {
            if (confirm('ç¡®å®šè¦é‡ç½®æ¸¸æˆå—ï¼Ÿæ‰€æœ‰å­˜æ¡£å°†ä¿ç•™ï¼Œä½†å½“å‰è¿›åº¦ä¼šä¸¢å¤±ã€‚')) {
                location.reload();
            }
        }

    </script>
</body>
</html>
